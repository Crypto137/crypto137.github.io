<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="https://crypto137.github.io/MHServerEmu/feed.xml" rel="self" type="application/atom+xml" /><link href="https://crypto137.github.io/MHServerEmu/" rel="alternate" type="text/html" /><updated>2025-03-31T05:17:25+03:00</updated><id>https://crypto137.github.io/MHServerEmu/feed.xml</id><title type="html">MHServerEmu Blog</title><subtitle>A volunteer-driven research project aimed at reverse engineering the technology developed by Gazillion Entertainment.</subtitle><entry><title type="html">MHServerEmu Progress Report: March 2025</title><link href="https://crypto137.github.io/MHServerEmu/blog/2025/03/31/progress-report-march-2025.html" rel="alternate" type="text/html" title="MHServerEmu Progress Report: March 2025" /><published>2025-03-31T05:15:00+03:00</published><updated>2025-03-31T05:15:00+03:00</updated><id>https://crypto137.github.io/MHServerEmu/blog/2025/03/31/progress-report-march-2025</id><content type="html" xml:base="https://crypto137.github.io/MHServerEmu/blog/2025/03/31/progress-report-march-2025.html"><![CDATA[<p><img src="/MHServerEmu/assets/blog/progress-report/2025-03/header.jpg" alt="MHServerEmu Progress Report - March 2025" /></p>

<p>It’s a bird! It’s a plane! It’s an MHServerEmu Progress Report!</p>

<h2 id="060-and-beyond">0.6.0 and Beyond</h2>

<p>We have been doing quarterly stable releases for a whole year now, and this month we released version 0.5.0. As soon as it was out, we began working on the next one, 0.6.0, which is now available via nightly builds.</p>

<p>There are two major features planned for 0.6.0: the implementation of the long awaited power customization via talents, and a fundamental overhaul of our server architecture that is going to allow us to bring some of the “MMOness” back into the game. After doing an informal poll on our Discord server, we decided to prioritize additional work on powers, as it was what the majority of people wanted to see.</p>

<p>We will share more details on the architecture overhaul in future reports, but the short version of it is that the current architecture was designed as temporary scaffolding to allow us to work on the gameplay side of things as soon as possible. The vast majority of gameplay code is going to remain the same, but everything around it, such as game instance management, chat functionality, and other social-oriented features, will be undergoing major changes. It is not going to make much of a difference for people playing on locally hosted servers, but it will be crucial for public servers that intend to replicate the game’s original, more social, experience.</p>

<h2 id="talents">Talents</h2>

<p>Although many players seem to associate talents with the Biggest Update Ever (BUE), it is actually a much older system. First introduced as <em>specialization powers</em> in version 1.35, this system has been in Marvel Heroes since the release of Doctor Doom as a playable hero on the game’s second anniversary in 2015. We happen to have a highly experimental server implementation for this exact version of the game, which we can use to show what the UI for this feature looked like back then:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2025-03/specialization-powers.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2025-03/specialization-powers.jpg" alt="Specialization Powers" /></a></p>

<p>The underlying code that runs this system remained mostly the same, and in some cases talents are still referred to as specialization powers (e.g. <code class="language-plaintext highlighter-rouge">SpecializationPowerPrototype</code>). While it is good for pre-BUE support later down the line, it also meant more work needed to be done on the backend of the power system now.</p>

<p>This is a good opportunity to talk about the <em>power progression</em> system and what was the actual extent of changes brought by BUE. You may have noticed that it was possible to use travel and ultimate powers from level 1, even though they are supposed to unlock at higher levels. Team-ups were also using powers that were supposed to be locked for them. The reason for this is that we did not have a proper implementation of the power progression system and simply assigned all powers to avatars and team-ups. The only thing preventing you from using everything from level 1 was client-side validation, and team-ups did not have this “problem”.</p>

<p>There was a reason why we did not work on power progression until we had to do it. Even though BUE seemingly got rid of power ranks, the entire backend is still very much rank-driven and does all the necessary calculations, taking into account various modifiers to power ranks, only to arrive at rank 0 or 1 for everything but ultimate powers. What BUE actually did was set the starting rank of all powers to 1, remove point assignment and rank-modifying affixes from gear, and rescale everything accordingly. For us implementing power progression was a not insignificant amount of work, most of which is going to be pretty much invisible until we support pre-BUE versions of the game. However, since talents are just specialization powers with a new coat of paint, they relied on this underlying system, so it needed to be done.</p>

<p>As a result of implementing power progression, travel and ultimate powers now become usable when they are supposed to, and team-ups unlock powers gradually as they level up. However, this is not the full extent of these changes: it is now also possible to upgrade your ultimate power’s rank using character tokens, and team-up procs that can activate when the team-up is away are now properly assigned to avatars.</p>

<p>Another vital piece of the talent puzzle is <em>mapped powers</em>. This is not a new system either: it was introduced at least as far back as September 2014 when Rogue was released as a playable hero in version 1.26, and it is the foundation of her power stealing mechanic. Mapping a power means replacing it with another one, while also keeping the original power’s rank. The system itself is not very complicated, but it required doing an overhaul of our <em>ability key mapping</em> implementation, which was more in-depth. Ability key mapping is what the game calls action bars, and each “ability” can be either a power or an item. This system was built with various other features in mind, including having multiple switchable bars (unused in BUE), power specs, and tranform mode powers that replace all of your buttons. All of them had to be accounted for.</p>

<p>Speaking of transform mode powers, there are only two of them in version 1.52 (Rocket Raccoon’s Mechfall and Rogue’s Final Form), and both of them now work thanks to these backend improvements.</p>

<p>There is also one thing I would like to note regarding ability key mappings in version 1.52, because we have received numerous bug reports about this. When you level up, the client automatically slots powers into free slots, even if they were not unlocked by reaching that specific level. This means powers will always be reslotted into their designated slots on level up, as long as these slots are not occupied by other powers. Although this is arguably not intuitive behavior, it is done by the client on its own, so to avoid desyncs we have to do the same server-side.</p>

<p>With power progression and mapped powers implemented, talents were pretty much ready to go. The rest of the functionality, like changing how a power behaves, is done using the same proc and condition based “scripting” system we discussed in previous reports, so it pretty much just worked all of a sudden. Now the power system is almost feature complete, with only a few minor things still missing, like shared health pools used by one of the boss encounters in the Muspelheim raid. We will take care of these smaller features at some point before 1.0, but for now we will be moving on to other, higher priority features.</p>

<h2 id="prestige">Prestige</h2>

<p>Talents ended up being implemented faster than expected, which gave me some time to work on minor features that were originally scheduled for 0.7.0: Hero Synergies and Prestige. Synergies are not very interesting to talk about, since they are simply stat bonuses, but with Prestige there are some curious aspects to discuss.</p>

<p>Prestiging a hero is more involved than just resetting their level. You also need to:</p>

<ul>
  <li>
    <p>Validate the prestige consumable item interaction.</p>
  </li>
  <li>
    <p>Do a full respec, including unassigning mapped powers and talents.</p>
  </li>
  <li>
    <p>Check restrictions of all equipped items and unequip them, handling potentially running out of space in the general inventory.</p>
  </li>
  <li>
    <p>Reset the progress of missions that save their state per avatar.</p>
  </li>
  <li>
    <p>Grant prestige loot (more on that later).</p>
  </li>
  <li>
    <p>Recalculate the number of avatars at the new prestige level to update achievements.</p>
  </li>
  <li>
    <p>Do a teleport to the starting region.</p>
  </li>
</ul>

<p>As you can see, there are many different systems interacting to make this single thing happen. Because all of this occurs at the same time, there were some timing-related issues to solve, particularly related to modifying the inventory at the same time as teleporting, which triggers a save.</p>

<p>While many people remember one of the main Prestige rewards being additional copies of the starting costume, this was actually changed in BUE. Here is how Asros, one of the developers working at Gazillion at the time, explained why this change was made on the game’s <a href="https://web.archive.org/web/20170109140148/http://forums.marvelheroes.com/discussion/comment/3999141#Comment_3999141">official forums</a>:</p>

<blockquote>
  <p>[…]</p>

  <p>Costumes and costume revenue is a very important part of our business. We understand that there are many free to play players out there who will be disappointed in this decision. We feel very strongly that going forward, purely cosmetic things like costumes, for the most part(achievements/log in gifts as exceptions), should be cash shop items. Sometimes we have to make unpopular decisions for the betterment of the long term health of the game and the company. The reason for the free defaults was to make prestiging easier for players who had high level costume cores attached. Now with the changes to catalyst system, that is no longer a necessity.</p>

  <p>[…]</p>
</blockquote>

<p>Gazillion ended up replacing the starting costume with the bonus item find (BIF) loot table (<code class="language-plaintext highlighter-rouge">Loot/Tables/BonusItemFind/BonusItemFindTable.prototype</code>), which is the table also used by S.H.I.E.L.D. Supply Drops. The bad news is that it did not end up being good for the “long term health of the game”. The good news is we do not have financial obligations, so I have added a new setting called <code class="language-plaintext highlighter-rouge">GrantStartingCostumeForPrestige</code> that returns the original reward. Once crafting is working, this will be very useful for all of your costume blending needs.</p>

<p>Now that we have Prestige working, there have been some requests from the community to be able to continue leveling up past Prestige level 6 (Cosmic), which is the cap in version 1.52. Gazillion was actually working on extending the Prestige system with something called the Omega Prestige:</p>

<style>.embed-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; } .embed-container iframe, .embed-container object, .embed-container embed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }</style>
<div class="embed-container">    <iframe title="YouTube video player" width="640" height="390" src="//www.youtube.com/embed/r5LQfV8VQ3Y" frameborder="0" allowfullscreen=""></iframe></div>

<p>Omega Prestige was available in the console versions of the game for some heroes, and the code for it exists in PC test center builds of version 1.53. None of it is available in 1.52, but we have come up with an alternative.</p>

<p>Ultimate Prestige (named by popular vote on our Discord server) is going to be a custom system that will allow you to reset your Prestige level back to 0 (White). We even came up with a way to display your Prestige reset count in the client’s UI:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2025-03/ultimate-prestige.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2025-03/ultimate-prestige.jpg" alt="Ultimate Prestige" /></a></p>

<p>Ultimate Prestige will be effectively uncapped, allowing you to level up your favorite hero over and over for as long as you desire. This system is going to be completely optional: server owners will be able to completely disable it in server settings, and we also plan to make the Prestige reset count hideable, in case you do not want everybody around you to know just how much fun you are having with your Squirrel Girl.</p>

<h2 id="prototype-patcher">Prototype Patcher</h2>

<p><em>AlexBond is back again to talk about his latest endeavor - patching the game’s data files server-side.</em></p>

<hr />

<p>Hello everyone, this is AlexBond.</p>

<p>After the recent large power update we discovered more bugs that existed in the original game, which we usually call <em>Gazillion issues</em>. One example of such issue is related to Emma Frost’s controlled minions. As it turns out, when Gazillion reworked mobs as part of their story overhaul, they forgot to flag the new mob alliances as hostile for controlled entities, which means entities controlled by Emma, Vision, Magik, and Rogue are not going to attack enemies belonging to these alliances. These enemies are encountered in the first chapter of the story, so it is not as noticable as it could have been.</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2025-03/patcher-1.png"><img src="/MHServerEmu/assets/blog/progress-report/2025-03/patcher-1.png" alt="Prototype Patcher 1" /></a>
</center>

<p>New alliances:</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2025-03/patcher-2.png"><img src="/MHServerEmu/assets/blog/progress-report/2025-03/patcher-2.png" alt="Prototype Patcher 2" /></a>
</center>

<p>To fix issues such as these I came up with an idea to implement a system called <em>Prototype Patch Manager</em>, which can be used to change prototype data when it is being loaded on the server. This allows us to fix numerous bugs without having to rely on hardcoded fixes.</p>

<p>All patches are stored in JSON files in the following subdirectory: <code class="language-plaintext highlighter-rouge">Data\Game\Patches</code>.</p>

<p>For example, the patch to fix the issue with Emma Frost looks like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Prototype"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Entity/Alliances/Overrides/Controlled.prototype"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HostileTo[]"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Add [GangBiker, GangShocker, GangHellbane, GangElectro, EnemyToEveryone] to Controlled Keywords"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ValueType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PrototypeId[]"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Value"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">3046566727234031236</span><span class="p">,</span><span class="w"> </span><span class="mi">11722709847486435174</span><span class="p">,</span><span class="w"> </span><span class="mi">1849637429396115378</span><span class="p">,</span><span class="w"> </span><span class="mi">3414168095237017445</span><span class="p">,</span><span class="w"> </span><span class="mi">4627307232939675976</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Prototype</code> is the file path of the prototype we want to modify.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Path</code> is the internal path inside the prototype that points to the required value or array (arrays are specified using <code class="language-plaintext highlighter-rouge">[]</code>).</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ValueType</code> is the type of the value we are going to change. For prototype references this is going to be <code class="language-plaintext highlighter-rouge">PrototypeId</code>, but for embedded prototype instances you need to use  <code class="language-plaintext highlighter-rouge">PrototypeDataRef</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Value</code> is a general purpose field that can contain various types, like numerical values, strings, or JSON objects.</p>
  </li>
</ul>

<p>Thanks to these patches, we can fix bugs that existed in the original game, bring back events that require loot table modifications, and much more.</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2025-03/patcher-3.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2025-03/patcher-3.jpg" alt="Prototype Patcher 3" /></a>
</center>

<p>We can also add back entities that were removed from the game by repurposing unused markers. For instance, these patches add Cloak and Dagger to the Avengers Tower:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Prototype"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Resource/Cells/DistrictCells/Avengers_Tower/AvengersTowerNPE_HUB.cell"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MarkerSet.Markers[27].EntityGuid"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Add Dagger"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ValueType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PrototypeGuid"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Value"</span><span class="p">:</span><span class="w"> </span><span class="mi">6158563480682235387</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"Enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Prototype"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Resource/Cells/DistrictCells/Avengers_Tower/AvengersTowerNPE_HUB.cell"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MarkerSet.Markers[27].Position"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Change Dagger position"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ValueType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Vector3"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Value"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">-694.76</span><span class="p">,</span><span class="w"> </span><span class="mf">2003.63</span><span class="p">,</span><span class="w"> </span><span class="mf">160.97</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"Enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Prototype"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Resource/Cells/DistrictCells/Avengers_Tower/AvengersTowerNPE_HUB.cell"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MarkerSet.Markers[28].EntityGuid"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Add Cloak"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ValueType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PrototypeGuid"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Value"</span><span class="p">:</span><span class="w"> </span><span class="mi">13282508175937904349</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Meet the new guests!</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2025-03/patcher-4.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2025-03/patcher-4.jpg" alt="Prototype Patcher 4" /></a>
</center>

<p>In addition to modifying the values of existing fields, there is also a more complex system that can be used to add new embedded prototypes. For example, we can create a loot table that would drop Carnival Beads by repurposing the unused <code class="language-plaintext highlighter-rouge">TestItemsLootTable</code>:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Prototype"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Loot/Tables/Test/TestItemsLootTable.prototype"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Choices[0].Choices[]"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Add [MGBeads, MGBeads2] as LootDropItemPrototype"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ValueType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Prototype[]"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Value"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"ParentDataRef"</span><span class="p">:</span><span class="w"> </span><span class="mi">1071992662862269383</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Item"</span><span class="p">:</span><span class="w"> </span><span class="mi">7800473051294539167</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Weight"</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"ParentDataRef"</span><span class="p">:</span><span class="w"> </span><span class="mi">1071992662862269383</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Item"</span><span class="p">:</span><span class="w"> </span><span class="mi">10014849647161122257</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Weight"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>To add a new <code class="language-plaintext highlighter-rouge">Prototype</code> you need to specify its <code class="language-plaintext highlighter-rouge">ParentDataRef</code>, usually it is a <code class="language-plaintext highlighter-rouge">*.defaults</code> prototype:</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2025-03/patcher-5.png"><img src="/MHServerEmu/assets/blog/progress-report/2025-03/patcher-5.png" alt="Prototype Patcher 5" /></a>
</center>

<p><code class="language-plaintext highlighter-rouge">ParentDataRef</code> is followed by fields inside this class (<code class="language-plaintext highlighter-rouge">Item</code>, <code class="language-plaintext highlighter-rouge">Weight</code>) that we override from defaults. In order for the <code class="language-plaintext highlighter-rouge">TestItemsLootTable</code> to work and bosses to drop what we want, we need to add this table’s id (<code class="language-plaintext highlighter-rouge">14120665269944980064</code>) to the global <code class="language-plaintext highlighter-rouge">SpecialEventsTable</code>:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Prototype"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Loot/Tables/Mob/Bosses/SpecialEventsTable.prototype"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Choices[]"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Add TestItemsLootTable for CarnivalEvent"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ValueType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PrototypeDataRef"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Value"</span><span class="p">:</span><span class="w"> </span><span class="mi">14120665269944980064</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Now we can defeat Black Cat and get our Carnival Beads:</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2025-03/patcher-6.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2025-03/patcher-6.jpg" alt="Prototype Patcher 6" /></a>
</center>

<p>I have made patches for multiple such events, Mardi Gras is just an example for people who want to try doing it themselves.</p>

<p>It is also possible to modify missions like this in a limited fashion, including bringing some of them back. When making changes to mission prototypes, here is what is important to keep in mind:</p>

<ul>
  <li>
    <p>The client is going to complain and not refresh objectives if the mission was disabled. However, the mission will work and you will be able to get rewards.</p>
  </li>
  <li>
    <p>You cannot modify elements related to visibility and interaction. They have to be in sync between the client and the server.</p>
  </li>
  <li>
    <p>If data is used only by the server, it is safe to modify.</p>
  </li>
</ul>

<p>Hopefuly somebody will use these tools to bring back something that was disabled (intentionally or by mistake).</p>

<p>And with that it is time to say goodbye for now. Good luck leveling up <del>NoLifer</del> Ultimate Prestige!</p>

<hr />

<p>This is it for this progress report. See you all next time!</p>]]></content><author><name></name></author><category term="blog" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">MHServerEmu Progress Report: February 2025</title><link href="https://crypto137.github.io/MHServerEmu/blog/2025/03/04/progress-report-february-2025.html" rel="alternate" type="text/html" title="MHServerEmu Progress Report: February 2025" /><published>2025-03-04T20:45:00+03:00</published><updated>2025-03-04T20:45:00+03:00</updated><id>https://crypto137.github.io/MHServerEmu/blog/2025/03/04/progress-report-february-2025</id><content type="html" xml:base="https://crypto137.github.io/MHServerEmu/blog/2025/03/04/progress-report-february-2025.html"><![CDATA[<!--more-->

<p><img src="/MHServerEmu/assets/blog/progress-report/2025-02/header.jpg" alt="MHServerEmu Progress Report - February 2025" /></p>

<p>Another month, another MHServerEmu Progress Report.</p>

<h2 id="050-status">0.5.0 Status</h2>

<p>As I am writing this, we are finalizing the work on our next quarterly stable release, version 0.5.0. As a result of player feedback and testing it ourselves, we have shuffled features around, with some getting pushed forward (e.g. Infinity / Omega), and others being delayed (e.g. leaderboards). Overall I feel we ended up with a very substantial package of changes, focused mostly on getting powers and the overall combat into a more refined state.</p>

<p>All the major features that will be coming in 0.5.0 are now done, and we are currently working on some additional polish and bug fixes. The current plan is to have it all ready at some point next week.</p>

<h2 id="difficulty-scaling">Difficulty Scaling</h2>

<p>One hot topic that came up after the major batch of power changes in February was the issue of difficulty scaling, particularly at level 60 in group-oriented content, such as Midtown Patrol. I would like to use this opportunity to talk more about what is happening behind the scenes with it.</p>

<p>First of all, <em>there was no difficulty scaling prior to these changes</em>. Green, Red, and Cosmic difficulty tiers were all using the same baseline values, which in most cases correspond to the Green difficulty. The only thing that was affected by difficulty tier selection before these changes was loot, so you were effectively getting Cosmic levels of loot for doing Green content. This was semi-balanced by the fact that many sources of damage and survivability were not working, but overall it was still heavily skewed towards being too easy. As procs and over time tickers were implemented, it became clear that leaving combat calculations as is would result in this situation becoming even more lopsided, so it was time to finally rip the bandaid off.</p>

<p>Get your tinfoil hats ready, because we are about to expose a bit of a conspiracy. Have you ever wondered why you never see the exact health values of the enemies you fight in Marvel Heroes? There is a very good reason for this: all damage numbers you see are actually <em>fake</em>. When the game needs to make an enemy twice as tanky, it does not increase its health or defenses. Instead, <em>the player’s damage gets cut in half</em>, and the damage numbers that are sent to the client are manipulated to hide this multiplier. This applies only to player -&gt; mob damage, when enemies attack players or player-controlled entities you get more or less real damage with only the level scaling applied.</p>

<p>The key thing here is where these multipliers are coming from. This is handled by a class called <code class="language-plaintext highlighter-rouge">TuningTable</code>, and each region has its own instance of it. The difficulty damage multiplier is calculated by the region’s <code class="language-plaintext highlighter-rouge">TuningTable</code> instance each time damage is applied to a target based on the following factors:</p>

<ul>
  <li>
    <p>Whether the source of the damage is a player-owned entity (avatar, summon, team-up, etc.) or not.</p>
  </li>
  <li>
    <p>The rank of the target (popcorn, boss, etc.).</p>
  </li>
  <li>
    <p>The difficulty tier of the current region (Green / Red / Cosmic).</p>
  </li>
  <li>
    <p>The difficulty index of the current region. This is used in modes such as Holo-Sim and X-Defense to gradually escalate the difficulty.</p>
  </li>
  <li>
    <p>The number of nearby players. The exact radius of “nearby” differs depending on the region. In general, for private instances it is set to 100000 units, which covers pretty much the entire region, while in public combat zones it is set to 1200 units, which is roughly about the size of a screen.</p>
  </li>
  <li>
    <p>Whether the region is a public combat zone (PCZ) or not.</p>
  </li>
</ul>

<p>One important point to note here is how this is balanced in practice in group-oriented public combat zones, such as Midtown Patrol. The curves used in them start aggressive, but have heavy diminishing returns, which means that bosses will feel very tanky when fighting them solo, but as more players join the fight, their damage will relatively quickly outscale the fake “boss health” gains (which are actually player damage penalties).</p>

<p>I have tested everything extensively, which included manually calculating the multipliers for various situations, and I can say with a high degree of confidence that the system appears to be working consistent with the game data. However, there have been some very vocal feedback from some testers that the game is now “unplayable”. To address this feedback, we have rearranged the features on our roadmap to get some of the additional sources of player power working sooner.</p>

<h2 id="infinity-and-omega">Infinity and Omega</h2>

<p>After evaluating the cost-benefit ratio of various missing sources of player power, with cost being the time it would take to implement them, and benefit being the increase in power they provide, I decided it made the most sense to push forward the two alternate advancement systems, Infinity and Omega. The main reason for this is because they rely mostly on the backend functionality we already have implemented, such as entity modifiers that are used for features like enemy ranks, which meant it took only a few days of work to get them up and running. At the same time, they are a major source of player power, although not quite as “infinite” as one of them implies.</p>

<p>“But wasn’t Omega removed in BUE?” — some of you may ask. Well, yes and no: when the client connects to the server, it receives a <code class="language-plaintext highlighter-rouge">NetMessageLocalPlayer</code> that contains a  <code class="language-plaintext highlighter-rouge">NetStructGameOptions</code> that looks like this:</p>

<div class="language-protobuf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">NetStructGameOptions</span> <span class="p">{</span>
    <span class="k">required</span> <span class="kt">bool</span>    <span class="na">teamUpSystemEnabled</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">bool</span>    <span class="na">achievementsEnabled</span>    <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">bool</span>    <span class="na">omegaMissionsEnabled</span>    <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">bool</span>    <span class="na">veteranRewardsEnabled</span>    <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">bool</span>    <span class="na">multiSpecRewardsEnabled</span>    <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">bool</span>    <span class="na">giftingEnabled</span>    <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">bool</span>    <span class="na">characterSelectV2Enabled</span>    <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">bool</span>    <span class="na">communityNewsV2Enabled</span>    <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">bool</span>    <span class="na">leaderboardsEnabled</span>    <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">bool</span>    <span class="na">newPlayerExperienceEnabled</span>    <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">int32</span>    <span class="na">serverTimeOffsetUTC</span>    <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">bool</span>    <span class="na">useServerTimeOffset</span>    <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">bool</span>    <span class="na">missionTrackerV2Enabled</span>    <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">int32</span>    <span class="na">giftingAccountAgeInDaysRequired</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">int32</span>    <span class="na">giftingAvatarLevelRequired</span>    <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">int32</span>    <span class="na">giftingLoginCountRequired</span>    <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">bool</span>    <span class="na">infinitySystemEnabled</span>    <span class="o">=</span> <span class="mi">19</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">int32</span>    <span class="na">chatBanVoteAccountAgeInDaysRequired</span>    <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">int32</span>    <span class="na">chatBanVoteAvatarLevelRequired</span>    <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">int32</span>    <span class="na">chatBanVoteLoginCountRequired</span>    <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">bool</span>    <span class="na">isDifficultySliderEnabled</span>    <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>
    <span class="k">optional</span> <span class="kt">bool</span>    <span class="na">orbisTrophiesEnabled</span>    <span class="o">=</span> <span class="mi">24</span> <span class="p">[</span><span class="k">default</span> <span class="o">=</span> <span class="kc">false</span><span class="p">];</span>
    <span class="k">required</span> <span class="kt">int32</span>    <span class="na">platformType</span>    <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">NetMessageLocalPlayer</span> <span class="p">{</span>
    <span class="k">required</span> <span class="kt">uint64</span>    <span class="na">localPlayerEntityId</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">required</span> <span class="n">NetStructGameOptions</span>    <span class="na">gameOptions</span>    <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>One of the fields here is called <code class="language-plaintext highlighter-rouge">infinitySystemEnabled</code>. When it is set to <code class="language-plaintext highlighter-rouge">false</code>, not only does it disable the Infinity system, but it also reenables Omega in the state it was left in as of version 1.52. While this is some neat trivia, why bother implementing it right now? The reason is very simple: the vast majority of code for Infinity is literally copypasted Omega code with the word “Omega” replaced with “Infinity”, and I am not exaggerating this. The biggest difference between them is how points are calculated: Infinity uses a “squished” experience curve in which 10 Omega points are equivalent to 1 Infinity point, and each Infinity point you receive is colored to match various Infinity Stones. Another semi-major difference is the unlock requirement: Infinity is unlocked at level 60 account-wide, while Omega is unlocked per-hero at level 30. Everything else is pretty much the exact same thing code-wise, all the way to checking various prerequisite nodes (that are simply left blank in Infinity). So, by implementing one of them, it was very easy to get the other one working as well.</p>

<p>While we are at it, here is another fun fact: despite being called “Infinity”, it is not actually infinite. The system is capped at 6 000 000 points, of which only 80 400 are actually spendable. This is still a heavy grind, especially when compared to Omega, which had a cap of 10 000 (equivalent to 1 000 when using the Infinity curve), but I would not be surprised to see people reach it years down the line after 1.0 is out and there are no more wipes.</p>

<p>As for Omega, the exact state of its balance in the context of BUE remains to be evaluated. One idea that has been floating around is “uncapping” to match Infinity, but it needs to be extensively tested to make sure nothing breaks. In any case, even if it does not find extensive use in 1.52, this is still going to be useful for when get to backporting the server to version 1.48 (aka “pre-BUE”).</p>

<p>With these two systems working (Infinity in particular), there is now both an additional long term grind to work on, and a way to brute force past the remaining unimplemented systems, such as talents, which require more time and effort to implement.</p>

<h2 id="summons">Summons</h2>

<p><em>AlexBond is back for this month’s report to talk about his work on summon powers, hotspots, and controlled agents.</em></p>

<hr />

<p>Hello everyone, this is AlexBond. In this report we are going to talk about summons.</p>

<p>Summons are allies created by powers that help you in combat. If you ask a Marvel Heroes player to give an example of a summoner hero you will probably hear Squirrel Girl, Magik, or Doctor Doom; nobody is going to say Cyclops, Deadpool, or Nova. However, almost all heroes in the game are summoners. Why is that? Allow me to explain.</p>

<p>Each power is a chain of different actions. When you play as Cyclops and activate the Optic Beam power (internally referred to as <code class="language-plaintext highlighter-rouge">ChanneledBeam</code>), a hotspot called <code class="language-plaintext highlighter-rouge">CyclopsChanneledEnergyBeamArea</code> is summoned. This hotspot has a triangle shape with a 10 degree angle and a length of 700 units. It is attached to Cyclops, and when you move the mouse cursor, he rotates towards it, and the attached hotspot follows. When the hotspot overlaps with other entities, it applies powers defined in the <code class="language-plaintext highlighter-rouge">AppliesPowers</code> field of its prototype: in this example in particular it applies <code class="language-plaintext highlighter-rouge">ChanneledEnergyBeamEffect</code>, which is the damage component, and <code class="language-plaintext highlighter-rouge">ChanneledEnergyBeamSlowEffect</code>, which is an additional status effect.</p>

<p>Three systems needed to be implemented for all of this to work correctly: <em>summon powers</em>, <em>hotspots</em>, and <em>attached entities</em>.</p>

<h3 id="summon-powers">Summon Powers</h3>

<p>Each power prototype contains many different parameters, but the main one we are interested in is <code class="language-plaintext highlighter-rouge">SummonEntityContexts</code>:</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2025-02/summons-1.png"><img src="/MHServerEmu/assets/blog/progress-report/2025-02/summons-1.png" alt="Summons 1" /></a>
</center>

<p>It contains the settings we need to use to create a <code class="language-plaintext highlighter-rouge">SummonEntity</code>.</p>

<p>In most cases, when a power is activated, it creates a <code class="language-plaintext highlighter-rouge">PowerPayload</code> instance. Summon powers register for the <code class="language-plaintext highlighter-rouge">OnDeliverPayload()</code> event, which we use to get the target that we are going to attach our future summon entity to. In <code class="language-plaintext highlighter-rouge">SummonPayloadEntity()</code> we calculate the number of entities that have already been summoned, and if the <code class="language-plaintext highlighter-rouge">KillPreviousSummons</code> flag is set, we kill existing ones to prevent infinite spawning. We get the number of summon entities to create from <code class="language-plaintext highlighter-rouge">SummonNumPerActivation</code>, compare it to <code class="language-plaintext highlighter-rouge">SummonMaxSimultaneous</code>, and then create the entities using <code class="language-plaintext highlighter-rouge">SummonEntityContext()</code>. We need to not only create the entities, but also calculate their position relative to the summoner, taking into account all the restrictions, offsets, collisions, and other parameters. All of this is handled by a function called <code class="language-plaintext highlighter-rouge">GetSummonPositions()</code>. After we get our spawn coordinates, we put our newly created entities into the world and attach them to the caster or the target based on the prototype flags if needed (<code class="language-plaintext highlighter-rouge">AttachSummonsToCaster</code> and <code class="language-plaintext highlighter-rouge">AttachSummonsToTarget</code> respectively).</p>

<p>In most cases this entity is going to be an invisible area called a <em>hotspot</em> that will damage and/or apply other effects to whoever overlaps with it.</p>

<h3 id="hotspots">Hotspots</h3>

<p>In most cases hotspots are invisible to players (except for visual effects in rare cases). When they enter the world, they also begin interacting with the game’s physics system, which is processed on the server and the client in parallel. The physics system simulates movement of entities within the game world and invokes events such as <code class="language-plaintext highlighter-rouge">OnOverlapBegin()</code> and <code class="language-plaintext highlighter-rouge">OnOverlapEnd()</code>.</p>

<p>The two main use cases for hotspots are mission triggers (<code class="language-plaintext highlighter-rouge">HandleOverlapBegin_Missions()</code>) and power triggers (<code class="language-plaintext highlighter-rouge">HandleOverlapBegin_Powers()</code> and <code class="language-plaintext highlighter-rouge">HandleOverlapEnd_PowerEvent()</code>). We have already covered missions in previous reports, and now it is time to talk about powers.</p>

<p>Hotspots apply powers defined in the prototype in the following two fields:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">AppliesPowers</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">AppliesIntervalPowers</code></p>
  </li>
</ul>

<p>And this is where it becomes complex. There are many powers and many targets, targets can enter and exit the hotspot, and all of this needs to be tracked. We use a dictionary with target id as key and a structure called <code class="language-plaintext highlighter-rouge">PowerTargetMap</code> as value:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">ulong</span><span class="p">,</span> <span class="n">PowerTargetMap</span><span class="p">&gt;</span> <span class="n">_overlapPowerTargets</span><span class="p">;</span>

<span class="k">public</span> <span class="k">struct</span> <span class="nc">PowerTargetMap</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">HotspotPowerMask</span> <span class="n">ActivePowers</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">HotspotPowerMask</span> <span class="n">IgnorePowers</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">HotspotPowerMask</code> is a bit field that can contain the state of up to 32 different powers. We use these masks to ensure that targets do not have effects applied to them multiple times, and the <code class="language-plaintext highlighter-rouge">HasConditionsForTarget()</code> function helps us prevent infinite condition stacks.</p>

<p><code class="language-plaintext highlighter-rouge">AppliesIntervalPowers</code> works differently: it can either affect random targets if the <code class="language-plaintext highlighter-rouge">IntervalPowersRandomTarget</code> flag is set, or it can target all entities at the same time.</p>

<p>When a new target begins overlapping with a hotspot’s bounds, it gets tracked using our dictionary, and all active powers are applied to it.</p>

<p>As you can see, this is a pretty complex process that involves the interaction of many different systems and events. Let’s take a closer look at one of them.</p>

<h3 id="attached-entities">Attached Entities</h3>

<p>When an entity flagged as <code class="language-plaintext highlighter-rouge">IsAttachedToEntity</code> enters the world, it is attached to the <code class="language-plaintext highlighter-rouge">EntityPhysics</code> component of the specified entity, where it is added to the <code class="language-plaintext highlighter-rouge">AttachedEntities</code> collection.</p>

<p>Every time the <code class="language-plaintext highlighter-rouge">PhysicsManager</code> processes entity movement, it calls <code class="language-plaintext highlighter-rouge">UpdateAttachedEntityPositions()</code>, which calls <code class="language-plaintext highlighter-rouge">ChangeRegionPosition()</code> for all entities in the <code class="language-plaintext highlighter-rouge">AttachedEntities</code> collection. Hotspots override <code class="language-plaintext highlighter-rouge">ChangeRegionPosition()</code> to take into account the offset it gets from <code class="language-plaintext highlighter-rouge">GetCenterOffset()</code> and the relative <code class="language-plaintext highlighter-rouge">SummonOffsetAngle</code>, which allows the beam to rotate around the user rather than its own center.</p>

<p>With this our short overview of hotspots is over, and you should have a general understanding of how it all works. Now I would like to talk about another topic.</p>

<h3 id="controlled-agents">Controlled Agents</h3>

<p>While I was working on summon powers, I noticed that it was related to two other systems: <code class="language-plaintext highlighter-rouge">TeamUpAgent</code> and <code class="language-plaintext highlighter-rouge">ControlledAgent</code>. These two, along with <code class="language-plaintext highlighter-rouge">VanityPet</code> summons, all belong to the same group called <code class="language-plaintext highlighter-rouge">PersistentAgents</code>.</p>

<p>When you transition within the same region using teleports (e.g. elevators in tower regions), your pets should transition with you (and not temporarily get stuck in the previous area like team-ups used to do). This is handled by the <code class="language-plaintext highlighter-rouge">RespawnPersistentAgents()</code> function. I had to overhaul our old team-up implementation for these new requirements. Now all three team-up modes are selectable, although not all functionality related to them is implemented at the time of writing. Let’s move over to controlled agents.</p>

<p>There is a relatively small number of heroes that can control enemies and turn them into pets. Here is the full least of them:</p>

<ul>
  <li>
    <p>Emma Frost (living enemies)</p>
  </li>
  <li>
    <p>Rogue (same as Emma Frost via a stolen power)</p>
  </li>
  <li>
    <p>Vision (robots)</p>
  </li>
  <li>
    <p>Magik (demons)</p>
  </li>
</ul>

<p>When you use a control power, the <code class="language-plaintext highlighter-rouge">ControlAgentAI</code> power event is invoked via <code class="language-plaintext highlighter-rouge">DoPowerEventActionControlAgentAI()</code>, which calls the <code class="language-plaintext highlighter-rouge">SetControlledAgent()</code> function that establishes control via <code class="language-plaintext highlighter-rouge">SetControlledAgent()</code>. This involves removing the existing controlled agent if needed (e.g. Magik) and binding the new one. The binding process includes placing the controlled entity into an inventory called <code class="language-plaintext highlighter-rouge">AvatarControlledEntities</code> belonging to the controlling avatar, setting the <code class="language-plaintext highlighter-rouge">AIMasterAvatarDbGuid</code> property on it to make it follow the avatar, and overriding its alliance to match the avatar. All boosts flagged as <code class="language-plaintext highlighter-rouge">DisableForControlledAgents</code> are removed, and we get an obedient pet.</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2025-02/summons-2.png"><img src="/MHServerEmu/assets/blog/progress-report/2025-02/summons-2.png" alt="Summons 2" /></a>
</center>

<p>As it turns out, in version 1.52 it is not possible to change pets on the fly. I am not sure when exactly it was changed, but currently the data-defined requirement looks like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HasEntityInInventory(Context=[Var2], Entity=[], Inventory=[Controlled]) ? False : True
</code></pre></div></div>

<p>This means that if our inventory with the <code class="language-plaintext highlighter-rouge">Controlled</code> label has any entity in it, it is impossible to control a new one. To get a new pet we first need to dismiss the existing one in the power panel:</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2025-02/summons-3.png"><img src="/MHServerEmu/assets/blog/progress-report/2025-02/summons-3.png" alt="Summons 3" /></a>
</center>

<p>Implementing all the systems we discussed above restored a lot of gameplay functionality: bosses are now more fun, enemies are more dangerous, and heroes are more playable (and summon-focused heroes are “playable” for the first time in a sense).</p>

<p>Hopefully you found this interesting. Until we meet again in future reports, and have fun playing!</p>

<hr />

<p>That is all we have to share today. Time for us to get back to finishing 0.5.0!</p>]]></content><author><name></name></author><category term="blog" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">MHServerEmu Progress Report: January 2025</title><link href="https://crypto137.github.io/MHServerEmu/blog/2025/01/31/progress-report-january-2025.html" rel="alternate" type="text/html" title="MHServerEmu Progress Report: January 2025" /><published>2025-01-31T22:15:00+03:00</published><updated>2025-01-31T22:15:00+03:00</updated><id>https://crypto137.github.io/MHServerEmu/blog/2025/01/31/progress-report-january-2025</id><content type="html" xml:base="https://crypto137.github.io/MHServerEmu/blog/2025/01/31/progress-report-january-2025.html"><![CDATA[<!--more-->

<p><img src="/MHServerEmu/assets/blog/progress-report/2025-01/header.jpg" alt="MHServerEmu Progress Report - January 2025" /></p>

<p>The first month of 2025 is almost over, and we have some MHServerEmu progress to share.</p>

<h2 id="conditions">Conditions</h2>

<p><a href="/MHServerEmu/blog/2024/12/30/progress-report-december-2024.html">By the end of last month</a> we had the skeleton for the condition system working, and it was time to build upon it. Two major things that were still missing were <em>pausing</em> and <em>disabling</em>.</p>

<p>Pausing makes it possible for a condition with finite duration to function as an infinite condition for as long as the pause is in effect. Pausing is allowed only for conditions flagged as <code class="language-plaintext highlighter-rouge">IsBoost</code> if one of the following criteria is met:</p>

<ul>
  <li>
    <p>The owner of the condition is currently in a region flagged as <code class="language-plaintext highlighter-rouge">PausesBoostConditions</code> (e.g. hub regions).</p>
  </li>
  <li>
    <p>The owner of the condition exits the world, such as during a loading screen.</p>
  </li>
  <li>
    <p>The global live tuning variable <code class="language-plaintext highlighter-rouge">eGTV_BoostTimersRunning</code> is set to false.</p>
  </li>
</ul>

<p>One important thing to note is that pausing a condition affects only its duration. Its effect remains applied even if it is “paused”.</p>

<p>Separate from pausing is disabling a condition. When a condition is disabled, it remains attached to its owner, but its effects are removed until it is enabled again. Conditions are disabled by setting the <code class="language-plaintext highlighter-rouge">DisablePowerEffects</code> property on the owner, which can be done by applying another condition. This system, combined with power activations triggered by power events and procs, functions essentially as a scripting language that can affect the state of the owner in different ways. For example, various special resource behaviors, like Hulk’s Anger or Punisher’s Ammo, use this functionality to enable and disable primary resource regeneration and decay depending on the current combat state.</p>

<p>With these taken care of, the condition system is now in a mostly functional state.</p>

<h2 id="resources">Resources</h2>

<p>The original plan was to merge the remaining power subsystems one by one as they were ready. However, while I was working on implementing Spirit, which is the simplest primary resource that many of the heroes use, it became apparent that on its own it will leave many other characters that rely on special behaviors in a semi-broken state. After getting some feedback from the players on our Discord server, I decided to batch these systems into a larger update of the power system, and this is what I have spent the majority of my time working on this month.</p>

<p>Resources in Marvel Heroes come in two flavors: primary and secondary. Each resource has an associated <code class="language-plaintext highlighter-rouge">ManaBehaviorPrototype</code> that defines its behavior, such as whether it starts empty or depletes on death. Avatars are the only entities that use resources; enemies, team-ups, and other AI-controlled characters do not have any.</p>

<p>Primary resources are referred to internally as <code class="language-plaintext highlighter-rouge">Endurance</code>, and all heroes have them. A hero can technically have multiple primary resources which are distinguished by the <code class="language-plaintext highlighter-rouge">ManaType</code> parameter, but in practice the only hero that uses this is Doctor Doom. The default primary resource is Spirit, which is essentially just mana. Special primary resource behaviors are implemented via the scripting-like system of powers and conditions mentioned in the previous section. Primary resources are displayed in the UI as the “globe” on the right side of the action bar:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2025-01/primary-resources.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2025-01/primary-resources.jpg" alt="Primary Resources" /></a></p>

<p>Secondary resources are optional, and they can represent various things, from combo points to ants, depending on the hero, with no default behavior. They can have pips, which are basically breakpoints for spending them and activating effects. Secondary resources are represented by horizontal bars above the power slots:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2025-01/secondary-resources.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2025-01/secondary-resources.jpg" alt="Secondary Resources" /></a></p>

<p>Implementing this system on its own was not particularly difficult, and we could have done it a long time ago. The real roadblocker until now has been getting all the other things that interact with it working, and we have made significant progress on that front as well.</p>

<h2 id="procs">Procs</h2>

<p><a href="/MHServerEmu/blog/2024/07/31/progress-report-july-2024.html">Back in July of last year</a> when we first got the power system working, I talked about how  in many cases powers are actually implemented as “combo” chains. Here is a quick recap: when a more complex effect is needed, it is done by activating subsequent powers when various <em>power events</em> happen, such as a power’s animation reaching its contact frame. <em>Procs</em> are essentially an extension of this system, except their only action is activation of a specific proc power (which in turn can do more varied actions), and their triggers are not limited to stages of the power pipeline.</p>

<p>In total there are 74 proc triggers as of version 1.52. Some of them are more generic, like <code class="language-plaintext highlighter-rouge">OnPowerHit</code> and <code class="language-plaintext highlighter-rouge">OnGotDamaged</code>, while others are more specialized, such as <code class="language-plaintext highlighter-rouge">OnSecondaryResourcePipGain</code>, <code class="language-plaintext highlighter-rouge">OnSkillshotReflect</code>, and <code class="language-plaintext highlighter-rouge">OnControlledEntityReleased</code>. Procs are assigned to entities using one of three proc properties: <code class="language-plaintext highlighter-rouge">Proc</code>, <code class="language-plaintext highlighter-rouge">ProcKeyword</code>, and <code class="language-plaintext highlighter-rouge">ProcNotKeyword</code>. In many cases these properties come from conditions applied by passive powers. Proc properties are parameterized by their trigger, a reference to the power they activate, and an optional parameter:</p>

<ul>
  <li>
    <p>For regular procs the parameter is a threshold value (e.g. an <code class="language-plaintext highlighter-rouge">OnEnduranceBelow</code> proc with a threshold value of <code class="language-plaintext highlighter-rouge">50</code> is going to activate when the owner’s primary resource drops below 50%).</p>
  </li>
  <li>
    <p>For <code class="language-plaintext highlighter-rouge">ProcKeyword</code> and <code class="language-plaintext highlighter-rouge">ProcNotKeyword</code> the parameter is a reference to a keyword prototype, with the former requiring something to have the keyword, and the latter being the opposite and requiring something to <em>not</em> have the keyword.</p>
  </li>
</ul>

<p>The value of the property represents the trigger chance of the proc. In some cases this chance is multiplied by the <code class="language-plaintext highlighter-rouge">OnHitProcChanceMultiplier</code> value taken from the prototype of the power that triggered the proc. When this multiplier is applied, the <code class="language-plaintext highlighter-rouge">ProcChanceMultiplierBehaviorType</code> that is also defined in the power prototype is taken into account. Possible values include:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">AllowProcChanceMultiplier</code> - applies the multiplier normally.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">IgnoreProcChanceMultiplier</code> - the multiplier is not applied.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">IgnoreProcChanceMultiplierUnlessZero</code> - the multiplier is used only to disable on hit procs completely.</p>
  </li>
</ul>

<p>The purpose of these multipliers is to limit the proc activation rate for fast hitting powers, which would trigger procs too often without them.</p>

<p>Here are some examples of proc properties:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ProcProp[OnAnyHit][CosmicItemSkyBeamAoe][0][0] = 0.05f</code></p>

    <ul>
      <li>This proc is activated by the <code class="language-plaintext highlighter-rouge">OnAnyHit</code> trigger, and the activation chance is 5%. The power this proc is going to activate is <code class="language-plaintext highlighter-rouge">CosmicItemSkyBeamAoe</code>. This is a proc assigned by one of the cosmic affixes found on gear.</li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ProcKeywordProp[OnPowerHit][FuryGainProcEffect][Fury][0] = 1.0f</code></p>

    <ul>
      <li>This proc is activated by the <code class="language-plaintext highlighter-rouge">OnPowerHit</code> trigger, it requires the triggering power to have the <code class="language-plaintext highlighter-rouge">Fury</code> keyword, and the activation chance is 100%. The power this proc is going to activate is <code class="language-plaintext highlighter-rouge">FuryGainProcEffect</code>. This is a proc assigned by one of Wolverine’s passive powers, and it’s his main way of restoring his primary resource.</li>
    </ul>
  </li>
</ul>

<p>The big challenge with implementing procs has been the sheer amount of code needed to handle all the various triggers. The code itself is very boilerplate and involves doing checks and filling out <code class="language-plaintext highlighter-rouge">PowerActivationSettings</code> instances, but the behavior of various triggers is subtly different enough to not be able to just reuse all the code.</p>

<p>After a few weeks of work though it was done, and now we have a fully-featured proc system. There is just one more gear needed to get this whole mechanism moving.</p>

<h2 id="tickers">Tickers</h2>

<p>Some properties apply effects to the entities they are assigned to periodically. Most of these involve dealing damage over time (DoT), healing over time (HoT), and applying resource changes over time. For this the game uses a class called <code class="language-plaintext highlighter-rouge">PropertyTicker</code>.</p>

<p>A ticker is essentially just a timer that applies properties at certain update intervals. What makes it special is how it interacts with conditions and procs: a proc can activate a power that will enable or disable a condition, which in turn will enable or disable its ticker. This is how resources like Hulk’s Anger works: entering and exiting combat triggers procs that turn Anger regeneration and decay on or off.</p>

<p>At the time of writing this the timer aspect of tickers has been implemented, and what remains is to expand the power results calculation pipeline to work with over time properties. As part of this I will also be doing a pass on how damage is calculated in general so that we can implement various damage mitigation effects. Overall I expect this to take a week or two, and after that this batch of power changes should be ready for testing in nightly builds.</p>

<h2 id="population-improvements">Population Improvements</h2>

<p>While I was busy with powers, Alex has also been hard at work improving some systems that needed more attention. Among them is the population system, which still had some marker-related issues that needed to be fixed.</p>

<p>The basic idea behind the population system is that the game has limited resources for spawning, and the <code class="language-plaintext highlighter-rouge">PopulationManager</code> class distributes these resources among various requests that often exceed the available resources. One example of such resource is markers, which are spawn points hand placed by game designers on various cells. There are many examples in the game when there are fewer markers than entities that try to spawn on them, and the population system has to handle this.</p>

<p>One issue we had was how mission requests for markers were handled. We had some instances where markers were partially used by different missions, and as a result none of them had enough enemies to complete them. To deal with this, Alex has implemented an “all or nothing” style distribution system for missions where markers get reserved in chunks, and if there aren’t enough markers, the mission will wait until it is its time to shine. Implementing this allowed us to deal with population issues in regions like Midtown Patrol.</p>

<p>Another problem was related to how spawn requests were prioritized. Some requests are flagged as “critical”, which means they need to spawn before everything else. When this priority is not taken into account, unexpected semi-random behavior can occur, like missions becoming incompletable. Due to a small oversight this priority was not taken into account in some cases, and this has now been fixed.</p>

<p>And here is a fun fact about marker conflicts: we just found a bug related to them that existed in the original game. In the Castle Doom terminal during the fight with Doctor Doom cutscenes are supposed to be playing on phase transitions, just like they do in story mode. However, because the terminal has two conflicting missions (<code class="language-plaintext highlighter-rouge">G09DoctorDoomDailyEndgame</code> and <code class="language-plaintext highlighter-rouge">DoomFightDailyKismetControl</code>), the necessary hotspots that trigger the cutscenes fail to spawn at all! This bug is now fixed by disabling one of the missions via live tuning, but you can still get the authentic buggy experience if you prefer it by turning the tuning off.</p>

<h2 id="modding">Modding</h2>

<p>In addition to polishing existing systems, in January Alex has also started some preliminary work on modding tools for modifying the client as a side project. While it is still very early, there have been some successful experiments with simple texture swaps.</p>

<p>The tool he is currently working on is called <em>MH Texture Manager</em>, and it is going to allow potential mod developers to browse and replace various textures. Here is what it looks like right now:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2025-01/texture-manager.png"><img src="/MHServerEmu/assets/blog/progress-report/2025-01/texture-manager.png" alt="MH Texture Manager" /></a></p>

<p>And here is what it is like in-game:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2025-01/texture-swap-example.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2025-01/texture-swap-example.jpg" alt="Texture Swap Example" /></a></p>

<p>Please keep in mind that this is purely experimental at this stage, and the scope of the MHServerEmu project does not include creating any new custom content. You can follow Alex’s progress with modding tools on <a href="https://github.com/AlexBond2/MHTextureManager">GitHub</a>.</p>

<hr />

<p>Back to the coding mines for us. See you all next time!</p>]]></content><author><name></name></author><category term="blog" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">MHServerEmu Progress Report: December 2024</title><link href="https://crypto137.github.io/MHServerEmu/blog/2024/12/30/progress-report-december-2024.html" rel="alternate" type="text/html" title="MHServerEmu Progress Report: December 2024" /><published>2024-12-30T17:45:00+03:00</published><updated>2024-12-30T17:45:00+03:00</updated><id>https://crypto137.github.io/MHServerEmu/blog/2024/12/30/progress-report-december-2024</id><content type="html" xml:base="https://crypto137.github.io/MHServerEmu/blog/2024/12/30/progress-report-december-2024.html"><![CDATA[<!--more-->

<p><img src="/MHServerEmu/assets/blog/progress-report/2024-12/header.jpg" alt="MHServerEmu Progress Report - December 2024" /></p>

<p>Another year is almost over, and we are steadily approaching our goal of fully restoring Marvel Heroes.</p>

<h2 id="conditions">Conditions</h2>

<p>With version 0.4.0’s release the game is now in a state that most people would probably consider “playable”. However, our work is still far from over, and now we need to focus on restoring the remaining depth of various systems.</p>

<p>In December it was time for me to go back to work on powers, which is something many people have been anxiously waiting for while I was busy with other features. We already had the basic framework for them in place since <a href="/MHServerEmu/blog/2024/07/31/progress-report-july-2024.html">July</a>, and more backend work was done in <a href="/MHServerEmu/blog/2024/09/30/progress-report-september-2024.html">September</a> while I was implementing dynamic combat levels, but all of that was just the tip of the power iceberg that we now need to tackle head-on:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-12/power-iceberg.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-12/power-iceberg.jpg" alt="The Power Iceberg" /></a></p>

<p>The next big step for powers was implementing <em>conditions</em>, which is the term the game uses internally for various buffs and debuffs that can be applied to world entities. Here is an overview of how it works.</p>

<p>Each <code class="language-plaintext highlighter-rouge">WorldEntity</code> instance has a <code class="language-plaintext highlighter-rouge">ConditionCollection</code> that contains <code class="language-plaintext highlighter-rouge">Condition</code> instances that have been applied to it. Conditions are applied as a result of various powers and can come from two main sources: a standalone <code class="language-plaintext highlighter-rouge">ConditionPrototype</code>, or a “mix-in” prototype within the <code class="language-plaintext highlighter-rouge">PowerPrototype</code> of the power that applied the condition. Generally speaking, standalone conditions are conditions that can be applied by different powers, such as boosts, while mix-in conditions are exclusive to a single power. The vast majority of conditions come from power mix-ins.</p>

<p>At their core <code class="language-plaintext highlighter-rouge">Condition</code> instances are essentially <code class="language-plaintext highlighter-rouge">PropertyCollection</code> instances with extra metadata that determine parameters like duration, pause state, and prototype overrides. When a <code class="language-plaintext highlighter-rouge">Condition</code> is added to a <code class="language-plaintext highlighter-rouge">ConditionCollection</code>, it is <em>accrued</em> to the collection’s owner, which includes attaching the condition’s properties to the owner’s in the same way as, for example, when you equip an item. Many conditions also affect the appearance of the entity they are applied to with various visual effects and animation changes.</p>

<p>Condition properties can cause a wide variety of effects. While some are simple stat modifiers, others are used to flag entities with <em>status effects</em>, like stuns and knockups. A whole separate category is over time properties, which are applied continuously using <em>tickers</em>. This is how things like damage over time (DoT) and regeneration effects are implemented.</p>

<p>If a condition’s metadata contains a valid duration, its end is scheduled when it is added. Some conditions do not have a duration, which means they have to be removed by an external event, like a power ending. A good example of this are bounce powers where the avatar is the one bouncing, like the ones Ant-Man and Daredevil have: when the bounce power activates, a condition is applied that makes the avatar’s mesh invisible and prevents movement. This condition is removed only when the bounce power ends, the timing of which varies depending on the distance between bounce targets. Another example is passive powers: they are powers that are automatically activated when an entity becomes simulated, which results in a condition that stays on for as long as the passive power is assigned. There are also conditions that last for as long as some movement is happening, like knockback conditions that prevent entities from moving themselves until the forced knockback movement ends.</p>

<p>Conditions can have various <em>stacking behaviors</em> defined in their prototypes, which restrict how multiple instances of the same condition can be applied to an entity. The main defining feature of a <code class="language-plaintext highlighter-rouge">StackingBehaviorPrototype</code> is its <code class="language-plaintext highlighter-rouge">ApplicationStyle</code>, which can have one of six possible values:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">DontRefresh</code>: condition instances are applied separately from one another.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Refresh</code>: applying new condition instances resets the duration of other instances that have already been applied.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Recreate</code>: applying new condition instances removes all other instances.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">MatchDuration</code>: the duration of the newly applied instances match the longest remaining duration out of all instances that have already been applied.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">SingleStackAddDuration</code>: only a single condition instance can be applied, and additional applications extend the duration of the applied instance.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">MultiStackAddDuration</code>: a combination of <code class="language-plaintext highlighter-rouge">Refresh</code> and <code class="language-plaintext highlighter-rouge">SingleStackAddDuration</code>, which results in the duration of other instances that have already been applied being refreshed and extended.</p>
  </li>
</ul>

<p>Condition instances are grouped into stacks using a structure called <code class="language-plaintext highlighter-rouge">StackId</code>, which consists of a prototype reference and a creator id. Based on the <code class="language-plaintext highlighter-rouge">StackingBehaviorPrototype</code>, in some cases conditions applied by different powers or created by different owners can still belong to the same stack. Finally, the stacking behavior determines how many instances should be applied per application, as well as how many instances in total can be applied using the same <code class="language-plaintext highlighter-rouge">StackId</code>.</p>

<p>There are some unique quirks related to condition persistence. Because only world entities can have conditions applied to them, and the player entity representing the account is not a world entity, account-wide conditions, like boosts, are “faked” by copying them when you switch between avatars. Conditions also need to be carefully serialized and deserialized, because many conditions are not supposed to run out when you are offline.</p>

<p>As of the time of writing this, the core implementation of the condition system is available for testing in nightly work-in-progress builds of version 0.5.0. Some additional features still need to be implemented, including pausing conditions in hub regions and property ticking. Tickers specifically are going to have a huge effect on the entire combat, because they are also going to allow us to implement various primary and secondary resources used by different heroes.</p>

<h2 id="bounce-powers">Bounce Powers</h2>

<p>As alluded to above, bounce powers are also now functional. This includes targeted powers that bounce around, like Storm’s Chain Lightning, bouncing projectiles, such as Captain America’s Shield Bounce, and powers where the avatar is bouncing in a chain of attacks, like Daredevil’s Street Sweeper. What is interesting about all of these is that everything about them is smoke and mirrors, <em>there is no actual movement happening</em>.</p>

<p>When a power is applied, its properties and the properties of its owner are snapshotted and recorded into a <code class="language-plaintext highlighter-rouge">PowerPayload</code> object. Some of these properties determine the “bounciness” of the power: <code class="language-plaintext highlighter-rouge">BounceCountPayload</code>, <code class="language-plaintext highlighter-rouge">BounceRangePayload</code>, and <code class="language-plaintext highlighter-rouge">BounceSpeedPayload</code>. When the payload is delivered and its effects are applied to its target, the game checks the remaining bounce count, and if it is higher than zero, it “bounces” the payload to another target, which simply changes its target id and schedules a new delivery after a delay. This delay is calculated from the payload’s bounce range and speed.</p>

<p>All the visuals of an object physically bouncing between targets is completely faked by the client. Every time a bounce delay is calculated, the server informs the client about it using the following message:</p>

<div class="language-protobuf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">NetMessagePowerBounce</span> <span class="p">{</span>
    <span class="k">required</span> <span class="kt">uint64</span>    <span class="na">idPowerUser</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">uint64</span>    <span class="na">idLastTarget</span>    <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">required</span> <span class="n">NetStructPoint3</span>    <span class="na">lastTargetPosition</span>    <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">uint64</span>    <span class="na">idNewTarget</span>    <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">uint64</span>    <span class="na">powerPrototypeId</span>    <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">uint64</span>    <span class="na">userOriginalAssetId</span>    <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">uint64</span>    <span class="na">userCurrentAssetId</span>    <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">float</span>    <span class="na">projectileSpeed</span>    <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="k">required</span> <span class="kt">int32</span>    <span class="na">fxRandomSeed</span>    <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The client uses data from this message to fake all the movement.</p>

<p>One last piece of the puzzle is how bounce targets are determined. When a bouncing payload’s target is set, its id is recorded as a <code class="language-plaintext highlighter-rouge">PowerPreviousTargetsID</code> property: depending on the power, these properties are later used to deprioritize or even completely avoid targets (if the <code class="language-plaintext highlighter-rouge">BounceCanRepeatTarget</code> flag is not set on the payload). When the payload hits a target, the game scans all entities in a radius around it, skipping those that have the <code class="language-plaintext highlighter-rouge">InvalidBounceTarget</code> property or are not valid targets for a particular power for other reasons. The most suitable target is then picked, taking into account distance, whether the entity has already been hit by this payload, and whether it is an enemy or a destructible environment object. The highest priority is given to closest enemies that have not been hit.</p>

<p>The bouncing continues until the payload either runs out of bounces or fails to find a new valid target. When the bouncing ends, the client is notified of it via one final <code class="language-plaintext highlighter-rouge">NetMessagePowerBounce</code>, which it uses to play the finishing visual effect or animation (e.g. a weapon returning to its owner). And with all of that we have bouncing:</p>

<div><video controls="" width="100%" /><source src="/MHServerEmu/assets/blog/progress-report/2024-12/bounce.webm" type="video/webm" /></div>

<p>This is a relatively minor addition in the grand scheme of things, but it made many powers across the entire hero roster usable.</p>

<h2 id="achievements-and-leaderboards">Achievements and Leaderboards</h2>

<p>While I was busy working on powers <del>and totally not grinding in Path of Exile 2</del>, Alex was hard at work implementing achievements and leaderboards, which utilize event-based tracking similar to missions, in which he has become quite an expert in it over the past months.</p>

<p>One peculiar thing about how achievements and leaderboards work is how their static data is delivered. The logical appoach would have been to have achievements be more rigid and rely on client-side data, while doing the leaderboards in a more dynamic way that relies on server data, but it is actually the other way around. The entire achievement database is sent from the server to the client on login, while all the leaderboards are hardcoded into the client and cannot be changed without a patch. Thankfully, we have a dump of the achievement database for version 1.52 we extracted from captured packets, which gave us a mostly complete dataset for this version. However, unfortunately, it is the only one we have, meaning that supporting achievements for other versions, like 1.48, is going to require pretty extensive reconstruction efforts using secondary sources, such as archived versions of the good old Marvel Heroes Compendium by Mjoll. We may have to build some custom tools to make the reconstruction process easier, but with enough time and effort this is a problem that can be solved. On the bright side, this also means that custom achievements will be relatively easy to implement.</p>

<p>Achievements are now functional and available for testing in nightly 0.5.0 builds. Some achievements may not be obtainable right now due to certain gameplay features not being implemented, but the overall achievement system is working, and more things will be properly tracked as they are done. The tracking for achievements also includes retroactive granting for some achievements, like reaching specific level thresholds and collecting thematic sets of items.</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-12/achievements.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-12/achievements.jpg" alt="Achievements" /></a></p>

<p>As I am writing this, Alex has now turned his attention to leaderboards, which proved to actually be a tougher nut to crack. One reason for this is that leaderboards have a lot of unfinished functionality, like guild leaderboards that were never used. They also required a pretty significant amount of backend work, mainly because leaderboards have instances that run in real time, with expired instances being archived in the database in case somebody decides to claim their rewards at some point in the future. All of this is in addition to tracking and reward systems similar to missions and achievements.</p>

<p>Although it was more laborious than expected, an early version of leaderboards is now being tested, and if things go well it will be merged and added to nightly builds relatively soon.</p>

<hr />

<p>That is all we have for you this year. See you all in the next one!</p>]]></content><author><name></name></author><category term="blog" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">MHServerEmu Progress Report: November 2024</title><link href="https://crypto137.github.io/MHServerEmu/blog/2024/11/30/progress-report-november-2024.html" rel="alternate" type="text/html" title="MHServerEmu Progress Report: November 2024" /><published>2024-11-30T14:00:00+03:00</published><updated>2024-11-30T14:00:00+03:00</updated><id>https://crypto137.github.io/MHServerEmu/blog/2024/11/30/progress-report-november-2024</id><content type="html" xml:base="https://crypto137.github.io/MHServerEmu/blog/2024/11/30/progress-report-november-2024.html"><![CDATA[<!--more-->

<p><img src="/MHServerEmu/assets/blog/progress-report/2024-11/header.jpg" alt="MHServerEmu Progress Report - November 2024" /></p>

<p>Progress Report is back yet again to bring you all the latest updates on the development of MHServerEmu.</p>

<h2 id="040-and-beyond">0.4.0 and Beyond</h2>

<p>As I am writing this report, we are putting the finishing touches on the fourth stable release of MHServerEmu: version 0.4.0. The highlights of this release include all the loot updates we have done over the last three months, as well as a feature-complete implementation of the mission system that has been in the works since July. 0.4.0 will be released during the first week of December, before a certain event on the 6th that will hold the attention of many ARPG fans, including myself. Sorry if there will be limited updates next month!</p>

<p>While most of the updates in 0.4.0 focus on restoring features that give you reasons to play the game in the long term, for the next stable version I plan to focus on the long-awaited improvements to the moment-to-moment feel of the game, most of which require implementing additional power subsystems. I cannot give you an in-depth list of what is going to make it into 0.5.0 right now, but the first thing I am going to work on will be <em>conditions</em>, which is the term the game uses to refer to various buff and debuff effects. In addition to the obvious benefit of being able to apply various bonuses and penalties, this system is also important because enemy AI relies on some of the status effects applied by conditions to make decisions, such as moving around or using powers. Not having the right conditions can cause various issues, including client-server desynchronization when fighting teleporting bosses like Living Laser and MODOK, or Bullseye being able to run around while he is charging his instant kill attack.</p>

<p>In addition to this, Alex and Kawaikikinou have started working on implementing the achievement system. Unfortunately, this may take a little longer than expected: while most of the game data is mirrored to the client, the achievement system is implemented in a way that allowed the developers to modify achievement data without patching the client. The client receives a dump of the server’s achievement database when you log in, and we have a copy of such dump we extracted from packet captures, but the data the client receives is incomplete. There is enough information to reconstruct the missing data by cross-referencing localized text with prototype file names, but this is a pretty laborious and mostly manual process that is going to take some time.</p>

<p>We will talk more about 0.5.0 features in future reports as we get them working.</p>

<h2 id="vendors">Vendors</h2>

<p>One extra feature I was able to sneak into 0.4.0 is <em>vendors</em>. Previously it was already possible to sell items to vendors, but now you can also buy items using all sorts of currencies (including buying back the items you sold for credits), as well as level up vendors by donating items or completing influence missions.</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-11/vendors.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-11/vendors.jpg" alt="Vendors" /></a></p>

<p>As with many other systems in this game, there is a lot of smoke and mirrors to sell you (no pun intended) the illusion of buying items from NPCs in the game world, but the reality is much more self-centered. Items sold by various vendors are actually contained in inventories belonging to the <code class="language-plaintext highlighter-rouge">Player</code> entity, which represents your account data. When you interact with a vendor NPC, all the items available for sale technically already belong to you, and the cost you pay to purchase them is to move them from one inventory to another. The same is true for buyback: when you sell an item, you get credits for moving it from your general inventory to your buyback inventory. The buyback inventory is not persistent, so it resets when you transition to another region. Some items are flagged as <code class="language-plaintext highlighter-rouge">ClonedWhenPurchasedFromVendor</code>, which means purchasing them creates a duplicate that gets put into your inventory.</p>

<p>But where do these items actually come from? When you press the refresh button or level up a vendor, the game rolls four vendor-related properties that exist and get saved as part of your <code class="language-plaintext highlighter-rouge">Player</code> entity: <code class="language-plaintext highlighter-rouge">VendorRollAvatar</code>, <code class="language-plaintext highlighter-rouge">VendorRollLevel</code>, <code class="language-plaintext highlighter-rouge">VendorRollSeed</code>, and <code class="language-plaintext highlighter-rouge">VendorRollTableLevel</code>. The values of these properties are used as input settings for rolling the loot tables associated with the <em>vendor type</em> you refreshed or leveled up. Each vendor type contains one or more inventories, which are initially empty. When you interact with an NPC that has a <code class="language-plaintext highlighter-rouge">VendorType</code> property referring to a vendor type prototype, the game uses the previously determined input settings to roll the loot table and create the items this vendor is supposed to be selling. Because the loot table rolling algorithm is deterministic and all the input settings remain the same, you get the same items every time. The game tracks inventory slots the contain the items you have already purchased and filters them out the next time the loot table is rolled.</p>

<p>The prices displayed in the vendor panel are calculated by the client in parallel to the server, and this has been a major source of frustration. I have checked everything multiple times and calculated the formulas by hand for various input parameters, and no matter how you look at it, there are what appears to be pretty massive rounding errors happening client-side when calculating prices in credits. Unfortunately, I have not been able to find a way to replicate this behavior server-side yet, so for the time being the prices items are being bought and sold for will be slightly off. This affects only prices in credits as far as I can tell, and buy prices are affected more than sell prices, most likely due to the difference in coefficients used for calculating them.</p>

<p>With vendors implemented there is one side effect you can see: crafter NPCs now have their recipe lists populated and can also be leveled up. This is because crafters share their backend with vendors: every recipe is actually an item that is stored in the player’s inventory associated with a specific crafter type. “Items” representing recipes that unlock by leveling up your crafters are rolled using loot tables, same as items sold by regular vendors. As for recipes you can learn by using consumable items, they are stored separately in a special inventory called <code class="language-plaintext highlighter-rouge">PlayerCraftingRecipesLearned</code>. After a crafter’s recipe list is rolled, additional recipes contained in the <code class="language-plaintext highlighter-rouge">PlayerCraftingRecipesLearned</code> are duplicated and appended to the list. Please note that while you can level up your crafters in the current work-in-progress server builds, you cannot craft any recipes or learn new ones from consumable items.</p>

<p>Special vendor types, including Eternity Splinter and Odin Mark vendors, also work now, meaning you now have access to additional content, like the Classified Bovine Sector and Bovineheim portals you can purchase from Eternity Splinter vendors, as well as legendary items you can buy with Odin Marks. I have also put in some additional work to get legendary item leveling working. With all of this you should have plenty of medium-term goals to work towards while we work on restoring other features of the game.</p>

<h2 id="map-rotation">Map Rotation</h2>

<p>In this section I would like to talk about not a flashy new feature, but rather a frustrating bug that I have spent way too much time on than I probably should have.</p>

<p>First, let’s establish the background. Entities that can have a location in the game world are called <em>world entities</em>. A world entity can <em>enter</em> and <em>exit</em> the world: for example, when an item drops on the ground, it <em>enters</em> the world, but as soon as you pick it up, it <em>exits the world</em> and gets put into one of your inventories. Whether an entity is in the world or not can also be different between the client and the server. This is because the client simulates only the part of the world that is within the player’s proximity, while the server manages entire regions. However, the client can still be aware of entities that exist outside of its proximity, like other players, valuable items, and transitions to other regions.</p>

<p>In most cases entities outside of proximity are represented by map icons, and the client needs some way of knowing where to put them. The client cannot simulate locomotion without loading the environment, so instead there are two properties that world entities can have: <code class="language-plaintext highlighter-rouge">MapPosition</code> and <code class="language-plaintext highlighter-rouge">MapOrientation</code>. As the server simulates entities and locomotes them, it also periodically updates these two properties to notify when distant entities move or rotate. However, there was a problem: for some mysterious reason, map icons were not able to face bottom left directions. While this is an incredibly minor issue, it was bugging me (pun intended), so I had to get to the bottom of it.</p>

<p>Rotation in Marvel Heroes is expressed in radians rather than degrees. This is how most game engines do this, and the main reason is that while radians are less human-readable, they are easier and therefore faster to do calculations with. The game normalizes the results of most rotation-related calculations to a range of [-π ; π], which is also true for the <code class="language-plaintext highlighter-rouge">MapOrientation</code> property that holds a <code class="language-plaintext highlighter-rouge">float</code> type with a value range of approximately [-3.14 ; 3.14]. Here is a diagram to visualize what it looks like within the context of the coordinate system used by Marvel Heroes:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-11/rotation-1.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-11/rotation-1.png" alt="Rotation 1" /></a></p>

<p>If you look carefully, you can probably notice what was causing the issue with bottom left directions specifically: they are expressed by <em>negative values</em>. Why is this an issue? Each entity property has a minimum and maximum allowed value, and everything outside of this range is clamped. For <code class="language-plaintext highlighter-rouge">MapOrientation</code> this range is [0 ; 65535], meaning any negative values get clamped to zero. What greatly added to the confusion was that in the packet captures we have the client in fact did receive negative values for the <code class="language-plaintext highlighter-rouge">MapOrientation</code> property from the server. So the instinct was to look for bugs in how properties work. However, this turned out to be a massive waste of time. You see, the clamping happens within the <code class="language-plaintext highlighter-rouge">PropertyCollection::SetPropertyValue()</code> method. However, the replication of the value is handled by the <code class="language-plaintext highlighter-rouge">ReplicatedPropertyCollection</code> class that inherits from <code class="language-plaintext highlighter-rouge">PropertyCollection</code>. In its <code class="language-plaintext highlighter-rouge">SetPropertyValue()</code> override it passes all the arguments to the implementation from the base class and then notifies the client if the property actually changed. Here is what the code looks like in our reimplementation:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">SetPropertyValue</span><span class="p">(</span><span class="n">PropertyId</span> <span class="n">id</span><span class="p">,</span> <span class="n">PropertyValue</span> <span class="k">value</span><span class="p">,</span> <span class="n">SetPropertyFlags</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="n">changed</span> <span class="p">=</span> <span class="k">base</span><span class="p">.</span><span class="nf">SetPropertyValue</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span>
        <span class="nf">MarkPropertyChanged</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The issue is that the new value is passed to the base implementation <em>by value</em> rather than <em>by reference</em>, which means the code clamps <em>a copy</em> of the value that was passed, and the value that is sent to the client is unaffected by it! In other words, <em>both</em> the client and the server clamp the original negative value to zero. Therefore, it is not possible to make the client accept negative values for <code class="language-plaintext highlighter-rouge">MapOrientation</code> without modifying its prototype data.</p>

<p>Figuring all of this out was the hard part, and the solution was actually incredibly easy. Rather than normalizing the value to a range of [-π ; π], we now get rid of negative values by using a range of [0 ; 2π]:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-11/rotation-2.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-11/rotation-2.png" alt="Rotation 2" /></a></p>

<p>And with that icons for distant players can now face bottom left, as they should:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-11/rotation-3.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-11/rotation-3.jpg" alt="Rotation 3" /></a></p>

<p>As insignificant as this bug may seem to be, I wanted to talk about it because it is a great example of one of the main difficulties we have with this project. Because we no longer have access to the original game, at times it can be hard to distinguish issues with our implementation from bugs that existed back in the day.</p>

<hr />

<p>Thank you for following the development of MHServerEmu. See you next time!</p>]]></content><author><name></name></author><category term="blog" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">MHServerEmu Progress Report: October 2024</title><link href="https://crypto137.github.io/MHServerEmu/blog/2024/10/31/progress-report-october-2024.html" rel="alternate" type="text/html" title="MHServerEmu Progress Report: October 2024" /><published>2024-10-31T17:55:00+03:00</published><updated>2024-10-31T17:55:00+03:00</updated><id>https://crypto137.github.io/MHServerEmu/blog/2024/10/31/progress-report-october-2024</id><content type="html" xml:base="https://crypto137.github.io/MHServerEmu/blog/2024/10/31/progress-report-october-2024.html"><![CDATA[<!--more-->

<p><img src="/MHServerEmu/assets/blog/progress-report/2024-10/header.jpg" alt="MHServerEmu Progress Report - October 2024" /></p>

<p>Time for the spookiest MHServerEmu Progress Report of the year.</p>

<h2 id="loot-continued">Loot Continued</h2>

<p>With most of the obvious low-hanging fruit features taken care of, this month it was time for me to work on a more time-consuming aspect of the game. After discussing this with Alex and some of the community members on our Discord server, I decided to continue iterating on our loot system implementation.</p>

<p>At the start of the month we had loot tables rolling, items dropping, and affixes being picked, but the game’s loot system is much broader than just items. In total there are 12 loot types:</p>

<ul>
  <li>
    <p><strong>Item</strong> - should be self-explanatory.</p>
  </li>
  <li>
    <p><strong>Agent</strong> - health, mana, and experience orbs, as well as boons.</p>
  </li>
  <li>
    <p><strong>Credits</strong> - legacy loot type from before currencies were implemented, credit piles are represented by agent entities (more on that later).</p>
  </li>
  <li>
    <p><strong>Experience</strong> - mission experience rewards.</p>
  </li>
  <li>
    <p><strong>Power Points</strong> - extra power points (pre-BUE missions only).</p>
  </li>
  <li>
    <p><strong>Health Bonus</strong> - max health bonuses (pre-BUE missions only).</p>
  </li>
  <li>
    <p><strong>Endurance Bonus</strong> - max primary resource (spirit, etc.) bonuses (pre-BUE missions only).</p>
  </li>
  <li>
    <p><strong>Real Money</strong> - special drop type used only for the <a href="https://web.archive.org/web/20150711031211/https://forums.marvelheroes.com/discussion/216905/marvel-heroes-2015-1-61-patch-notes">Vibranium Ticket promotion</a> in 2015.</p>
  </li>
  <li>
    <p><strong>Callback Nodes</strong> - actions that need to happen when loot is distributed, such as displaying a banner message.</p>
  </li>
  <li>
    <p><strong>Vanity Title</strong> - title unlocks.</p>
  </li>
  <li>
    <p><strong>Vendor XP</strong> - experience for leveling up vendors (this is also how Genosha influence rewards are implemented).</p>
  </li>
  <li>
    <p><strong>Currency</strong> - any non-credits currency that can be represented by either an item or an agent.</p>
  </li>
</ul>

<p>Loot can awarded through two types of <em>loot actions</em>: <em>spawning</em> and <em>giving</em>. Spawning creates loot represented in the game world by items and agents for players to pick up, while giving adds everything straight to players’ inventories. Only items, agents, credits, and currency can exist in the game world, everything else goes directly to players, even if the spawn loot action is requested.</p>

<p>Loot that needs to be clicked on to be picked up is represented by the <code class="language-plaintext highlighter-rouge">Item</code> entity class, while things that get picked automatically when you run over them exist as <code class="language-plaintext highlighter-rouge">Agent</code> entity instances. Here is a chart that shows how loot types relate to entity types that represent them:</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2024-10/loot-entity-types.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-10/loot-entity-types.png" alt="Loot Entity Types" /></a>
</center>

<p>Note that item and agent <em>loot types</em> are different from <code class="language-plaintext highlighter-rouge">Item</code> and <code class="language-plaintext highlighter-rouge">Agent</code> <em>entity types</em>. When loot tables are rolled, and an item or an agent drop node is encountered, the game checks if the entity prototype specified in the node has an <code class="language-plaintext highlighter-rouge">ItemCurrency</code> property defined. If it does, the drop gets designated as a currency loot type, rather than the loot type corresponding its underlying entity type. To add even more confusion to the mix, credits are their own drop type, and they are always represented by <code class="language-plaintext highlighter-rouge">Agent</code> entities. And because things were not hectic enough, <code class="language-plaintext highlighter-rouge">Agent</code> entities representing currencies are referred to as currency <em>items</em> in the game data.</p>

<p>With all of that figured out, we now had non-item drops spawning. The next thing to do was implementing pickups for orb (agent) drops when you run over them.</p>

<p>The obvious approach would have been to use the physics system to detect when avatars overlap with orbs, and do the pickup interaction in the handler for this event. There was a problem though: most orb entities do not have a collision shape defined, meaning they are not capable of overlapping with other world entities. The correct way to do it was to implement the <code class="language-plaintext highlighter-rouge">ProceduralProfileOrbPrototype</code> and do the pickup interaction within the <code class="language-plaintext highlighter-rouge">Think()</code> method. Orbs actually have the <code class="language-plaintext highlighter-rouge">AICustomThinkRateMS</code> property, allowing them to “think” and check distances to potential receipients on every frame, making this interaction more responsive than it would have been with default AI settings.</p>

<p>Here is what the current implementation of <code class="language-plaintext highlighter-rouge">Think()</code> for orbs looks like:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Think</span><span class="p">(</span><span class="n">AIController</span> <span class="n">ownerController</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ProceduralAI</span> <span class="n">proceduralAI</span> <span class="p">=</span> <span class="n">ownerController</span><span class="p">.</span><span class="n">Brain</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">proceduralAI</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">Agent</span> <span class="n">agent</span> <span class="p">=</span> <span class="n">ownerController</span><span class="p">.</span><span class="n">Owner</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">agent</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">Game</span> <span class="n">game</span> <span class="p">=</span> <span class="n">agent</span><span class="p">.</span><span class="n">Game</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">game</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">// Destroy this orb if it has finished shrinking</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ShrinkageDurationMS</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">TimeSpan</span> <span class="n">shrinkageEndTime</span> <span class="p">=</span> <span class="n">agent</span><span class="p">.</span><span class="n">Properties</span><span class="p">[</span><span class="n">PropertyEnum</span><span class="p">.</span><span class="n">AICustomTimeVal1</span><span class="p">]</span> 
            <span class="p">+</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromMilliseconds</span><span class="p">(</span><span class="n">ShrinkageDelayMS</span><span class="p">)</span> 
            <span class="p">+</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromMilliseconds</span><span class="p">(</span><span class="n">ShrinkageDurationMS</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">CurrentTime</span> <span class="p">&gt;=</span> <span class="n">shrinkageEndTime</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">agent</span><span class="p">.</span><span class="nf">Kill</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">KillFlags</span><span class="p">.</span><span class="n">NoDeadEvent</span> <span class="p">|</span> <span class="n">KillFlags</span><span class="p">.</span><span class="n">NoExp</span> <span class="p">|</span> <span class="n">KillFlags</span><span class="p">.</span><span class="n">NoLoot</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Find an avatar that can potentially pick this orb up</span>
    <span class="n">Avatar</span> <span class="n">avatar</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="kt">ulong</span> <span class="n">restrictedToPlayerGuid</span> <span class="p">=</span> <span class="n">agent</span><span class="p">.</span><span class="n">Properties</span><span class="p">[</span><span class="n">PropertyEnum</span><span class="p">.</span><span class="n">RestrictedToPlayerGuid</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">restrictedToPlayerGuid</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Player</span> <span class="n">player</span> <span class="p">=</span> <span class="n">game</span><span class="p">.</span><span class="n">EntityManager</span><span class="p">.</span><span class="n">GetEntityByDbGuid</span><span class="p">&lt;</span><span class="n">Player</span><span class="p">&gt;(</span><span class="n">restrictedToPlayerGuid</span><span class="p">);</span>
        <span class="c1">// Get current avatar for the player we are looking for</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">player</span><span class="p">?.</span><span class="n">CurrentAvatar</span><span class="p">?.</span><span class="n">IsInWorld</span> <span class="p">==</span> <span class="k">true</span><span class="p">)</span>
            <span class="n">avatar</span> <span class="p">=</span> <span class="n">player</span><span class="p">.</span><span class="n">CurrentAvatar</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// If we found an avatar, check if it can pick this orb up</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">avatar</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Vector3</span> <span class="n">agentPosition</span> <span class="p">=</span> <span class="n">agent</span><span class="p">.</span><span class="n">RegionLocation</span><span class="p">.</span><span class="n">Position</span><span class="p">;</span>
        <span class="n">Vector3</span> <span class="n">avatarPosition</span> <span class="p">=</span> <span class="n">avatar</span><span class="p">.</span><span class="n">RegionLocation</span><span class="p">.</span><span class="n">Position</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">Vector3</span><span class="p">.</span><span class="nf">DistanceSquared2D</span><span class="p">(</span><span class="n">agentPosition</span><span class="p">,</span> <span class="n">avatarPosition</span><span class="p">)</span> <span class="p">&lt;</span> <span class="n">_orbRadiusSquared</span> <span class="p">&amp;&amp;</span> <span class="nf">TryGetPickedUp</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">avatar</span><span class="p">))</span>
            <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The actual pickup interaction happens within <code class="language-plaintext highlighter-rouge">TryGetPickedUp()</code>: this includes applying orb effects, such as adding currency, awarding XP, and activating powers (restoring health/spirit, applying boon buffs, etc.). There is still some additional AI behavior left to implement: health and spirit orbs are supposed to be able to follow avatars that get close enough to them, and some orbs need to be non-instanced and available for all players to pick up. This is something we will be iterating on in the future.</p>

<p>With more varied loot being able to drop and be picked up, it was now time to expand the range of available <em>loot drop event types</em>. Everything so far has been using the four events associated with defeating enemies: <code class="language-plaintext highlighter-rouge">OnKilled</code>, <code class="language-plaintext highlighter-rouge">OnKilledChampion</code>, <code class="language-plaintext highlighter-rouge">OnKilledElite</code>, and <code class="language-plaintext highlighter-rouge">OnKilledMiniBoss</code>. However, for treasure chests it was necessary to implement a separate event type called <code class="language-plaintext highlighter-rouge">OnInteractedWith</code>, which was not possible to trigger without a more in-depth interaction system.</p>

<p>I did not have to go through the trouble of overhauling the entire interaction system: as part of his work on missions, Alex had already done most of the work needed. However, missions are a huge all-encompassing system, and merging the development branch would have been too disruptive at this stage. So instead I went through it and manually ported just the parts that could work on their own, including the new interaction system. There were a few small crashes as a result of this porting process, but they were very quickly dealt with, and implementing treasure chest loot was as easy as adding some function calls in the right place. I also had to do a bit of refactoring to isolate some code from <code class="language-plaintext highlighter-rouge">OnKilled</code> event handlers that could be shared with <code class="language-plaintext highlighter-rouge">OnInteractedWith</code>. With that taken care of, we now have a much more satifying treasure room experience.</p>

<p>The next thing to do became obvious as soon as currency items started dropping: without cooldowns, entire screens were covered with Eternity Splinters, which was obviously not how it was supposed to work. Work on this is still ongoing at the time of writing this, but the iconic six-minute Eternity Splinter timer is now working in nightly builds as it should.</p>

<p>This is just one type of loot cooldowns though. As with almost everything in this game, there are many almost conflicting systems that were piled up on top of one another. For instance, some loot cooldowns can be tied to specific entities rather than drops, like terminal bosses you would get Cube Shards from. Other cooldowns are rollover-based, meaning your loot is gated by specific daily or weekly reset times rather than amount of time since your last drop. Untangling all of this is going to take some time, which is what I am going to be continuing to work on next month.</p>

<h2 id="lets-get-dangerous">Let’s Get Dangerous</h2>

<p><em>Alex has some details to share on what he has been working on in October.</em></p>

<hr />

<p>Hello everyone, this is AlexBond. In this report I would like to <del>overwhelm you with code</del> talk about how the <code class="language-plaintext highlighter-rouge">SpawnMap</code> class works, how <em>Legendary Missions</em> are rolled, and how I got into the <em>Danger Room</em>.</p>

<h3 id="spawnmap">SpawnMap</h3>

<p><code class="language-plaintext highlighter-rouge">AreaPrototype</code> contains various population parameters, and some of them have a <code class="language-plaintext highlighter-rouge">SpawnMap</code> prefix. We used to ignore them, but now we took advantage of them to implement an additional spawning system.</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-10/alex-1.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-10/alex-1.png" alt="AlexBond 1" /></a></p>

<p>A <code class="language-plaintext highlighter-rouge">SpawnMap</code> (also referred to as a <code class="language-plaintext highlighter-rouge">HeatMap</code>) is like a bitmap image with a resolution of 256x256, in which each “pixel” represents a byte of information of type <code class="language-plaintext highlighter-rouge">HeatData</code>. The contained “heat” is transferred to clusters of mobs for spawning.</p>

<p>When we initialize this class, we iterate over all coordinates within our area to determine walkable sections using the navi system.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">y</span> <span class="p">&lt;</span> <span class="n">_boundsY</span><span class="p">;</span> <span class="n">y</span><span class="p">++)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">x</span> <span class="p">&lt;</span> <span class="n">_boundsX</span><span class="p">;</span> <span class="n">x</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">Vector3</span> <span class="n">position</span> <span class="p">=</span> <span class="n">center</span> <span class="p">+</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">Resolution</span> <span class="p">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">Resolution</span> <span class="p">*</span> <span class="n">y</span><span class="p">,</span> <span class="m">0.0f</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">navi</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">spawnRadius</span><span class="p">,</span> <span class="k">new</span> <span class="nf">WalkPathFlagsCheck</span><span class="p">()))</span>
        <span class="p">{</span>
            <span class="n">_heatMap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="n">HeatData</span><span class="p">.</span><span class="n">Min</span><span class="p">;</span>
            <span class="n">_spawnZone</span><span class="p">++;</span>
        <span class="p">}</span>
        <span class="n">index</span><span class="p">++;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Using the <code class="language-plaintext highlighter-rouge">spawnZone</code> parameter, we calculate the heat density of the population that is going to be spawned. This density is then applied to our <code class="language-plaintext highlighter-rouge">SpawnMap</code> instance.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Add heat to HeatMap</span>
<span class="n">_pool</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">index</span> <span class="p">&lt;</span> <span class="n">_heatMap</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">index</span><span class="p">++)</span>
<span class="p">{</span>
    <span class="n">HeatData</span> <span class="n">heatData</span> <span class="p">=</span> <span class="n">_heatMap</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nf">HasFlags</span><span class="p">(</span><span class="n">heatData</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">heat</span> <span class="p">=</span> <span class="nf">GetHeat</span><span class="p">(</span><span class="n">heatData</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">heat</span> <span class="p">+</span> <span class="n">_heatBase</span> <span class="p">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">HeatData</span><span class="p">.</span><span class="n">Max</span><span class="p">)</span>
        <span class="n">_heatMap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="n">HeatData</span><span class="p">)(</span><span class="n">heat</span> <span class="p">+</span> <span class="n">_heatBase</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">_pool</span> <span class="p">+=</span> <span class="n">_heatBase</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The surplus heat is transferred to a <em>pool</em>, and at intervals defined by the <code class="language-plaintext highlighter-rouge">SpawnMapPoolTickMS</code> parameter we attempt to bring back the heat from the pool to the map.</p>

<p>Because <code class="language-plaintext highlighter-rouge">SpawnMap</code> instances update every time a player moves, they require some additional optimizations. To reduce server load, only areas around players defined by <code class="language-plaintext highlighter-rouge">SpawnGimbal</code> instances are populated.</p>

<p>A <code class="language-plaintext highlighter-rouge">SpawnGimbal</code> is a sort of shifting area that has already been checked, in which a player is located. This system allows us to significantly reduce server load for processing areas that have already been populated.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">UpdateSpawnMap</span><span class="p">(</span><span class="n">Vector3</span> <span class="n">position</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Region</span> <span class="n">region</span> <span class="p">=</span> <span class="nf">GetRegion</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">region</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">_spawnGimbal</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_spawnGimbal</span><span class="p">.</span><span class="nf">ProjectGimbalPosition</span><span class="p">(</span><span class="n">region</span><span class="p">.</span><span class="n">Aabb</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="k">out</span> <span class="n">Point2</span> <span class="n">coord</span><span class="p">)</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_spawnGimbal</span><span class="p">.</span><span class="n">Coord</span> <span class="p">==</span> <span class="n">coord</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kt">bool</span> <span class="n">inGimbal</span> <span class="p">=</span> <span class="n">_spawnGimbal</span><span class="p">.</span><span class="nf">InGimbal</span><span class="p">(</span><span class="n">coord</span><span class="p">);</span>
    <span class="n">_spawnGimbal</span><span class="p">.</span><span class="nf">UpdateGimbal</span><span class="p">(</span><span class="n">coord</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">inGimbal</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="n">Aabb</span> <span class="n">volume</span> <span class="p">=</span> <span class="n">_spawnGimbal</span><span class="p">.</span><span class="nf">HorizonVolume</span><span class="p">(</span><span class="n">position</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">area</span> <span class="k">in</span> <span class="n">region</span><span class="p">.</span><span class="nf">IterateAreas</span><span class="p">(</span><span class="n">volume</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">area</span><span class="p">.</span><span class="n">SpawnMap</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="n">area</span><span class="p">.</span><span class="n">PopulationArea</span><span class="p">?.</span><span class="nf">UpdateSpawnMap</span><span class="p">(</span><span class="n">position</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>There is a trade-off though: when a player moves at high speed, groups of enemies can spawn right at their position, but this behavior is accurate to the original game. The reason for these delays is that spawning takes at least 500 ms, which is not enough for enemies to spawn ahead of time. We can reduce this number, but then it would take longer to wait a spawn to happen.</p>

<p>When <code class="language-plaintext highlighter-rouge">UpdateHeatMap()</code> is called, the related population is spawned in “hot spots”. These spots are projected to the <code class="language-plaintext highlighter-rouge">HeatMap</code>, and the heat is subtracted from those points, along with neighboring points within a certain radius. This frees up space for a group of mobs represented by a <code class="language-plaintext highlighter-rouge">ClusterObject</code>, and allows us to spread the population evenly.</p>

<p>Clusters may contain special <code class="language-plaintext highlighter-rouge">BlackOutZone</code> objects that prevent spawning from happening. We take these objects into account by transferring heat from their locations into the common pool.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">index</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">spawnZone</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">y</span> <span class="p">&lt;</span> <span class="n">_boundsY</span><span class="p">;</span> <span class="n">y</span><span class="p">++)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">x</span> <span class="p">&lt;</span> <span class="n">_boundsX</span><span class="p">;</span> <span class="n">x</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">_heatMap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">&amp;=</span> <span class="p">~</span><span class="n">HeatData</span><span class="p">.</span><span class="n">BlackOut</span><span class="p">;</span>

        <span class="n">Vector3</span> <span class="n">position</span> <span class="p">=</span> <span class="n">center</span> <span class="p">+</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">Resolution</span> <span class="p">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">Resolution</span> <span class="p">*</span> <span class="n">y</span><span class="p">,</span> <span class="m">0.0f</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="n">BlackOutZone</span> <span class="n">zone</span> <span class="k">in</span> <span class="n">zones</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">float</span> <span class="n">radiusSq</span> <span class="p">=</span> <span class="n">MathHelper</span><span class="p">.</span><span class="nf">Square</span><span class="p">(</span><span class="n">zone</span><span class="p">.</span><span class="n">Sphere</span><span class="p">.</span><span class="n">Radius</span><span class="p">);</span>
            <span class="kt">float</span> <span class="n">distanceSq</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="nf">DistanceSquared2D</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">zone</span><span class="p">.</span><span class="n">Sphere</span><span class="p">.</span><span class="n">Center</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">distanceSq</span> <span class="p">&lt;</span> <span class="n">radiusSq</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">heat</span> <span class="p">=</span> <span class="nf">GetHeat</span><span class="p">(</span><span class="n">_heatMap</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
                <span class="n">_heatMap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="n">_heatMap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">&amp;</span> <span class="n">HeatData</span><span class="p">.</span><span class="n">FlagMask</span><span class="p">)</span> <span class="p">|</span> <span class="n">HeatData</span><span class="p">.</span><span class="n">BlackOut</span><span class="p">;</span>
                <span class="nf">PoolHeat</span><span class="p">(</span><span class="n">heat</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nf">HasFlags</span><span class="p">(</span><span class="n">_heatMap</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span> <span class="n">spawnZone</span><span class="p">++;</span>
        <span class="n">index</span><span class="p">++;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When a group of enemies is fully destroyed, the heat they took is returned to the common pool. This gives regions an endless lifespan, which is crucial for public regions.  This way newly arriving players will encounter a living world, rather than a wasteland from past battles. Ensuring this is the primary function of the <code class="language-plaintext highlighter-rouge">SpawnMap</code> class.</p>

<p>As you can see, there are numerous different systems for spawning: <code class="language-plaintext highlighter-rouge">PopulationArea</code>, <code class="language-plaintext highlighter-rouge">RespawnDestructibles</code>, <code class="language-plaintext highlighter-rouge">MetaGame</code>, <code class="language-plaintext highlighter-rouge">Mission</code>, <code class="language-plaintext highlighter-rouge">SpawnMap</code>, <code class="language-plaintext highlighter-rouge">Spawner</code>, and more. Here is a recap of what they are all for:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">PopulationArea</code> populates regions without using markers.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">RespawnDestructibles</code> allows props, such as cars and garbage cans, to be restored.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">MetaGame</code> populates regions with timer-based events or waves.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Mission</code> spawns in response to event triggers.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">SpawnMap</code> prevents regions from becoming barren wastelands.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Spawner</code> can activate when a player enters its radius, or via some other kind of trigger.</p>
  </li>
</ul>

<p>In other words, dynamic spawning makes the game more alive. Now let’s take a look at legendary missions.</p>

<h3 id="legendary-missions">Legendary Missions</h3>

<p>This game has a lot of activities: in addition to the story, region events, and terminal bounties, there are also Legendary Missions, Daily Missions, Shared Quests, Omega Missions, and Weekly Missions. So how does it all work?</p>

<p>When a player enters a region, their <code class="language-plaintext highlighter-rouge">MissionManager</code> runs <code class="language-plaintext highlighter-rouge">InitializeForPlayer()</code> and does a number of random picks.</p>

<p>First it picks <em>categories</em> through <code class="language-plaintext highlighter-rouge">LegendaryMissionCategoryPicker</code>, and then for each category it picks a random mission using <code class="language-plaintext highlighter-rouge">PickLegendaryMissionForCategory()</code>. At first it seems simple enough, but there is a catch.</p>

<p>For example, a mission was picked, and we don’t like it. What do we do in this case? That’s right, we reroll it with credits!</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2024-10/alex-2.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-10/alex-2.png" alt="AlexBond 6" /></a>
</center>

<p>In this case the current mission must be added to a <code class="language-plaintext highlighter-rouge">LegendaryMissionBlacklist</code>, and we should receive a new one. This is also used when we complete a mission, so that we don’t get the same one multiple times in a row. But what happens when all missions get blacklisted? In this case we need a second round of picking.</p>

<p>This is what the code looks like. Confusing, isn’t it?</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="n">PrototypeId</span> <span class="nf">PickLegendaryMission</span><span class="p">()</span>
<span class="p">{</span> 
    <span class="n">PrototypeId</span> <span class="n">pickedMissionRef</span> <span class="p">=</span> <span class="n">PrototypeId</span><span class="p">.</span><span class="n">Invalid</span><span class="p">;</span>

    <span class="n">Picker</span><span class="p">&lt;</span><span class="n">LegendaryMissionCategoryPrototype</span><span class="p">&gt;</span> <span class="n">picker</span> <span class="p">=</span> <span class="nf">LegendaryMissionCategoryPicker</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">picker</span><span class="p">.</span><span class="nf">PickRemove</span><span class="p">(</span><span class="k">out</span> <span class="n">LegendaryMissionCategoryPrototype</span> <span class="n">categoryProto</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">List</span><span class="p">&lt;</span><span class="n">PrototypeGuid</span><span class="p">&gt;</span> <span class="n">blacklist</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">categoryProto</span><span class="p">.</span><span class="n">BlacklistLength</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">PrototypeGuid</span> <span class="n">guid</span> <span class="p">=</span> <span class="n">GameDatabase</span><span class="p">.</span><span class="nf">GetPrototypeGuid</span><span class="p">(</span><span class="n">categoryProto</span><span class="p">.</span><span class="n">DataRef</span><span class="p">);</span>
            <span class="n">_legendaryMissionBlacklist</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">guid</span><span class="p">,</span> <span class="k">out</span> <span class="n">blacklist</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">pickedMissionRef</span> <span class="p">=</span> <span class="nf">PickLegendaryMissionForCategory</span><span class="p">(</span><span class="n">categoryProto</span><span class="p">,</span> <span class="n">blacklist</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pickedMissionRef</span> <span class="p">!=</span> <span class="n">PrototypeId</span><span class="p">.</span><span class="n">Invalid</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pickedMissionRef</span> <span class="p">==</span> <span class="n">PrototypeId</span><span class="p">.</span><span class="n">Invalid</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">picker</span> <span class="p">=</span> <span class="nf">LegendaryMissionCategoryPicker</span><span class="p">();</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">picker</span><span class="p">.</span><span class="nf">PickRemove</span><span class="p">(</span><span class="n">LegendaryMissionCategoryPrototype</span> <span class="kt">var</span> <span class="n">categoryProto</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">pickedMissionRef</span> <span class="p">=</span> <span class="nf">PickLegendaryMissionForCategory</span><span class="p">(</span><span class="n">categoryProto</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pickedMissionRef</span> <span class="p">!=</span> <span class="n">PrototypeId</span><span class="p">.</span><span class="n">Invalid</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">pickedMissionRef</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When picking Legendary Missions, one thing that needs to be taken into account is its restriction defined using the <code class="language-plaintext highlighter-rouge">EvalCanStart</code> eval. It uses the same formula for all Legendary Missions that looks like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EvalCanStart = ( ( CharacterLevelProp &gt; 19 ) &amp;&amp; ( CharacterLevelProp &lt; 61 ) )
</code></pre></div></div>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-10/alex-3.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-10/alex-3.png" alt="AlexBond 3" /></a></p>

<p>This ensures that Legendary Missions are unavailable until level 20. However, the game designers did not define separate formulas for each mission, which is why I would get Legendary Missions for chapter 9 at level 20. I wanted to do them as I went through the story, so I had to spend all my credits on rerolling!</p>

<p>In addition to Legendary Missions there are also <em>Daily Missions</em>, and they use a different picking method.</p>

<p>First, the current <code class="language-plaintext highlighter-rouge">CalendarDay</code> is determined, and if it’s larger than the last recorded day, daily missions get rerolled.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">calendarDay</span> <span class="p">=</span> <span class="nf">CalendarDay</span><span class="p">();</span>
<span class="kt">int</span> <span class="n">lastDailyDay</span> <span class="p">=</span> <span class="n">Player</span><span class="p">.</span><span class="n">Properties</span><span class="p">[</span><span class="n">PropertyEnum</span><span class="p">.</span><span class="n">LastDailyMissionCalendarDay</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="n">lastDailyDay</span> <span class="p">&lt;</span> <span class="n">calendarDay</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nf">ResetDailyMissions</span><span class="p">(</span><span class="n">calendarDay</span><span class="p">,</span> <span class="n">lastDailyDay</span><span class="p">);</span>
    <span class="nf">RollDailyMissions</span><span class="p">();</span>
    <span class="n">Player</span><span class="p">.</span><span class="n">Properties</span><span class="p">[</span><span class="n">PropertyEnum</span><span class="p">.</span><span class="n">LastDailyMissionCalendarDay</span><span class="p">]</span> <span class="p">=</span> <span class="n">calendarDay</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As part of the reroll process, the current day of the week is determined, and missions for this day are activated.</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-10/alex-4.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-10/alex-4.jpg" alt="AlexBond 4" /></a></p>

<p>The same happens for <em>Advanced Missions</em>, but with blacklists and two picking passes, similar to Legendary Missions.</p>

<p>But what happens if someone plays at night and waits for the daily reset at midnight? In this case we need a clock: events scheduled using <code class="language-plaintext highlighter-rouge">ScheduleDailyMissionUpdate()</code> check every second whether the current day ended, like a second hand on a clock.</p>

<p>With this taken care of, let’s move onto another fun activity.</p>

<h3 id="danger-room">Danger Room</h3>

<p>The main difficulty with implementing the <em>Danger Room</em> mode is regenerating the same region with different input data.</p>

<p>Here is what the insides of a generator prototype for such region look like:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-10/alex-5.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-10/alex-5.png" alt="AlexBond 5" /></a></p>

<p>The current mode is chosen based on the <code class="language-plaintext highlighter-rouge">EndlessLevel</code> parameter like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">EndlessThemeEntryPrototype</span> <span class="nf">GetEndlessGeneration</span><span class="p">(</span><span class="kt">int</span> <span class="n">randomSeed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">endlessLevel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">endlessLevelsTotal</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">EndlessThemes</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">endlessLevel</span> <span class="p">&lt;=</span> <span class="m">0</span> <span class="p">||</span> <span class="n">endlessLevelsTotal</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">totalThemes</span> <span class="p">=</span> <span class="n">EndlessThemes</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">randomIndex</span> <span class="p">=</span> <span class="n">randomSeed</span> <span class="p">%</span> <span class="n">totalThemes</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">endlessOffset</span> <span class="p">=</span> <span class="p">(</span><span class="n">endlessLevel</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="p">/</span> <span class="n">endlessLevelsTotal</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">selectedIndex</span> <span class="p">=</span> <span class="p">(</span><span class="n">randomIndex</span> <span class="p">+</span> <span class="n">endlessOffset</span><span class="p">)</span> <span class="p">%</span> <span class="n">totalThemes</span><span class="p">;</span>

    <span class="n">EndlessThemePrototype</span> <span class="n">EndlessTheme</span> <span class="p">=</span> <span class="n">EndlessThemes</span><span class="p">[</span><span class="n">selectedIndex</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">levelInTheme</span> <span class="p">=</span> <span class="n">endlessLevel</span> <span class="p">%</span> <span class="n">endlessLevelsTotal</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">levelInTheme</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">EndlessTheme</span><span class="p">.</span><span class="n">TreasureRoom</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">levelInTheme</span> <span class="p">==</span> <span class="n">endlessLevelsTotal</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">EndlessTheme</span><span class="p">.</span><span class="n">Boss</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">EndlessTheme</span><span class="p">.</span><span class="n">Normal</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For the initial region <code class="language-plaintext highlighter-rouge">EndlessLevel = 1</code>, so this function will return the <code class="language-plaintext highlighter-rouge">Normal</code> mode.</p>

<p>Next, in the <code class="language-plaintext highlighter-rouge">Normal</code> mode a random <code class="language-plaintext highlighter-rouge">Entry</code> is picked from <code class="language-plaintext highlighter-rouge">Challenges</code>, and a mission approprite for our difficulty <code class="language-plaintext highlighter-rouge">Tier</code> is started.</p>

<p>The transfer of all of these settings and affixes from a <code class="language-plaintext highlighter-rouge">DangerRoomScenario</code> item to a region goes through the following sequence:</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">DangerRoomScenario</code> – <code class="language-plaintext highlighter-rouge">Transition</code> – <code class="language-plaintext highlighter-rouge">RegionContext</code> – <code class="language-plaintext highlighter-rouge">RegionSettings</code> – <code class="language-plaintext highlighter-rouge">Region</code></p>
</blockquote>

<p>When the first <code class="language-plaintext highlighter-rouge">EndlessLevel</code> is cleared, it is incremented by one, and the settings sequence looks like this:</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">OldRegion</code> - <code class="language-plaintext highlighter-rouge">RegionContext</code> - <code class="language-plaintext highlighter-rouge">RegionSettings</code> - <code class="language-plaintext highlighter-rouge">Region</code></p>
</blockquote>

<p>All of these settings make the region transfer more complex. But there is more.</p>

<p>When a Danger Room mission is cleared, the client needs to receive an invitation to move to the next level. It looks like this:</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2024-10/alex-6.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-10/alex-6.jpg" alt="AlexBond 6" /></a>
</center>

<p>Implementing it was not easy at all. To create this dialog, we needed to implement a lot of classes, and the result is almost as complex as <code class="language-plaintext highlighter-rouge">CreateDialogA</code> in the Windows API:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">CreateDialog</span><span class="p">(</span><span class="kt">ulong</span> <span class="n">playerGuid</span><span class="p">,</span> <span class="n">DialogPrototype</span> <span class="n">dialogProto</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_dialogs</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">playerGuid</span><span class="p">,</span> <span class="k">out</span> <span class="n">GameDialogInstance</span> <span class="n">dialog</span><span class="p">)</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">dialog</span> <span class="p">=</span> <span class="n">Game</span><span class="p">.</span><span class="n">GameDialogManager</span><span class="p">.</span><span class="nf">CreateInstance</span><span class="p">(</span><span class="n">playerGuid</span><span class="p">);</span>
        <span class="n">dialog</span><span class="p">.</span><span class="n">OnResponse</span> <span class="p">=</span> <span class="n">_onResponseAction</span><span class="p">;</span>
        <span class="n">dialog</span><span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">LocaleString</span> <span class="p">=</span> <span class="n">dialogProto</span><span class="p">.</span><span class="n">Text</span><span class="p">;</span>
        <span class="n">dialog</span><span class="p">.</span><span class="n">Options</span> <span class="p">=</span> <span class="n">DialogOptionEnum</span><span class="p">.</span><span class="n">ScreenBottom</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dialogProto</span><span class="p">.</span><span class="n">Button1</span> <span class="p">!=</span> <span class="n">LocaleStringId</span><span class="p">.</span><span class="n">Blank</span><span class="p">)</span>
            <span class="n">dialog</span><span class="p">.</span><span class="nf">AddButton</span><span class="p">(</span><span class="n">GameDialogResultEnum</span><span class="p">.</span><span class="n">eGDR_Option1</span><span class="p">,</span> <span class="n">dialogProto</span><span class="p">.</span><span class="n">Button1</span><span class="p">,</span> <span class="n">dialogProto</span><span class="p">.</span><span class="n">Button1Style</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dialogProto</span><span class="p">.</span><span class="n">Button2</span> <span class="p">!=</span> <span class="n">LocaleStringId</span><span class="p">.</span><span class="n">Blank</span><span class="p">)</span>
            <span class="n">dialog</span><span class="p">.</span><span class="nf">AddButton</span><span class="p">(</span><span class="n">GameDialogResultEnum</span><span class="p">.</span><span class="n">eGDR_Option2</span><span class="p">,</span> <span class="n">dialogProto</span><span class="p">.</span><span class="n">Button2</span><span class="p">,</span> <span class="n">dialogProto</span><span class="p">.</span><span class="n">Button2Style</span><span class="p">);</span>

        <span class="n">_dialogs</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">playerGuid</span><span class="p">,</span> <span class="n">dialog</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dialog</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="n">Game</span><span class="p">.</span><span class="n">GameDialogManager</span><span class="p">.</span><span class="nf">ShowDialog</span><span class="p">(</span><span class="n">dialog</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here is how it works: finishing a mission initiates <code class="language-plaintext highlighter-rouge">MetaStateShutdown</code> and creates a dialog that is relayed to the client through <code class="language-plaintext highlighter-rouge">NetMessagePostDialogToClient</code>. The player presses the dialog button, and the client responds with <code class="language-plaintext highlighter-rouge">NetMessageDialogResult</code> that triggers the <code class="language-plaintext highlighter-rouge">OnDialogResult()</code> event on the server. <code class="language-plaintext highlighter-rouge">OnDialogResult()</code> calls <code class="language-plaintext highlighter-rouge">MetaStateShutdown.OnResponse()</code> that teleports the player to the next <code class="language-plaintext highlighter-rouge">EndlessLevel</code> region.</p>

<p>As you can see, a simple button has a not-so-simple implementation. And there is also a case for when there are multiple players in a party, and each one has to confirm for a teleport to happen.</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2024-10/alex-7.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-10/alex-7.jpg" alt="AlexBond 7" /></a>
</center>

<p>To get the mode to a feature-complete state we still have timer widgets to implement with three <code class="language-plaintext highlighter-rouge">MetaStateScoringEventTimer</code> states: <code class="language-plaintext highlighter-rouge">Start</code>, <code class="language-plaintext highlighter-rouge">Stop</code>, and <code class="language-plaintext highlighter-rouge">End</code>. However, even at this stage Danger Room regions can be completed without any significant issues.</p>

<p>Now you should have a better idea about what I have been working on this month. There is still a lot more work to do, see you in future reports!</p>

<hr />

<p>That’s all we have for you today. See you next month!</p>]]></content><author><name></name></author><category term="blog" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">MHServerEmu Progress Report: September 2024</title><link href="https://crypto137.github.io/MHServerEmu/blog/2024/09/30/progress-report-september-2024.html" rel="alternate" type="text/html" title="MHServerEmu Progress Report: September 2024" /><published>2024-09-30T14:35:00+03:00</published><updated>2024-09-30T14:35:00+03:00</updated><id>https://crypto137.github.io/MHServerEmu/blog/2024/09/30/progress-report-september-2024</id><content type="html" xml:base="https://crypto137.github.io/MHServerEmu/blog/2024/09/30/progress-report-september-2024.html"><![CDATA[<!--more-->

<p><img src="/MHServerEmu/assets/blog/progress-report/2024-09/header.jpg" alt="MHServerEmu Progress Report - September 2024" /></p>

<p>You know the drill, it’s progress report time.</p>

<h2 id="wtb-godly-plate-of-the-whale">WTB Godly Plate of the Whale</h2>

<p>This month we released our third stable version, <a href="https://github.com/Crypto137/MHServerEmu/releases/tag/0.3.0">0.3.0</a>, and immediately I started working on features for 0.4.0, which is currently planned for early December.</p>

<p>The first thing on my “to do” list was implementing item affix generation. When I did the loot table implementation <a href="/MHServerEmu/blog/2024/07/31/progress-report-july-2024.html">back in July</a>, I already knew that it would not be difficult to get affix generation up and running with what we already had. However, I wanted to wait until we had persistence working: there is no worse feeling in a loot game than getting a good drop and knowing you are going to lose it as soon as you log out.</p>

<p>Here is an overview of how affix generation works. After the <code class="language-plaintext highlighter-rouge">ItemResolver</code> goes through a loot table, you end up with an <code class="language-plaintext highlighter-rouge">ItemSpec</code> that has the item’s base type, quality, and level, but no affixes. This <code class="language-plaintext highlighter-rouge">ItemSpec</code> is passed to a function called <code class="language-plaintext highlighter-rouge">LootUtilities.UpdateAffixes()</code> that does the real magic.</p>

<p>Based mainly on the item’s base type and level, the game rolls a number of <em>category</em> affixes and <em>position</em> affixes.</p>

<p>Categories are data-defined pools, which in practice are primarily used for “white” affixes you see on gear, like damage rating and health.  Theoretically it should be possible to add more affix categories by changing game data, although you will have to modify both the server and the client <code class="language-plaintext highlighter-rouge">.sip</code> files.</p>

<p>There are 19 affix positions, and they are hardcoded into the game: unlike categories, you cannot add or remove new affix positions without recompiling the client. Available positions include things that are typical for games in this genre, like prefixes and suffixes, but also more specialized options, such as PetTech-specific affixes. Here is a full list of affix positions that exist in version 1.52:</p>

<table>
  <thead>
    <tr>
      <th>Prefix</th>
      <th>Unique</th>
      <th>PetTech1</th>
      <th>RegionAffix</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Suffix</strong></td>
      <td><strong>Blessing</strong></td>
      <td><strong>PetTech2</strong></td>
      <td><strong>Socket1</strong></td>
    </tr>
    <tr>
      <td><strong>Visual</strong></td>
      <td><strong>Runeword</strong></td>
      <td><strong>PetTech3</strong></td>
      <td><strong>Socket2</strong></td>
    </tr>
    <tr>
      <td><strong>Ultimate</strong></td>
      <td><strong>TeamUp</strong></td>
      <td><strong>PetTech4</strong></td>
      <td><strong>Socket3</strong></td>
    </tr>
    <tr>
      <td><strong>Cosmic</strong></td>
      <td><strong>Metadata</strong></td>
      <td><strong>PetTech5</strong></td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>For each affix roll a pool is formed based on various filters, including compatibility with the base type, keywords, categories, and the region the affix is being rolled in. An affix is then picked from this pool, checking for duplicates that are already attached to this <code class="language-plaintext highlighter-rouge">ItemSpec</code> if needed. Some affixes also require an additional parameter, referred to as its <em>scope</em>: the most typical example of this are affixes that affect specific powers or groups of powers. For an affix like <code class="language-plaintext highlighter-rouge">+3 to Repulsor Barrage</code> the scope would be a reference to the prototype for the <code class="language-plaintext highlighter-rouge">Repulsor Barrage</code> power, while for <code class="language-plaintext highlighter-rouge">+10% Area Power Damage</code> it would be a reference to the prototype for the <code class="language-plaintext highlighter-rouge">Area</code> keyword. The scope system is a good example of how surface-level many BUE changes actually were: although power ranks were “removed”, the entire backend for them still exists and is in use, with all powers simply being set to rank 1 and rebalanced accordingly.</p>

<p>With affixes picked and added to the <code class="language-plaintext highlighter-rouge">ItemSpec</code>, it is now time to apply it to an <code class="language-plaintext highlighter-rouge">Item</code> entity instance. This is when the actual rolling of values happens. The funny thing about this process is that it is done in parallel by the server and the client: rather than sending a fully rolled item, the server sends the client a serialized <code class="language-plaintext highlighter-rouge">ItemSpec</code> that also contains a seed for the random number generator. Because the input data and the algorithm are the same between the two of them, they both generate the same item independently from one another. While this means we have all the logic for the rolling process client-side, any deviation from it also causes desynchronization issues. In addition to that, you can’t modify most of the static item data, such as affix ranges, server-side without also having to change the client.</p>

<p>In addition to randomly picked affixes, the prototypes for base types can also have <em>built-in affixes</em>, and <em>built-in properties</em>. The vast majority of fixed stat items you see in the game, like uniques and artifacts, are implemented using built-in properties. The core difference between them is that affix properties are attached to the item as child property collections and can be removed, while built-in properties are written right into the item’s own property collection.</p>

<p>Implementing built-in properties initially caused unexpected game instances crashes. Turns out, the data contains mistakes made by designers, and in some cases minimum and maximum ranges are mixed up. Generally it’s negative decimal numbers, like <code class="language-plaintext highlighter-rouge">-0.1</code> and <code class="language-plaintext highlighter-rouge">-0.2</code>, but there are also cases that look like this:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-09/unique-range.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/unique-range.png" alt="Unique Range" /></a></p>

<p>Here is the default implementation of <code class="language-plaintext highlighter-rouge">Math.Clamp()</code> in C#:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">Clamp</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">min</span> <span class="p">&gt;</span> <span class="n">max</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">ThrowMinMaxException</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">value</span> <span class="p">&lt;</span> <span class="n">min</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">min</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">value</span> <span class="p">&gt;</span> <span class="n">max</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">max</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So when you try to clamp a value to a mixed up range like this, an exception is thrown, which leads to a crash. We cannot fix the issue with the data without also modifying the client, so what we have to do here is remove the <code class="language-plaintext highlighter-rouge">min &gt; max</code> check to process malformed data in the same way as the client, or we are going to get different rolls server-side and end up with desync issues.</p>

<p>With affixes actually rolling and applying, it was now time to take another look at combat calculations. The version of the game we are currently working on uses a form of level scaling called dynamic combat level (DCL). Surprisingly enough, it is actually not that complicated compared to most other systems in this game: all damage players deal to mobs and receive from mobs is scaled as if the mob was the same level as the player (with upper and lower bounds for this scaling defined by the region). Enemy health never actually changes, and the illusion of enemies scaling up or down to player level is created by sending fake damage numbers to the client. So if you would deal <code class="language-plaintext highlighter-rouge">100</code>  damage to a target of your level, it gets scaled to <code class="language-plaintext highlighter-rouge">1000</code> to match the target’s higher level, but the client receives and displays the number <code class="language-plaintext highlighter-rouge">100</code>.</p>

<p>It would not be Marvel Heroes if there was no jank at all though. When the DCL system was initially being implemented, it was made in a way where it could be turned off. For this reason all mobs in the game have two health curves: the default one and the “new” DCL one. The main difference between them is that while default curves have separate baseline scaling for regular mobs and bosses, the new DCL curves are unified, and the difference is achieved by applying external health multipliers. In the vast majority of cases this multiplier comes from the mob’s rank (<code class="language-plaintext highlighter-rouge">Popcorn</code>, <code class="language-plaintext highlighter-rouge">Champion</code>, <code class="language-plaintext highlighter-rouge">Elite</code>, <code class="language-plaintext highlighter-rouge">MiniBoss</code>, <code class="language-plaintext highlighter-rouge">Boss</code>), but sometimes it is baked into the mob’s prototype itself. This was the reason why some mobs, like Doop, were nearly unkillable before: they were using their default health curves that had baseline scaling <em>and</em> they also had a crazy high multiplier bonus that was applied on top of that.</p>

<p>With players having items with stats, the DCL system being mostly implemented, and characters using proper health curves with multipliers applied to them, everything in the game now has a much more authentic feel to it, with proper contrast between weaker popcorn mobs and tougher elites. There is still lots and lots of work to do on this front, but I feel we are in a much better place balance-wise now.</p>

<h2 id="and-this-is-to-go-even-further-beyond">And This… Is to Go Even Further Beyond!</h2>

<p>As MHServerEmu matures and more features are implemented, the workload the server has to do increases. Even 0.3.0, with its basic combat and loot generation, already starts coming apart at the seams with high enough load, and with missions and metagames coming in 0.4.0, this month I decided it was time to take a good look at what we can do to optimize the server.</p>

<h3 id="round-1-memory-management">Round 1: Memory Management</h3>

<p>The core difference between our server implementation and the original game is that MHServerEmu is written in C#, which compiles to bytecode and has automatic memory management, while the client is C++ compiled to native code with manual memory management. The biggest advantage of using C# for this project is that it’s great for rapid iteration with fast build times and features like hot reload, and more often than not <em>it just works</em>. However, there is an inherent loss of control compared to C++, the most critical point being how memory is managed.</p>

<p>Both languages use the concepts of the stack and the heap for managing memory. I will not go into too much detail on this, as there are countless other resources that go as deep into this as you will ever want, and do a much better job at it than I can, but here is the gist of it:</p>

<ul>
  <li>
    <p>Stack-allocated data is cleared automatically after you leave the block of code that contains the allocation. Working with the stack is very fast, but it has relatively small size (1 MB by default in C#), and if you exceed this limit, you will get the infamous stack overflow error. So generally you want to use this for smaller temporary data with short lifespans.</p>
  </li>
  <li>
    <p>Anything allocated on the heap needs to be cleaned up at some point. In C++ this can be done in various ways, while C# does it automatically using its <em>garbage collector</em> (GC). Working with the heap is much slower than the stack, but it can handle significantly larger volumes of data with longer lifespans.</p>
  </li>
  <li>
    <p>In C++ pretty much anything can be allocated either on the stack or on the heap. C# restricts this by dividing types into <em>value types</em> and <em>reference types</em>: there are exceptions and edge cases, but the general idea is that reference types cannot be allocated on the stack, and there are cases when value types have to be wrapped in reference types, which forces them to be allocated on the heap. This wrapping process is called <em>boxing</em>.</p>
  </li>
</ul>

<p>As a result of this, in C++ if you are not careful with your memory management, you will end up continuously allocating more memory than you free, eventually completely running out of it. This is what is commonly referred to as a <em>memory leak</em>. In languages like C# it’s a lot harder to get a memory leak like this, but it’s still very easy to unintentionally end up doing too many heap allocations, increasing <em>garbage collection pressure</em>, which manifests as unpredictable stuttering, as the garbage collector periodically suspends all threads to do its work. This is made worse by the fact that C# has limited tools for stack allocations, and some features end up allocating garbage behind the scenes.</p>

<p>While Marvel Heroes has a relatively loose simulation time step of 50 ms, there is also a lot of stuff going on, so the amount of garbage you generate can get very out of hand very fast. Here are some examples of the issues I have recently identified and fixed.</p>

<h4 id="arrays">Arrays</h4>

<p>By default, arrays in C# are reference types. This means when you create a new array like this…</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">1024</span><span class="p">];</span>
</code></pre></div></div>

<p>…you are allocating 1024 bytes on the heap that the garbage collector will have to reclaim at some point. This is not too bad when it’s done every once in a while, but what if you are doing this tens of thousands of times per second?</p>

<p>As I was profiling our memory allocations, I discovered that we had literally millions of <code class="language-plaintext highlighter-rouge">double[]</code> allocations happening every minute. The culprit wasn’t even our own code: we are using a third party library that implements <a href="https://www.cs.cmu.edu/~quake/robust.html">fast robust predicates for computational geometry</a>, which is a way of quickly testing points in space with a high degree of accuracy. The original implementation is <a href="https://www.cs.cmu.edu/afs/cs/project/quake/public/code/predicates.c">written in C</a>, and instead of adapting it to C# ourselves, we used <a href="https://github.com/modios/robust-predicates">an existing port</a>.</p>

<p>However, as I looked at the code, I started seeing parts like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">double</span><span class="p">[]</span> <span class="n">finswap</span><span class="p">;</span>
<span class="kt">double</span><span class="p">[]</span> <span class="n">temp16a</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="m">16</span><span class="p">];</span>
<span class="kt">double</span><span class="p">[]</span> <span class="n">temp32a</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="m">32</span><span class="p">];</span>
<span class="kt">double</span><span class="p">[]</span> <span class="n">temp16b</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="m">16</span><span class="p">];</span>
<span class="kt">double</span><span class="p">[]</span> <span class="n">temp32b</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="m">32</span><span class="p">];</span>
<span class="kt">double</span><span class="p">[]</span> <span class="n">temp16c</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="m">16</span><span class="p">];</span>
<span class="kt">double</span><span class="p">[]</span> <span class="n">temp48</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="m">48</span><span class="p">];</span>
<span class="kt">double</span><span class="p">[]</span> <span class="n">axtbc</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="m">8</span><span class="p">];</span>
</code></pre></div></div>

<p>These tests are used extensively in the game for updating the navi system, and they can cause millions of heap allocations in just a few minutes of playing. Thankfully, this is temporary data that gets thrown away as soon the function finishes, so we can make use of one of the optimization tools available in C# - <code class="language-plaintext highlighter-rouge">Span&lt;T&gt;</code>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Span</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">finswap</span> <span class="p">=</span> <span class="k">stackalloc</span> <span class="kt">double</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
<span class="n">Span</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">temp16a</span> <span class="p">=</span> <span class="k">stackalloc</span> <span class="kt">double</span><span class="p">[</span><span class="m">16</span><span class="p">];</span>
<span class="n">Span</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">temp32a</span> <span class="p">=</span> <span class="k">stackalloc</span> <span class="kt">double</span><span class="p">[</span><span class="m">32</span><span class="p">];</span>
<span class="n">Span</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">temp16b</span> <span class="p">=</span> <span class="k">stackalloc</span> <span class="kt">double</span><span class="p">[</span><span class="m">16</span><span class="p">];</span>
<span class="n">Span</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">temp32b</span> <span class="p">=</span> <span class="k">stackalloc</span> <span class="kt">double</span><span class="p">[</span><span class="m">32</span><span class="p">];</span>
<span class="n">Span</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">temp16c</span> <span class="p">=</span> <span class="k">stackalloc</span> <span class="kt">double</span><span class="p">[</span><span class="m">16</span><span class="p">];</span>
<span class="n">Span</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">temp48</span> <span class="p">=</span> <span class="k">stackalloc</span> <span class="kt">double</span><span class="p">[</span><span class="m">48</span><span class="p">];</span>
<span class="n">Span</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">axtbc</span> <span class="p">=</span> <span class="k">stackalloc</span> <span class="kt">double</span><span class="p">[</span><span class="m">8</span><span class="p">];</span>
</code></pre></div></div>

<p>Doing it this way we break the “rules” of C# arrays a bit and allocate them on the stack. Behind the scenes this is actually a way of writing unsafe code that looks like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">double</span><span class="p">*</span> <span class="n">temp16aPtr</span> <span class="p">=</span> <span class="k">stackalloc</span> <span class="kt">double</span><span class="p">[</span><span class="m">16</span><span class="p">];</span>
<span class="n">Span</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">temp16a</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="n">temp16aPtr</span><span class="p">);</span>
</code></pre></div></div>

<p>Spans are essentially highly limited pointers that allow us to use some C# features that had been traditionally restricted to unsafe code, such as the <code class="language-plaintext highlighter-rouge">stackalloc</code> keyword. They are very useful for situations like this, although with an external library it may be worth rewriting it in fully unsafe code to get more performance out of it in the future. Our span-based fork of this robust predicates implementation is available on <a href="https://github.com/Crypto137/robust-predicates">GitHub</a> for everyone to use.</p>

<p>Replacing arrays with spans works for smaller arrays, but what about those that can potentially exceed the 1 MB stack limit or need to persist for longer periods of time? The best example of this are <code class="language-plaintext highlighter-rouge">byte[]</code> buffers used for serializing network messages and player data. This is where another useful optimization tool comes in: <code class="language-plaintext highlighter-rouge">ArrayPool&lt;T&gt;</code>. Instead of allocating a new buffer each time like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">size</span> <span class="p">=</span> <span class="n">packet</span><span class="p">.</span><span class="n">SerializedSize</span><span class="p">;</span>
<span class="kt">byte</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
<span class="n">packet</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="nf">Send</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</code></pre></div></div>

<p>We can “rent” and later reuse the same buffers:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">size</span> <span class="p">=</span> <span class="n">packet</span><span class="p">.</span><span class="n">SerializedSize</span><span class="p">;</span>
<span class="kt">byte</span> <span class="n">buffer</span> <span class="p">=</span> <span class="n">ArrayPool</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;.</span><span class="n">Shared</span><span class="p">.</span><span class="nf">Rent</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<span class="n">packet</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="nf">Send</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="n">ArrayPool</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;.</span><span class="n">Shared</span><span class="p">.</span><span class="nf">Return</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</code></pre></div></div>

<p>There are certain limitations to using <code class="language-plaintext highlighter-rouge">ArrayPool&lt;T&gt;</code>: for example, you will most likely get a buffer larger than what you requested, and you will have to handle this yourself. However, it works very well for cases like high-volume packet serialization.</p>

<p>This was a very simple example where integrating pooling was just two lines of code. Unfortunately, things are not always this easy. For client compatibility reasons we are using <code class="language-plaintext highlighter-rouge">protobuf-csharp-port</code>, a legacy C# implementation of Google’s Protocol Buffers (protobufs) that was last updated in 2015. Gazillion utilized certain protobuf encoding functions directly for their custom archive format, which is used for high-frequency messages, like entity creation, locomotion updates, and power activations.</p>

<p>These encoding functions can be accessed in <code class="language-plaintext highlighter-rouge">protobuf-csharp-port</code> using the <code class="language-plaintext highlighter-rouge">CodedOutputStream</code> class. <code class="language-plaintext highlighter-rouge">CodedOutputStream</code> is a wrapper for various <code class="language-plaintext highlighter-rouge">Stream</code> implementations, like a protobuf-specific version of <code class="language-plaintext highlighter-rouge">BinaryWriter</code>. You can create <code class="language-plaintext highlighter-rouge">CodedOutputStream</code> instances using various overloads of the <code class="language-plaintext highlighter-rouge">CreateInstance()</code> factory method, but there is a problem: you can provide your own fixed-size buffer to write to directly, or you can provide a stream and specify the size of the write buffer. However, the constructor for <code class="language-plaintext highlighter-rouge">CodedOutputStream</code> is <code class="language-plaintext highlighter-rouge">private</code>, and there is no <code class="language-plaintext highlighter-rouge">CreateInstance()</code> overload that accepts both a stream and a buffer:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="nf">CodedOutputStream</span><span class="p">(</span><span class="n">Stream</span> <span class="n">output</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">output</span> <span class="p">=</span> <span class="n">output</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">buffer</span> <span class="p">=</span> <span class="n">buffer</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">limit</span> <span class="p">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="n">CodedOutputStream</span> <span class="nf">CreateInstance</span><span class="p">(</span><span class="n">Stream</span> <span class="n">output</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufferSize</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">CodedOutputStream</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">bufferSize</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The “normal” thing to do here would be either to accept that we will waste allocations on this, or to just bite the bullet and start modifying <code class="language-plaintext highlighter-rouge">protobuf-csharp-port</code> for our needs.  However, I am stubborn, and I felt like doing the latter would be like opening the Pandora’s box: we may end up doing it at some point, but now was not the right time. Modern problems require modern solutions, and here is the one I came up with:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">CodedOutputStreamEx</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Stream</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[],</span> <span class="n">CodedOutputStream</span><span class="p">&gt;</span> <span class="n">CreateInstanceDelegate</span><span class="p">;</span>

    <span class="k">static</span> <span class="nf">CodedOutputStreamEx</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Type</span><span class="p">[]</span> <span class="n">argTypes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Type</span><span class="p">[]</span> <span class="p">{</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Stream</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">byte</span><span class="p">[])</span> <span class="p">};</span>

        <span class="n">DynamicMethod</span> <span class="n">dm</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="s">"CreateInstance"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CodedOutputStream</span><span class="p">),</span> <span class="n">argTypes</span><span class="p">);</span>
        <span class="n">ILGenerator</span> <span class="n">il</span> <span class="p">=</span> <span class="n">dm</span><span class="p">.</span><span class="nf">GetILGenerator</span><span class="p">();</span>

        <span class="n">il</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg_0</span><span class="p">);</span>
        <span class="n">il</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg_1</span><span class="p">);</span>
        <span class="n">il</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Newobj</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CodedOutputStream</span><span class="p">).</span><span class="nf">GetConstructor</span><span class="p">(</span><span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">,</span> <span class="n">argTypes</span><span class="p">));</span>
        <span class="n">il</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ret</span><span class="p">);</span>

        <span class="n">CreateInstanceDelegate</span> <span class="p">=</span> <span class="n">dm</span><span class="p">.</span><span class="n">CreateDelegate</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Stream</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[],</span> <span class="n">CodedOutputStream</span><span class="p">&gt;&gt;();</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="nf">MethodImpl</span><span class="p">(</span><span class="n">MethodImplOptions</span><span class="p">.</span><span class="n">AggressiveInlining</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">CodedOutputStream</span> <span class="nf">CreateInstance</span><span class="p">(</span><span class="n">Stream</span> <span class="n">stream</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nf">CreateInstanceDelegate</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here we are using <code class="language-plaintext highlighter-rouge">System.Reflection.Emit</code> to pretty much generate a new <code class="language-plaintext highlighter-rouge">CodedOutputStream.CreateInstance()</code> overload at runtime, which we then access via a cached delegate. Is it an overengineered hack? Yes. Does it work? Also yes.</p>

<p>With these targeted applications of <code class="language-plaintext highlighter-rouge">Span&lt;T&gt;</code> and <code class="language-plaintext highlighter-rouge">ArrayPool&lt;T&gt;</code> we were able to get arrays under control and eliminate literally millions of unnecessary heap allocations. Nevertheless, this was just one stop in my optimization journey.</p>

<h4 id="boxing">Boxing</h4>

<p>Boxing is what occurs in C# when a value type is cast to a reference type. Here is the simplest example of this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="k">value</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
<span class="kt">object</span> <span class="n">boxedValue</span> <span class="p">=</span> <span class="p">(</span><span class="kt">object</span><span class="p">)</span><span class="k">value</span><span class="p">;</span>
</code></pre></div></div>

<p>Because <code class="language-plaintext highlighter-rouge">int</code> is a value type and <code class="language-plaintext highlighter-rouge">object</code> is a reference type, and reference types cannot exist on the stack in C#, this conversion requires allocating an object instance on the heap that will contain our <code class="language-plaintext highlighter-rouge">value</code>.</p>

<p>In a simple example like this boxing is clear to see if you know about value and reference types, but some of the “automagical” C# features can cause unintentional boxing and heap allocations. One common pitfall for this are interfaces: interfaces are inherently reference types, so when a <code class="language-plaintext highlighter-rouge">struct</code>, a value type, implements an interface like <code class="language-plaintext highlighter-rouge">IEnumerator</code>, and is then cast to an instance of this interface, it will end up being boxed.</p>

<p>Here is an example of a very simplified wrapper class that implements the <code class="language-plaintext highlighter-rouge">IEnumerable</code> interface:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">PowerCollection</span> <span class="p">:</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Power</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Power</span><span class="p">&gt;</span> <span class="n">_powers</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">Power</span><span class="p">&gt;</span> <span class="nf">GetEnumerator</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_powers</span><span class="p">.</span><span class="nf">GetEnumerator</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// Legacy non-generic version of GetEnumerator() required by IEnumerable here</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When you have it like this, you can very conveniently iterate all <code class="language-plaintext highlighter-rouge">Power</code> instances in your <code class="language-plaintext highlighter-rouge">PowerCollection</code> in a <code class="language-plaintext highlighter-rouge">foreach</code> loop:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">foreach</span> <span class="p">(</span><span class="n">Power</span> <span class="n">power</span> <span class="k">in</span> <span class="n">PowerCollection</span><span class="p">)</span>
    <span class="n">power</span><span class="p">.</span><span class="nf">EndPower</span><span class="p">();</span>
</code></pre></div></div>

<p>Here is a problem though: <code class="language-plaintext highlighter-rouge">List&lt;T&gt;</code> uses a struct-based enumerator to avoid heap allocations, but when you iterate like this, here is what is actually happening behind the scenes:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="p">(</span><span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">Power</span><span class="p">&gt;</span> <span class="n">enumerator</span> <span class="p">=</span> <span class="n">PowerCollection</span><span class="p">.</span><span class="nf">GetEnumerator</span><span class="p">())</span>
<span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="nf">MoveNext</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">Power</span> <span class="n">power</span> <span class="p">=</span> <span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>
        <span class="n">power</span><span class="p">.</span><span class="nf">EndPower</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As a result, your <code class="language-plaintext highlighter-rouge">List&lt;T&gt;.Enumerator</code> struct is cast to <code class="language-plaintext highlighter-rouge">IEnumerator</code> and boxed. You end up doing completely unnecessary heap allocations out of nowhere, and if you are iterating hundreds or even thousands of times per second, it can really add up.</p>

<p>The solution is to add a separate <code class="language-plaintext highlighter-rouge">GetEnumerator()</code> implementation for your wrapper classes that returns a concrete enumerator type:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">PowerCollection</span> <span class="p">:</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Power</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Power</span><span class="p">&gt;</span> <span class="n">_powers</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Power</span><span class="p">&gt;.</span><span class="n">Enumerator</span> <span class="nf">GetEnumerator</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_powers</span><span class="p">.</span><span class="nf">GetEnumerator</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">Power</span><span class="p">&gt;</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Power</span><span class="p">&gt;.</span><span class="nf">GetEnumerator</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_powers</span><span class="p">.</span><span class="nf">GetEnumerator</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// Legacy non-generic version of GetEnumerator() required by IEnumerable here</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This way you avoid boxing when doing a simple <code class="language-plaintext highlighter-rouge">foreach</code> iteration, but also still have access to various <code class="language-plaintext highlighter-rouge">IEnumerable</code> extension methods, like <code class="language-plaintext highlighter-rouge">Select()</code> and <code class="language-plaintext highlighter-rouge">Where()</code>.</p>

<h4 id="yield-return">yield return</h4>

<p>Related to iteration and boxing is another source of garbage: <code class="language-plaintext highlighter-rouge">yield return</code>. Looking again at the example above, it can also be implemented like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">PowerCollection</span> <span class="p">:</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Power</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Power</span><span class="p">&gt;</span> <span class="n">_powers</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">Power</span><span class="p">&gt;</span> <span class="nf">GetEnumerator</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="n">Power</span> <span class="n">power</span> <span class="k">in</span> <span class="n">_powers</span><span class="p">)</span>
            <span class="k">yield</span> <span class="k">return</span> <span class="n">power</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Legacy non-generic version of GetEnumerator() required by IEnumerable here</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is a quick and dirty way of implementing a custom iterator, which can be great for getting complex filtered iteration up and running. However, behind the scenes this actually creates a state machine object that causes more heap allocations. So to optimize this, I went back and replaced some of our <code class="language-plaintext highlighter-rouge">yield return</code> filtered iteration implementations with struct-based <code class="language-plaintext highlighter-rouge">IEnumerator</code> implementations. It is a more verbose way of doing things, but it prevents more unnecessary garbage.</p>

<h4 id="delegates">Delegates</h4>

<p>Delegates in C# are objects that encapsulate function pointers. They are reference types, which means more heap allocations. And sometimes they happen when you do not expect it.</p>

<p>A good of example of this is one of the iteration methods of <code class="language-plaintext highlighter-rouge">PropertyCollection</code>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">PropertyList</span><span class="p">.</span><span class="n">Iterator</span> <span class="nf">IteratePropertyRange</span><span class="p">(</span><span class="n">PropertyEnumFilter</span><span class="p">.</span><span class="n">Func</span> <span class="n">filterFunc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_aggregateList</span><span class="p">.</span><span class="nf">IteratePropertyRange</span><span class="p">(</span><span class="n">filterFunc</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This takes a filter delegate defined in the <code class="language-plaintext highlighter-rouge">PropertyEnumFilter</code> static class as an argument:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">PropertyEnumFilter</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">delegate</span> <span class="kt">bool</span> <span class="nf">Func</span><span class="p">(</span><span class="n">PropertyEnum</span> <span class="n">propertyEnum</span><span class="p">);</span>

    <span class="c1">// A filter function that skips properties that don't have a valid aggregation method</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">Agg</span><span class="p">(</span><span class="n">PropertyEnum</span> <span class="n">propertyEnum</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">PropertyInfo</span> <span class="n">info</span> <span class="p">=</span> <span class="n">GameDatabase</span><span class="p">.</span><span class="n">PropertyInfoTable</span><span class="p">.</span><span class="nf">LookupPropertyInfo</span><span class="p">(</span><span class="n">propertyEnum</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">info</span><span class="p">.</span><span class="n">Prototype</span><span class="p">.</span><span class="n">AggMethod</span> <span class="p">!=</span> <span class="n">AggregationMethod</span><span class="p">.</span><span class="n">None</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The most intuitive way of using it looks like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">kvp</span> <span class="k">in</span> <span class="n">Properties</span><span class="p">.</span><span class="nf">IteratePropertyRange</span><span class="p">(</span><span class="n">PropertyEnumFilter</span><span class="p">.</span><span class="n">Agg</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// Do something with properties</span>
<span class="p">}</span>
</code></pre></div></div>

<p>But here is yet another pitfall: this</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PropertyEnumFilter</span><span class="p">.</span><span class="n">Func</span> <span class="n">aggFunc</span> <span class="p">=</span> <span class="n">PropertyEnumFilter</span><span class="p">.</span><span class="n">Agg</span><span class="p">;</span>
</code></pre></div></div>

<p>is actually a short way of writing this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PropertyEnumFilter</span><span class="p">.</span><span class="n">Func</span> <span class="n">aggFunc</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="n">PropertyEnumFilter</span><span class="p">.</span><span class="n">Agg</span><span class="p">);</span>
</code></pre></div></div>

<p>So every time you pass a function as an argument, you end up instantiating an extra delegate. The garbage-free way of doing this actually looks like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">PropertyEnumFilter</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">delegate</span> <span class="kt">bool</span> <span class="nf">Func</span><span class="p">(</span><span class="n">PropertyEnum</span> <span class="n">propertyEnum</span><span class="p">);</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">Func</span> <span class="n">AggFunc</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="n">Agg</span><span class="p">;</span>

    <span class="c1">// A filter function that skips properties that don't have a valid aggregation method</span>
    <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">Agg</span><span class="p">(</span><span class="n">PropertyEnum</span> <span class="n">propertyEnum</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">PropertyInfo</span> <span class="n">info</span> <span class="p">=</span> <span class="n">GameDatabase</span><span class="p">.</span><span class="n">PropertyInfoTable</span><span class="p">.</span><span class="nf">LookupPropertyInfo</span><span class="p">(</span><span class="n">propertyEnum</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">info</span><span class="p">.</span><span class="n">Prototype</span><span class="p">.</span><span class="n">AggMethod</span> <span class="p">!=</span> <span class="n">AggregationMethod</span><span class="p">.</span><span class="n">None</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Which you then use like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">kvp</span> <span class="k">in</span> <span class="n">Properties</span><span class="p">.</span><span class="nf">IteratePropertyRange</span><span class="p">(</span><span class="n">PropertyEnumFilter</span><span class="p">.</span><span class="n">AggFunc</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// Do something with properties</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This little maneuver’s gonna save us 800 000 allocations on server startup.</p>

<h4 id="stack-like-pooling">Stack-like Pooling</h4>

<p>Sometimes you just need a way of imitating C++’s “allocate whatever on the stack” behavior. A good example of this is <code class="language-plaintext highlighter-rouge">PropertyCollection</code>: it is a pretty heavy data structure that is occasionally used just as a way of transferring data. For instance, when you create an <code class="language-plaintext highlighter-rouge">Entity</code>, you can pass it a <code class="language-plaintext highlighter-rouge">PropertyCollection</code> as a parameter, and all properties in it will be copied to the freshly created <code class="language-plaintext highlighter-rouge">Entity</code>. This temporary <code class="language-plaintext highlighter-rouge">PropertyCollection</code> has a very short lifespan, never leaves its initial scope, and the client actually uses stack allocations for it. However, in C# “we don’t do that here”, so we need a workaround.</p>

<p>The one I have implemented involves an approach similar to what is used for database connections. We define an interface for poolable objects:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IPoolable</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ResetForPool</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And then we create a manager singleton:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">ObjectPoolManager</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">ObjectPoolManager</span> <span class="n">Instance</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>

    <span class="k">private</span> <span class="nf">ObjectPoolManager</span><span class="p">()</span> <span class="p">{}</span>

    <span class="k">public</span> <span class="n">T</span> <span class="n">Get</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="k">where</span> <span class="n">T</span><span class="p">:</span> <span class="n">IPoolable</span><span class="p">,</span> <span class="k">new</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Retrieve or create a new object of type T</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="n">Return</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">instance</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span><span class="p">:</span> <span class="n">IPoolable</span><span class="p">,</span> <span class="k">new</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">instance</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
        <span class="c1">// Return a previously created object to the pool</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now we can implement two interfaces on objects that we want to use in a stack-allocated fashion:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">PropertyCollection</span> <span class="p">:</span> <span class="n">IPoolable</span><span class="p">,</span> <span class="n">IDisposable</span>
<span class="p">{</span>
    <span class="c1">// The rest of the class</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">ResetForPool</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">Clear</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">ObjectPoolManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="nf">Return</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And now we can use it like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">PropertyCollection</span> <span class="n">tempProperties</span> <span class="p">=</span> <span class="n">ObjectPoolManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">PropertyCollection</span><span class="p">&gt;();</span>
</code></pre></div></div>

<p>When we leave the scope where we got this collection, in a very stack-like fashion our <code class="language-plaintext highlighter-rouge">PropertyCollection</code> is “disposed” thanks to the <code class="language-plaintext highlighter-rouge">using</code> keyword, which in this case returns it to the pool and clears it. This reduces the number of <code class="language-plaintext highlighter-rouge">PropertyCollection</code> allocations we need to do from hundreds of thousands to just 3 or 4 per game instance.</p>

<h3 id="round-2-game-database-initialization">Round 2: Game Database Initialization</h3>

<p>Hello darkness, my old friend. Those of you who have been following these reports since the beginning will remember our earlier, many months-long struggle with implementing the game database. Eventually everything got to a functional state, but I was never really happy with how well it performed. Not only did it take pretty long to start if you were preloading all prototypes (about 14.5 seconds on my machine), even when loading prototypes on demand you would occasionally get long lags when defeating certain enemies for the first time, caused by their loot tables being deserialized. So with this optimization pass I was determined to dive back into the abyss and try to make it better.</p>

<h4 id="pak-files">Pak Files</h4>

<p>The very first thing that happens when you start MHServerEmu is the initialization of the <code class="language-plaintext highlighter-rouge">PakFileSystem</code>. All game data files are stored in <code class="language-plaintext highlighter-rouge">.sip</code> packages that consist of a header, an entry table, and raw data for all files compressed using the <a href="https://lz4.org/">LZ4</a> algorithm. Both the client and our server implementation read the header and the entry table, and then load the compressed data for all files into RAM. When files need to be decompressed and deserialized, their data is taken from RAM rather than disk. This may seem wasteful at first, but this is actually much faster than performing file system IO operations thousands of times.</p>

<p>Previously, we were loading data for each file into separate <code class="language-plaintext highlighter-rouge">byte[]</code> buffers. As I was rechecking all of our libraries after I discovered the issues with <code class="language-plaintext highlighter-rouge">RobustPredicates</code>, I noticed that our LZ4 implementation, <a href="https://github.com/MiloszKrajewski/K4os.Compression.LZ4">K4os.Compression.LZ4</a>, actually accepts <code class="language-plaintext highlighter-rouge">ReadOnlySpan&lt;T&gt;</code> and <code class="language-plaintext highlighter-rouge">Span&lt;T&gt;</code> as arguments. Before, we were looking at spans as a way of doing stack allocations for arrays, but they have another use: “slicing” an array. A span is essentially just a way of representing regions of memory, and you can represent different sections of the same array as different spans.</p>

<p>So I had an idea for of dealing with <code class="language-plaintext highlighter-rouge">.sip</code> packages more efficiently: rather than reading data for each file into separate buffers, we could just read everything into a single large buffer, and slice it with spans on decompression. While it wasn’t really what the file format was designed for, it was easy to implement thanks to the fact that all file entries are in the same order as their data that follows, so the total size of the data section can be easily calculated from the last entry as follows:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">numEntries</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadInt32</span><span class="p">();</span>
<span class="n">_entryDict</span><span class="p">.</span><span class="nf">EnsureCapacity</span><span class="p">(</span><span class="n">numEntries</span><span class="p">);</span>

<span class="n">PakEntry</span> <span class="n">newEntry</span> <span class="p">=</span> <span class="k">default</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">numEntries</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
<span class="p">{</span>
    <span class="n">newEntry</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>
    <span class="n">_entryDict</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">newEntry</span><span class="p">.</span><span class="n">FilePath</span><span class="p">,</span> <span class="n">newEntry</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">dataSize</span> <span class="p">=</span> <span class="n">newEntry</span><span class="p">.</span><span class="n">Offset</span> <span class="p">+</span> <span class="n">newEntry</span><span class="p">.</span><span class="n">CompressedSize</span><span class="p">;</span>
<span class="n">_data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="n">dataSize</span><span class="p">);</span>
</code></pre></div></div>

<p>Doing it this way doubled the performance of this initial step, reducing the time it takes from 200 to 100 ms on my machine. The real challenge still awaited me though.</p>

<h4 id="prototype-copying">Prototype Copying</h4>

<p>While my initial assumption was that our performance issues were caused by overreliance on <code class="language-plaintext highlighter-rouge">System.Reflection.PropertyInfo.SetValue()</code> for assigning deserialized field values, to my surprise, it wasn’t actually that bad: even when I did some tests and tried implementing caching and eliminating boxing, it made practically no difference. However, profiling revealed the actual culprit: <code class="language-plaintext highlighter-rouge">CalligraphySerializer.CopyPrototypeFields()</code>, which is called 625 772 times when doing a full server initialization. Within it there were two issues that were absolutely killing our performance.</p>

<p>The first issue was pretty straightforward: we were calling <code class="language-plaintext highlighter-rouge">GetProperties()</code> to get an array of C# <code class="language-plaintext highlighter-rouge">PropertyInfo</code> instances for the prototype type that is being copied. Not only <code class="language-plaintext highlighter-rouge">GetProperties()</code> is more costly than I thought, we were actually redoing the work of filtering non-Calligraphy fields each time. By implementing caching here, we reduced the number of <code class="language-plaintext highlighter-rouge">GetProperties()</code> calls and subsequent filtering to just 877, giving us a noticable boost.</p>

<p>But the real gains were in solving the second issue, that lied within the <code class="language-plaintext highlighter-rouge">AssignPointedAtValues()</code> function called in <code class="language-plaintext highlighter-rouge">CopyPrototypeFields()</code>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">AssignPointedAtValues</span><span class="p">(</span><span class="n">Prototype</span> <span class="n">destPrototype</span><span class="p">,</span> <span class="n">Prototype</span> <span class="n">sourcePrototype</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">PropertyInfo</span> <span class="n">fieldInfo</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">fieldInfo</span><span class="p">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="n">destPrototype</span><span class="p">,</span> <span class="n">fieldInfo</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="n">sourcePrototype</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This little line of naive reflection runs 7 317 481 times during full server initialization, and it used to take about 2750 out of 14500 ms it took to load all prototypes on my machine. There are much better ways of handling this, and at first I went for the most obvious one you see recommended: using expression trees to compile and cache delegates:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">CopyValue</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">PropertyInfo</span> <span class="n">propertyInfo</span><span class="p">,</span> <span class="n">T</span> <span class="n">source</span><span class="p">,</span> <span class="n">T</span> <span class="n">destination</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">CopyPropertyValueDelegateDict</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">propertyInfo</span><span class="p">,</span> <span class="k">out</span> <span class="n">Delegate</span> <span class="n">copyValueDelegate</span><span class="p">)</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ParameterExpression</span> <span class="n">sourceParam</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Parameter</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="kt">object</span><span class="p">));</span>
        <span class="n">ParameterExpression</span> <span class="n">destinationParam</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Parameter</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="kt">object</span><span class="p">));</span>

        <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="n">propertyInfo</span><span class="p">.</span><span class="n">DeclaringType</span><span class="p">;</span>

        <span class="n">UnaryExpression</span> <span class="n">castSourceParam</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Convert</span><span class="p">(</span><span class="n">sourceParam</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
        <span class="n">UnaryExpression</span> <span class="n">castDestinationParam</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Convert</span><span class="p">(</span><span class="n">destinationParam</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

        <span class="n">MethodCallExpression</span> <span class="n">getCall</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="n">castSourceParam</span><span class="p">,</span> <span class="n">propertyInfo</span><span class="p">.</span><span class="nf">GetGetMethod</span><span class="p">());</span>
        <span class="n">MethodCallExpression</span> <span class="n">setCall</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="n">castDestinationParam</span><span class="p">,</span> <span class="n">propertyInfo</span><span class="p">.</span><span class="nf">GetSetMethod</span><span class="p">(</span><span class="k">true</span><span class="p">),</span> <span class="n">getCall</span><span class="p">);</span>

        <span class="n">copyValueDelegate</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Lambda</span><span class="p">&lt;</span><span class="n">CopyValueDelegate</span><span class="p">&gt;(</span><span class="n">setCall</span><span class="p">,</span> <span class="n">sourceParam</span><span class="p">,</span> <span class="n">destinationParam</span><span class="p">).</span><span class="nf">Compile</span><span class="p">();</span>
        <span class="n">CopyPropertyValueDelegateDict</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">propertyInfo</span><span class="p">,</span> <span class="n">copyValueDelegate</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">var</span> <span class="n">copy</span> <span class="p">=</span> <span class="p">(</span><span class="n">CopyValueDelegate</span><span class="p">)</span><span class="n">copyValueDelegate</span><span class="p">;</span>
    <span class="nf">copy</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This generates and caches functions for every encountered prototype/C# property combination that are equivalent to this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">void</span> <span class="nf">CopyValue</span><span class="p">(</span><span class="n">Prototype</span> <span class="n">source</span><span class="p">,</span> <span class="n">Prototype</span> <span class="n">destination</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">((</span><span class="n">SomePrototype</span><span class="p">)</span><span class="n">destination</span><span class="p">).</span><span class="n">SomeProperty</span> <span class="p">=</span> <span class="p">((</span><span class="n">SomePrototype</span><span class="p">)</span><span class="n">source</span><span class="p">).</span><span class="n">SomeProperty</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This did give me a performance boost, reducing the time it took from 2750 to about 1750 ms. However, as I looked more closely at what was taking time, I realized that creating and compiling expression trees took about 1050 ms, with only 700 ms spent on the actual workload. While it was more efficient than naive reflection, it was obvious I was still missing out on performance.</p>

<p>I had to descend deep into the forbidden archives of Microsoft Learn and seek the dark knowledge of <code class="language-plaintext highlighter-rouge">System.Reflection.Emit</code>. Rather than relying on an abstraction in the form of expression trees, I had to throw away what remained of my humanity and look into the abyss of the Microsoft Intermediate Language (MSIL) directly. The end result looks like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">CopyValue</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">PropertyInfo</span> <span class="n">propertyInfo</span><span class="p">,</span> <span class="n">T</span> <span class="n">source</span><span class="p">,</span> <span class="n">T</span> <span class="n">destination</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">CopyPropertyValueDelegateDict</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">propertyInfo</span><span class="p">,</span> <span class="k">out</span> <span class="n">Delegate</span> <span class="n">copyValueDelegate</span><span class="p">)</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="n">propertyInfo</span><span class="p">.</span><span class="n">DeclaringType</span><span class="p">;</span>

        <span class="n">DynamicMethod</span> <span class="n">dm</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="s">"CopyValue"</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">CopyValueArgs</span><span class="p">);</span>
        <span class="n">ILGenerator</span> <span class="n">il</span> <span class="p">=</span> <span class="n">dm</span><span class="p">.</span><span class="nf">GetILGenerator</span><span class="p">();</span>

        <span class="n">il</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg_1</span><span class="p">);</span>
        <span class="n">il</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Castclass</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
        <span class="n">il</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg_0</span><span class="p">);</span>
        <span class="n">il</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Castclass</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
        <span class="n">il</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Callvirt</span><span class="p">,</span> <span class="n">propertyInfo</span><span class="p">.</span><span class="nf">GetGetMethod</span><span class="p">());</span>
        <span class="n">il</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Callvirt</span><span class="p">,</span> <span class="n">propertyInfo</span><span class="p">.</span><span class="nf">GetSetMethod</span><span class="p">(</span><span class="k">true</span><span class="p">));</span>
        <span class="n">il</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ret</span><span class="p">);</span>

        <span class="n">copyValueDelegate</span> <span class="p">=</span> <span class="n">dm</span><span class="p">.</span><span class="n">CreateDelegate</span><span class="p">&lt;</span><span class="n">CopyValueDelegate</span><span class="p">&gt;();</span>
        <span class="n">CopyPropertyValueDelegateDict</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">propertyInfo</span><span class="p">,</span> <span class="n">copyValueDelegate</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">var</span> <span class="n">copy</span> <span class="p">=</span> <span class="p">(</span><span class="n">CopyValueDelegate</span><span class="p">)</span><span class="n">copyValueDelegate</span><span class="p">;</span>
    <span class="nf">copy</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>NOTE: Chronologically this happened before my <code class="language-plaintext highlighter-rouge">CodedOutputStream</code> hack I talked about above. This is actually the real moment of my <code class="language-plaintext highlighter-rouge">ILGenerator</code> downfall.</em></p>

<p>This emits the same code as using expression trees, but at an almost ridiculously lower cost: my delegate creation time went from 1050 to about 70 ms, bringing the total time time <code class="language-plaintext highlighter-rouge">AssignPointedAtValues()</code> took to just about 770 ms, a 72% reduction.</p>

<h4 id="net-8-and-quick-jit-for-loops">.NET 8 and Quick JIT for Loops</h4>

<p>C# is part of the .NET platform, and the way it works these days is that there is a new version released every year. Odd versions (7, 8, 9) are supported for 1.5 years, while even versions (6, 8, 10) are long-term support (LTS) releases with 3 years of updates. When a version’s support ends, it stops receiving updates, including security fixes, and Visual Studio starts giving you the evil eye for targeting a “deprecated” framework. The support for .NET 6, the version that MHServerEmu is currently targeting, will end on November 12, 2024. While we can live with VS annoying us slightly more than usual, not having security updates for potentially public-facing server software is unacceptable, so we had to get ready for November.</p>

<p>I had been testing this for some time now. Retargeting is as easy as changing the number from 6 to 8 in project files and pressing the “Build” button, but there were two issues that made me less enthusiastic about this forced upgrade.</p>

<p>The first one is admittedly rather silly: .NET 7 dropped the support for Windows 7, so by retargeting to .NET 8 we would be doing so as well. This is honestly not that big of a deal: the few Windows 7 enjoyers (0.37% of Steam users according to the August 2024 hardware survey) are probably getting used to their OS of choice no longer being supported, and if you really want to, you can retarget the server back to a legacy framework relatively easily.</p>

<p>The other one was much more severe though: for some reason, the exact same game database initialization code targeting .NET 8 ran 35% slower than in .NET 6, contrary to all claims of performance improvements that new .NET versions bring. Something was not right here, but it was difficult to pinpoint the exact issue by profiling.</p>

<p>Eventuallly I ran into <a href="https://stackoverflow.com/questions/74833459/performance-issue-with-for-loop-on-the-initial-run-on-net-7/74837351">a discussion on Stack Overflow</a> started by somebody who was having a similar issue when upgrading to .NET 7. This massive performance degradation appears to be indirectly caused by a feature called <a href="https://devblogs.microsoft.com/dotnet/performance_improvements_in_net_7/#on-stack-replacement">On-Stack Replacement</a> introduced in .NET 7. Here is an overview of what was happening:</p>

<ul>
  <li>
    <p>When you build your project, your C# code is compiled to intermediate language (IL), also referred to as bytecode.</p>
  </li>
  <li>
    <p>The runtime that executes your program uses just-in-time (JIT) compilation to compile IL to native code for the platform it is running on. This happens as the program is being executed.</p>
  </li>
  <li>
    <p>There are cases when it takes more time to compile IL than to actually execute it, and if this code is only executed once, wasting too much time compiling it leads to an overall performance loss.</p>
  </li>
  <li>
    <p>To mitigate this issue, a feature called <em>tiered compilation</em> was introduced to the JIT compiler in .NET Core 2.1. When a piece of code is executed for the first time, it is compiled quickly with minimal optimizations, which is called <em>quick JIT</em>. If the runtime detects that your code is executed often enough, it recompiles it with a higher level of optimization.</p>
  </li>
  <li>
    <p>When quick JIT was first introduced, it had performance issues with functions containing loops, so it was disabled by default for those cases. .NET 7 changes apparently made this no longer necessary, so quick JIT for loops became enabled by default, even though the <a href="https://learn.microsoft.com/en-us/dotnet/core/runtime-config/compilation#quick-jit-for-loops">documentation</a> still says the default behavior is equivalent to <code class="language-plaintext highlighter-rouge">false</code>.</p>
  </li>
</ul>

<p>The game database initialization contains many intensive functions with loops that are executed only once. Because of this, most of them do not use quick JIT in .NET 6, making them compile to optimized native code on the initial run (which is their <em>only</em> run). In .NET 8, by default quick JIT is now applied to them, making them run in their less optimized form.</p>

<p>Turning quick JIT for loops off brought our code running on .NET 8 approximately back to .NET 6 levels. Turning quick JIT completely off gave us a noticable performance boost on <em>both</em> 6 and 8 (about 500 ms on my machine).</p>

<hr />

<p>All of these optimizations brought full database initialization time from approximately 14500 ms to 8500 ms on average on my machine, an overall 40-42% boost.</p>

<h3 id="round-3-propertylist">Round 3: PropertyList</h3>

<p>The final frontier of this optimization pass was always going to be the <code class="language-plaintext highlighter-rouge">PropertyList</code> data structure. Properties are everywhere in this game: heroes, villains, friendly NPCs, regions, powers, conditions, and more. This makes any changes made to this system more impactful, both in terms of performance gains and ways thing can go wrong.</p>

<p>Each <code class="language-plaintext highlighter-rouge">PropertyCollection</code> has two <code class="language-plaintext highlighter-rouge">PropertyList</code> instances backing it. One is called a <em>base list</em>, which contains all properties actually belonging to that collection. The other one is referred to as an <em>aggregate list</em>, and it contains properties from the base list aggregated (combined) with properties from all attached child collections. The simplest example of this would be an avatar with equipped gear: <code class="language-plaintext highlighter-rouge">PropertyCollection</code> instances of each equipped item are aggregated with the avatar’s own collection, which results in the base list containing properties inherent to the avatar entity itself, and the aggregate list containing a combination of the avatar’s base properties with all of the item properties.</p>

<p>Our previous <code class="language-plaintext highlighter-rouge">PropertyList</code> implementation was just a simple wrapper around <code class="language-plaintext highlighter-rouge">Dictionary&lt;PropertyId, PropertyValue&gt;</code>. It works well for simple lookups, but the game makes heavy use of all kinds of filtered property iteration, some of which require properties to be grouped by <code class="language-plaintext highlighter-rouge">PropertyEnum</code> (see the <a href="/MHServerEmu/blog/2024/02/28/progress-report-february-2024.html">February 2024 report</a> for more information on how properties work). Initially I tried using <code class="language-plaintext highlighter-rouge">SortedDictionary&lt;PropertyId, PropertyValue&gt;</code>, but its performance was not acceptable compared to a regular dictionary. The fastest and easiest to implement solution that would do the job turned out to be using the <code class="language-plaintext highlighter-rouge">OrderBy()</code> LINQ extension method for every iteration, which copies all data to a new collection and sorts it. While it did work, it was also stupidly inefficient, especially in terms of memory allocation. And when you consider that <code class="language-plaintext highlighter-rouge">PropertyList</code> iteration is also used for lookup methods, like <code class="language-plaintext highlighter-rouge">PropertyCollection.HasProperty()</code>, it starts getting just silly.</p>

<p>For this overhaul I took another look at the client implementation, aptly named <code class="language-plaintext highlighter-rouge">NewPropertyList</code>. While it does some things that do not translate to C# well, there is one core concept I adapted from it. In most cases properties are actually <em>not</em> parameterized: it is common that over a half or even all properties in a collection are basically combinations of <code class="language-plaintext highlighter-rouge">PropertyEnum</code> and <code class="language-plaintext highlighter-rouge">PropertyValue</code>. So instead of storing all properties in a single monolithic collection, it is actually more efficient to use a divide-and-conquer approach:</p>

<ul>
  <li>
    <p>Each <code class="language-plaintext highlighter-rouge">PropertyEnum</code> gets a <code class="language-plaintext highlighter-rouge">PropertyEnumNode</code> instance, which can be accessed by a hash table (a <code class="language-plaintext highlighter-rouge">Dictionary&lt;PropertyEnum, PropertyEnumNode&gt;</code> in our implementation).</p>
  </li>
  <li>
    <p>Each <code class="language-plaintext highlighter-rouge">PropertyEnumNode</code> consists of a <code class="language-plaintext highlighter-rouge">PropertyValue</code> and a <code class="language-plaintext highlighter-rouge">PropertyArray</code>, which is a collection of <code class="language-plaintext highlighter-rouge">PropertyId</code>/<code class="language-plaintext highlighter-rouge">PropertyValue</code> pairs. A node is essentially a bucket for a specific <code class="language-plaintext highlighter-rouge">PropertyEnum</code>.</p>
  </li>
  <li>
    <p>When a node is created for an enum for the first time, the list checks whether or not the <code class="language-plaintext highlighter-rouge">PropertyId</code> that is being set has parameters. If it does, a new <code class="language-plaintext highlighter-rouge">PropertyArray</code> is allocated for it, and the id/value pair is added there. If it does not, the value is simply assigned to the <code class="language-plaintext highlighter-rouge">PropertyValue</code> field.</p>
  </li>
  <li>
    <p>If an existing node containing a non-parameterized property is updated with another non-parameterized property, the value field is simply overwritten. If a parameterized property is added to a non-parameterized node, a new <code class="language-plaintext highlighter-rouge">PropertyArray</code> is allocated for this node, and both id/value pairs are added to it.</p>
  </li>
</ul>

<p>The end result in our best case scenario is that we do a single dictionary lookup and immediately get our non-parameterized value from the node, nice and efficient. And because most of the time properties are not parameterized, we get our best case most of the time.</p>

<p>When I was picking the backing data structure for our <code class="language-plaintext highlighter-rouge">PropertyArray</code> implementation, at first I looked again at what I tried before, <code class="language-plaintext highlighter-rouge">Dictionary&lt;PropertyId, PropertyValue</code> and <code class="language-plaintext highlighter-rouge">SortedDictionary&lt;PropertyId, PropertyValue&gt;</code>. My thinking was that maybe sorted dictionaries will outperform hashed ones at smaller element counts, but this assumption was wrong: benchmarking revealed that hash dictionaries were faster in pretty much all circumstances in .NET 6, and almost on par in .NET 8. However, creating tens of thousands of dictionaries, each managing their own hash buckets, was too costly for this, so I looked for the simplest solution possible.</p>

<p>The one I ended up picking was <code class="language-plaintext highlighter-rouge">List&lt;PropertyPair&gt;</code>, with <code class="language-plaintext highlighter-rouge">PropertyPair</code> being a variation of <code class="language-plaintext highlighter-rouge">KeyValuePair&lt;PropertyId, PropertyValue&gt;</code> with an <code class="language-plaintext highlighter-rouge">IComparable</code> implementation that compares pairs by keys. We add pairs to the list in sorted order, which in practice is basically free, because the most common case for property assignment is copying them from another collection, where they would already be sorted.</p>

<p>Since our lists are often tiny (&lt; 10 elements), for lookups we are using the simplest thing possible: linear search with early exit.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="kt">int</span> <span class="nf">Find</span><span class="p">(</span><span class="n">PropertyId</span> <span class="n">id</span><span class="p">,</span> <span class="k">out</span> <span class="n">PropertyValue</span> <span class="k">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="p">=</span> <span class="n">_list</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">PropertyPair</span> <span class="n">pair</span> <span class="p">=</span> <span class="n">_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">value</span> <span class="p">=</span> <span class="n">pair</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">Id</span><span class="p">.</span><span class="n">Raw</span> <span class="p">&gt;</span> <span class="n">id</span><span class="p">.</span><span class="n">Raw</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">value</span> <span class="p">=</span> <span class="k">default</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I did some measurements actually playing the game, and in the vast majority of cases (94.13%) this loop exits at <code class="language-plaintext highlighter-rouge">i &lt; 8</code>, with a significant portion of them (32.38%) being at <code class="language-plaintext highlighter-rouge">i &lt; 4</code>. Relatively costly lookups (<code class="language-plaintext highlighter-rouge">i &gt;= 16</code>) were only 5.69%.</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-09/property-array.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/property-array.png" alt="PropertyArray Lookups" /></a></p>

<p>With usage like this, the simpler thing is actually more efficient than doing something more complex, like binary search. In theory it should also work better with the CPU’s branch prediction, making it even faster.</p>

<p>With all of that done, the new <code class="language-plaintext highlighter-rouge">PropertyList</code> implementation was almost a drop-in replacement for the old one. The only real major difference that had to be dealt with was the fact that the list can no longer be modified while it is being iterated, because we are now iterating the actual data instead of its copy. However, there were only two such cases in our codebase, and they were both very easy to fix.</p>

<hr />

<p>And with that our optimization journey comes to an end. There are always more gains to be made, but for now I feel the server is in a much better state than it was a month ago, and now I can get back to implementing exciting gameplay features, such as conditions (buffs/debuffs) and loot system improvements.</p>

<h2 id="mission-impossible">Mission: Impossible</h2>

<p><em>Time for a deep dive into missions, presented by AlexBond.</em></p>

<hr />

<p>Hey everyone, it’s AlexBond. Let there be missions!</p>

<p>In this report I would like to share details on how I brought missions back to the game, and how it all works.</p>

<h3 id="mission-prototypes">Mission Prototypes</h3>

<p>The first thing to do was figuring out what prototypes are used for missions and how they are related to each other. Using the <em>Game Database Browser</em>, I determined the four main prototype classes:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">MissionPrototype</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">MissionObjectivePrototype</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">MissionActionPrototype</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">MissionConditionPrototype</code></p>
  </li>
</ul>

<p>There are various subclasses of MissionPrototype (<code class="language-plaintext highlighter-rouge">OpenMissionPrototype</code>, <code class="language-plaintext highlighter-rouge">LegendaryMissionPrototype</code>, <code class="language-plaintext highlighter-rouge">DailyMissionPrototype</code>, <code class="language-plaintext highlighter-rouge">AdvancedMissionPrototype</code>), but this time we will be looking at the base type.</p>

<p>The two primary groups of data contained in a <code class="language-plaintext highlighter-rouge">MissionPrototype</code> are <code class="language-plaintext highlighter-rouge">MissionConditions</code> and <code class="language-plaintext highlighter-rouge">MissionActions</code>. The former group defines events that need to tracked, while the latter determines what will happen when a mission’s state changes.</p>

<p>Here is an overview of how <code class="language-plaintext highlighter-rouge">MissionPrototype</code> data is used to interact with players and other objects in the game world:</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-1.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-1.png" alt="Mission Structure" style="max-height: 500px;" /></a>
</center>

<p>The are two varieties of <code class="language-plaintext highlighter-rouge">MissionManager</code>: one for regions, and one for player entities.</p>

<p>When a region is loaded, a global <code class="language-plaintext highlighter-rouge">MissionManager</code> is created and bound to that region. It then loads all <code class="language-plaintext highlighter-rouge">OpenMissionPrototype</code> instances that specify this region in their <code class="language-plaintext highlighter-rouge">ActiveInRegions</code> field.</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-2.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-2.png" alt="ActiveInRegions" /></a></p>

<p>Also, as part of the region generation process, a function called <code class="language-plaintext highlighter-rouge">GenerateMissionPopulation()</code> is run, which takes population data from <code class="language-plaintext highlighter-rouge">PopulationSpawns</code> and forwards it to a <code class="language-plaintext highlighter-rouge">MissionSpawnEvent</code> (more on that later).</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-3.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-3.png" alt="MissionPopulationEntry" /></a></p>

<p>After the region finishes loading and spawning all required objects, the mission’s state changes to active, and the <code class="language-plaintext highlighter-rouge">OnStartActions</code> event is invoked, which mainly activates various ambient animations for NPCs and mobs using <code class="language-plaintext highlighter-rouge">MissionActionEntityPerformPowerPrototype</code>.</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-4.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-4.png" alt="MissionActionEntityPerformPowerPrototype" /></a></p>

<p>Each mission has a <code class="language-plaintext highlighter-rouge">MissionState</code> that switches in the following order:</p>

<p><code class="language-plaintext highlighter-rouge">Invalid</code> - <code class="language-plaintext highlighter-rouge">Inactive</code> - <code class="language-plaintext highlighter-rouge">Available</code> - <code class="language-plaintext highlighter-rouge">Completed</code> - <code class="language-plaintext highlighter-rouge">Failed</code></p>

<p>The switching process is very complex, so I will not be going into detail on how it works. Instead, here is a flowchart:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-5.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-5.png" alt="Mission State Chart" /></a></p>

<h3 id="missionobjective">MissionObjective</h3>

<p>Each mission contains a collection of <em>objectives</em>. <code class="language-plaintext highlighter-rouge">MissionObjective</code> has some differences from <code class="language-plaintext highlighter-rouge">Mission</code>, but overall they are very similar:</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-6.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-6.png" alt="Mission Objective Structure" style="max-height: 500px;" /></a>
</center>

<p>When a mission is activated, it switches all of its objectives to the <code class="language-plaintext highlighter-rouge">Available</code> state. This registers events for triggers and creates all the required <em>actions</em> and <em>conditions</em>. When an objective’s state changes to <code class="language-plaintext highlighter-rouge">Active</code>, its <code class="language-plaintext highlighter-rouge">SuccessConditions</code> start being tracked.</p>

<p>All objectives are completed in order, and more often than not their success condition is the completion of another mission. <code class="language-plaintext highlighter-rouge">MissionObjectiveState</code> switching process is similar to <code class="language-plaintext highlighter-rouge">MissionState</code>, but there are some differences. Here is a diagram of this process:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-7.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-7.png" alt="Missions Objective State Chart" /></a></p>

<p>Now that we have “figured out” all the complexities, it’s time to take a look at how it all works in the game in the context of the <em>story</em> mode.</p>

<h3 id="story">Story</h3>

<p>The game went through a lot of rewrites: many patches came out, the story mode underwent changes, content was removed, gameplay systems were reworked. Because of this, the prototypes are a mess of working and deprecated missions mixed together. Some missions have conflicts with one another, and others do not work at all. Let’s take a look at this:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-8.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-8.png" alt="Act vs Story" /></a></p>

<p>As you can see, we have two mission directories, and many missions are duplicated and/or have conflicts… Sometimes it’s the Story missions that are the working ones, and sometimes it’s the ones from Acts…</p>

<p>Let’s take a look at an example of Story with Chapter 1.</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-9.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-9.png" alt="Story Chapter 1" style="max-height: 500px;" /></a>
</center>

<p>Missions are divided into <code class="language-plaintext highlighter-rouge">Main</code>, <code class="language-plaintext highlighter-rouge">Controllers</code>, <code class="language-plaintext highlighter-rouge">Discoveries</code>, and <code class="language-plaintext highlighter-rouge">Events</code>.</p>

<p>Each <code class="language-plaintext highlighter-rouge">Main</code> mission contains objectives:</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-10.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-10.png" alt="Mission Objectives" /></a>
</center>

<p>Let’s examine one of these objectives:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-11.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-11.png" alt="Mission Objective Example" /></a></p>

<p>The completion of this objective requires the fullfillment of a <code class="language-plaintext highlighter-rouge">MissionConditionMissionComplete</code> for a controller (another mission) - <code class="language-plaintext highlighter-rouge">NYPDSonicEmitter</code> .</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-12.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-12.png" alt="Mission Condition Example" /></a></p>

<p>Within this controller there are three more conditions:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-13.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-13.png" alt="Mission Controller Example" /></a></p>

<p><code class="language-plaintext highlighter-rouge">Controller</code> missions in most cases manage a single boss, animation, or event.</p>

<p><code class="language-plaintext highlighter-rouge">Discovery</code> missions activate triggers for discoverable mission objects on the map. They manage interactable NPCs that need to be saved or helped. All interactable NPCs on the map are <code class="language-plaintext highlighter-rouge">Discovery</code> missions.</p>

<p><code class="language-plaintext highlighter-rouge">Event</code> missions start region events when a player comes near them.</p>

<p>In other words, <code class="language-plaintext highlighter-rouge">MissionPrototype</code> is essentially a form of scripting. Many smaller missions are restarted automatically.</p>

<p>All of the above was about <em>region missions</em>, now let’s talk about <em>player missions</em>.</p>

<h3 id="player-missions">Player Missions</h3>

<p>Player missions start loading when a player with an active chapter enters a region. In total there are 303 such missions. They are saved per account and represent a player’s story progress. Many of them have the <code class="language-plaintext highlighter-rouge">SaveStatePerAvatar</code> flag and are saved in property collections of each avatar separately, which is what allows you to play through the story from beginning to end as each hero separately.</p>

<p>When I was testing the story, these missions were enough to get me to chapter 5, where I encountered <code class="language-plaintext highlighter-rouge">MetaGames</code> with no way forward without implementing them.</p>

<h3 id="metagames">MetaGames</h3>

<p>MetaGames are sets of global events for a given region that run on timers. Each MetaGame has a <code class="language-plaintext highlighter-rouge">MetaGameMode</code> and various <code class="language-plaintext highlighter-rouge">MetaStates</code>. The start of a MetaGame event usually creates a UI widget that looks like this:</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-14.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-14.jpg" alt="MetaGame Widget" /></a>
</center>

<p>Here is a list of modes that exist:</p>

<table>
  <thead>
    <tr>
      <th>GameMode</th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>MetaGameMode</td>
      <td>Story</td>
    </tr>
    <tr>
      <td>MetaGameModeIdle</td>
      <td>TrainingRoom</td>
    </tr>
    <tr>
      <td>MetaGameModeShutdown</td>
      <td>Challenges</td>
    </tr>
    <tr>
      <td>MetaGameStateMode</td>
      <td>Story</td>
    </tr>
    <tr>
      <td>NexusPvPMainMode</td>
      <td> </td>
    </tr>
    <tr>
      <td>PvEScaleGameMode</td>
      <td>Limbo</td>
    </tr>
    <tr>
      <td>PvEWaveGameMode</td>
      <td> </td>
    </tr>
    <tr>
      <td>PvPDefenderGameMode</td>
      <td>PvP</td>
    </tr>
  </tbody>
</table>

<p>As you can see, the story uses only two modes. It also requires a number of states: <code class="language-plaintext highlighter-rouge">MetaStateMissionActivate</code>, <code class="language-plaintext highlighter-rouge">MetaStateMissionSequence</code>, <code class="language-plaintext highlighter-rouge">MetaStatePopulationMaintain</code>, and <code class="language-plaintext highlighter-rouge">MetaStateWaveInstance</code>.</p>

<p>Here is a full list of all states:</p>

<table>
  <thead>
    <tr>
      <th>MetaState</th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>MetaStateCombatQueueLockout</td>
      <td>Raids</td>
    </tr>
    <tr>
      <td>MetaStateEntityEventCounter</td>
      <td>XMansion, Holo-Sim</td>
    </tr>
    <tr>
      <td>MetaStateEntityModifier</td>
      <td>XMansion, Holo-Sim</td>
    </tr>
    <tr>
      <td>MetaStateLimitPlayerDeaths</td>
      <td>Gate, Raids</td>
    </tr>
    <tr>
      <td>MetaStateLimitPlayerDeathsPerMission</td>
      <td>SurturDebugMainMode</td>
    </tr>
    <tr>
      <td>MetaStateMissionActivate</td>
      <td> </td>
    </tr>
    <tr>
      <td>MetaStateMissionProgression</td>
      <td>Raids</td>
    </tr>
    <tr>
      <td>MetaStateMissionRestart</td>
      <td>AxisRaid</td>
    </tr>
    <tr>
      <td>MetaStateMissionSequence</td>
      <td> </td>
    </tr>
    <tr>
      <td>MetaStateMissionStateListener</td>
      <td>XMansion</td>
    </tr>
    <tr>
      <td>MetaStatePopulationMaintain</td>
      <td> </td>
    </tr>
    <tr>
      <td>MetaStateRegionPlayerAccess</td>
      <td> </td>
    </tr>
    <tr>
      <td>MetaStateScoringEventTimerEnd</td>
      <td>DangerRoomTimerEnd</td>
    </tr>
    <tr>
      <td>MetaStateScoringEventTimerStart</td>
      <td>DangerRoomTimerStart</td>
    </tr>
    <tr>
      <td>MetaStateScoringEventTimerStop</td>
      <td>DangerRoomTimerStop</td>
    </tr>
    <tr>
      <td>MetaStateShutdown</td>
      <td>DangerRoom</td>
    </tr>
    <tr>
      <td>MetaStateStartTargetOverride</td>
      <td>SurturStartTargetCaldera</td>
    </tr>
    <tr>
      <td>MetaStateTimedBonus</td>
      <td>AgeOfUltronTimedBonusPhase01</td>
    </tr>
    <tr>
      <td>MetaStateTrackRegionScore</td>
      <td>DangerRoom, AgeOfUltron</td>
    </tr>
    <tr>
      <td>MetaStateWaveInstance</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>I had to implement the required modes and states to continue working on missions.</p>

<p>Many of these states contain populations that need to be spawned dynamically using <code class="language-plaintext highlighter-rouge">MetaStateSpawnEvent</code>. This is what we will be looking at next.</p>

<h3 id="spawnevent">SpawnEvent</h3>

<p>The old spawning system I was using became no longer suitable for current circumstances. I had to rework it, which involved creating the following classes:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">SpawnEvent</code> (<code class="language-plaintext highlighter-rouge">PopulationAreaSpawnEvent</code>, <code class="language-plaintext highlighter-rouge">MissionSpawnEvent</code>, <code class="language-plaintext highlighter-rouge">MetaStateSpawnEvent</code>)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">SpawnScheduler</code> (<code class="language-plaintext highlighter-rouge">MarkerScheduler</code>, <code class="language-plaintext highlighter-rouge">LocationScheduler</code>)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">PopulationObjectQueue</code> (<code class="language-plaintext highlighter-rouge">CriticalQueue</code>, <code class="language-plaintext highlighter-rouge">RegularQueue</code>)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">SpawnLocation</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">SpawnMap</code> (to be implemented)</p>
  </li>
</ul>

<p>All the information we need for spawning is contained in <code class="language-plaintext highlighter-rouge">PopulationObject</code>, but it needs to be retrieved and processed correctly. Previously I did this manually, which is why everything was static. However, the game requires dynamic spawning.</p>

<p>Here is how it’s done. First, the <code class="language-plaintext highlighter-rouge">SpawnEvent</code> type is determined, which then processes our population by getting all <code class="language-plaintext highlighter-rouge">PopulationObject</code> instances from it. Objects are divided based on their properties by how <em>critical</em> they are for spawning and how <em>tied</em> they are to a location. Critical objects are spawned first, and while we have even a single critical object for a marker, none of the non-critical objects should be spawning (this caused a lot of issues with missions). If there is a <code class="language-plaintext highlighter-rouge">UsePopulationMarker</code> marker, the object is forwarded to a <code class="language-plaintext highlighter-rouge">MarkerScheduler</code>, otherwise it goes to a <code class="language-plaintext highlighter-rouge">LocationScheduler</code>.</p>

<p>First, we check if the region has a free marker using <code class="language-plaintext highlighter-rouge">SpawnMarkerRegistry</code>, and if it matches our <code class="language-plaintext highlighter-rouge">SpawnLocation</code>, this marker becomes reserved, and our object spawns on it. The number of markers in a region is limited, which causes problems, because the spawn queue is very large. To solve this issue, I have implemented two classes: <code class="language-plaintext highlighter-rouge">PopulationObjectQueue</code> and <code class="language-plaintext highlighter-rouge">SpawnScheduler</code>. They manage the queue and keep everything in order, preventing missions from breaking.</p>

<p>When all <code class="language-plaintext highlighter-rouge">SpawnEvent</code> objects are spawned, the <code class="language-plaintext highlighter-rouge">OnSpawnedPopulation</code> event is invoked, which activates the mission. If the marker is occupied, the required mission objects fail to spawn, and the mission does not activate.</p>

<p>This chart demonstrates how spawning is planned:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-09/missions-15.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-09/missions-15.png" alt="Spawn Queue Chart" /></a></p>

<h3 id="conclusion">Conclusion</h3>

<p>As you can see, missions are a very complex system of interconnections, states, conditions, and events. This makes it difficult to find the reason something breaks and understand it. Although I was able to fix the most glaring issues, and right now it is possible to finish all 10 chapters of the story, there is still a lot of work to do, including debugging internal missions, MetaState, widgets, animations, rewards, SpawnMap, and so on.</p>

<p>Thank you to everybody who is helping me debug missions, and until we meet again in future reports!</p>

<hr />

<p>This was a huge one! Thanks to everyone who read (or just scrolled) all the way to the end, see you all next time!</p>]]></content><author><name></name></author><category term="blog" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">MHServerEmu Progress Report: August 2024</title><link href="https://crypto137.github.io/MHServerEmu/blog/2024/08/31/progress-report-august-2024.html" rel="alternate" type="text/html" title="MHServerEmu Progress Report: August 2024" /><published>2024-08-31T15:30:00+03:00</published><updated>2024-08-31T15:30:00+03:00</updated><id>https://crypto137.github.io/MHServerEmu/blog/2024/08/31/progress-report-august-2024</id><content type="html" xml:base="https://crypto137.github.io/MHServerEmu/blog/2024/08/31/progress-report-august-2024.html"><![CDATA[<!--more-->

<p><img src="/MHServerEmu/assets/blog/progress-report/2024-08/header.jpg" alt="MHServerEmu Progress Report - August 2024" /></p>

<p>The development of MHServerEmu keeps chugging along.</p>

<h2 id="back-to-basics">Back to Basics</h2>

<p><a href="/MHServerEmu/blog/2024/07/31/progress-report-july-2024.html">After getting sidetracked with implementing some of the more “flashy” features in July</a>, such as powers and loot tables, it was time for me to go back and continue some of the backend work I started back in June.</p>

<p>While our area of interest (AOI) implementation did work, it still relied on some of our earliest code from July-August 2023 when we were just starting getting the hang of things. For instance, the code that would put players into regions was a mess of hardcoded hacks, resulting in limitations such as not being able to teleport outside of a client’s area of interest without completely exiting and reentering the region. Combined with the lack of persistence, this resulted in, for example, your data being reset when you would transition between floors of tower regions, and it also made resurrecting avatars at checkpoints very hard to do, which we had to circumvent by doing resurrections on the spot. After painstakingly going through the old code and refactoring various things, those limitations are now gone, which you can see in current nightly builds of the server.</p>

<p>Another set of issues that had to be dealt with was how AOIs were interacting with the environment (areas and cells). When there are no players around world entities, like enemies and NPCs, most of them stop being <em>simulated</em>, meaning their AI turns off and they no longer become interactable for systems like powers. The problem was with how we determined when a player was “nearby”: we reused the same proximity volume around the active avatar we use for periodic entity scans, and turned simulation on or off based on whether an entity was replicated to a client. This caused frequent simulation switching and made enemies “forget” about players at relatively small distances, especially in larger cells, like the one used in Holo-Sim, where the whole region is just one big cell. So we switched to doing simulation updates per cell instead of per individual entity: if a cell is visible to any player, all world entites in it will now be simulated, making the whole experience more consistent.</p>

<p>Here is a diagram to better illustrate what was happening:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-08/aoi.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-08/aoi.png" alt="AOI Simulation Range" /></a></p>

<p>In this example the player’s AOI proximity volume (indicated in green) intersects cells 1, 2, 4, and 5, so those are the cells that are loaded client-side. Cells 0 and 3 are too far away, so the client is not made aware of them by the server, making them not exist from the client’s point of view. There are enemies (indicated in red) in all cells, however, only some of them intersect the player’s AOI volume. Previously, only the enemies in the volume would be simulated, while the stragglers would get turned off. Now, all enemies in all loaded cells (1, 2, 4, and 5) will continue to be simulated even if they are slightly outside the player’s AOI, allowing them to, for example, pursue the player more effectively. Meanwhile, enemies in faraway cells (0 and 3) will still be turned off.</p>

<p>In addition to that, the order of operations when updating proximity was also off. We were doing all entity updates at the same time, and there were cases when messages were being sent out of order, making the client try to put entities into environments that did not exist client-side, or deleting environments that still had entities in them. The whole entity processing queue had to be split into two, with entity removal happening before environment updates, and creation after, when areas and cells were ready. However, there is a catch: an entity can continue to exist client-side even if it is no longer in proximity (through ownership, discovery, or party channels), allowing its map icon to continue being displayed. In this case though, it is removed from the game world client-side when the environment for it stops existing due to no longer being in proximity. For this reason when we separate entity updates into pre-environment and post-environment we also have to take into account entities that gain or lose the proximity policy, with the former needing to be replicated after the environment, and the latter before.</p>

<p>Finally, one annoying thing that had to be fixed was how the current avatar could occasionally get outside of its own proximity when moving fast, causing it to disappear. The reason for this is that avatar movement in this game is mostly client-authoritative, with the server predicting client movement most of the time and only correcting when things get completely out of hand. We had our proximity update trigger tied to locomotion updates arriving from the client, but due to how the locomotion system works, an avatar can move pretty far without sending any updates as long as the movement is predictable, and this caused the aformentioned issues at high speed predictable movements. The obvious fix was to make proximity updates trigger more frequently based on server-side predictions at a given time, which is what we did. If you still see this issue, please be sure to report it!</p>

<p>While these little problems may not seem as important as a whole new gameplay system, like powers or AI, they are the blood vessels that allow everything else to happen, and some of them can be quite tricky to fix without breaking anything, taking a significant amount of time in the process. But with another round of those done, we can go back to more exciting matters.</p>

<h2 id="persistent-perfection">Persistent Perfection</h2>

<p>In September we plan to release our next stable version, 0.3.0, which is going to include most of the progress we were able to achieve over the course of this summer. Releasing a stable version is a moment when we are able to get feedback from some of the less engaged and technically savvy users, and when we released 0.2.0 I went through the feedback and identified two key features that I wanted to implement for the next release: powers doing damage when you hold the button down, and your loot being saved when you transfer to another region or logout (also known as persistence). With the former goal being overachieved if I do say so myself, it was now time to spend the remaining time on preserving your loot.</p>

<p><a href="/MHServerEmu/blog/2024/04/30/progress-report-april-2024.html">In April we talked about the game’s serialization system and the various modes it has.</a> Back then we focused on replication, which is the process synchronizing server game state with clients, but the system also supports a database serialization mode used for persistent storage. And since it’s just another mode for the same system that reuses a lot of the same serialization routines, most of it is actually contained in the client. We could in theory implement some kind of custom serialization solution, but since we already had most of it implemented for replication, it made sense to just expand it a little.</p>

<p>One key difference between database and replication serialization is how data references are stored. For example, <a href="/MHServerEmu/blog/2024/02/28/progress-report-february-2024.html">in February we went over various tricks the game uses for efficiently encoding properties</a>, and as you might imagine, most of them are going to break with a changing game data set. While in runtime the game can rely on sorted file path hashes and their indexes, for cross-version compatibility needed in persistent storage the game references data using 64-bit GUIDs that remain valid even if a data file is moved, renamed, or replaced. We cannot say for sure how those GUIDs were generated, but there does not appear to be any noticable pattern, indicating that they may be hashes of some internal identifiers not exposed in the client. Properties specifically also required reimplementation of a separate <code class="language-plaintext highlighter-rouge">PropertyStore</code> structure used to break up property parameters into independent data references that are serialized as their own values, rather than being embedded in the id. Some data that can be derived from other data is also omitted to reduce file sizes. For example, power collections that contain available powers can be restored from the game database by knowing an avatar’s prototype and character level, so they do not need to be serialized.</p>

<p>One potentially neat side effect of using the original serialization implementation is that it was designed with backward compatibility in mind. In theory this should make it easier to bring data from an older version of the game into a newer one, provided we implement versioning routines for game versions we want to support. This is going to make it easier to implement progression servers that would go through versions of the game over a span of time, as seen in other legacy online games, although it remains to be seen how well this concept suits Marvel Heroes in particular.</p>

<p>What this serialization process gives us is <a href="https://en.wikipedia.org/wiki/Object_storage">blobs</a> of serialized entity data that we need to store somehow. This is one of the rarer times in this project when we have the freedom to be creative and come up with our own solutions rather than trying to fit into an existing system dictated by the client.</p>

<p>For me personally, it is very important for MHServerEmu to remain self-contained and have it be as easy as a mod to set up and run, if someone just wants to play offline single player on their own machine. For this reason we are using SQLite as our default storage backend: it is embedded into the server and does not require separate setup, while also being very reliable and flexible enough to serve our needs. Depending on how many people play on a single server and how much writing load there is going to be, it may also be the only thing we are ever going to need. But there is also some room for additional flexibility via dependency injection: interaction with the database happens via an interface called <code class="language-plaintext highlighter-rouge">IDBManager</code> that is implemented by the <code class="language-plaintext highlighter-rouge">SQLiteDBManager</code> class. An instance of <code class="language-plaintext highlighter-rouge">SQLiteDBManager</code> is injected into the <code class="language-plaintext highlighter-rouge">AccountManager</code> during server initialization, and it can be replaced with another implementation that uses a different backend. Right now we also have another implementation called <code class="language-plaintext highlighter-rouge">JsonDBManager</code> that wraps JSON serialization in the database API, allowing you to essentially have a save file, like you would in a single player game, without changing the overall system. Similarly, it should be possible to implement a more powerful solution, such as PostgreSQL or MySQL, if the need ever arises.</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-08/db-manager.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-08/db-manager.png" alt="Dependency Injection Using IDBManager" /></a></p>

<p>With great power comes great responsibility, and as we store more and more data we need to make the persistency layer more robust. While some data corruption and/or wipes are inevitable while the server is still in earlier stages of development, we understand how important your stuff is in a loot progression game like this, so we would like to keep them to a minimum. For this purpose we are implementing a number of features that are going to be coming with this persistency update:</p>

<ul>
  <li>
    <p>The server will now automatically create backups of the database file. If something goes wrong with your primary file, you may have a backup in place to fall back to. By default the server creates up to 5 backups with an interval of at least 15 minutes between them, but this is configurable.</p>
  </li>
  <li>
    <p>The server will now create a new database file if one is not present in the <code class="language-plaintext highlighter-rouge">Data</code> folder, and it will no longer come with one. This means when you update to a recent nightly build or stable release, you can safely overwrite all files without having to back up <code class="language-plaintext highlighter-rouge">Account.db</code>.</p>
  </li>
  <li>
    <p>There is a new automated migration system that will upgrade your existing database file if there are any schema changes, such as columns or tables being added or removed.</p>
  </li>
</ul>

<p>As of writing this, we have most of the IO matters sorted out, but some of the game logic still needs more work to be able to properly handle entities actually persisting. For example, we had to hardcode your character level to 60 because this information did not persist on region transfers and log outs, and you would be getting reset to level 1 all the time even if we had leveling implemented. But, if we roll persistence out in the current state, everyone would get saved as level 60 because of this workaround, and when we would eventually implement leveling we would have to force a wipe of all progress to allow everyone to start from level 1. Other examples include stash tab unlocks, selected team-ups, and more. Once those are dealt with, which should not take too long, we are going to be ready to release 0.3.0.</p>

<h2 id="the-road-ahead">The Road Ahead</h2>

<p>As we wrap things up with 0.3.0, we begin looking towards what is ahead of us. So far we have been hitting our target stable release cadence of once every three months, and we plan to continue doing so. Recently <a href="https://github.com/users/Crypto137/projects/5/views/1">we have published a rough roadmap of features we plan for upcoming stable releases</a>: while plans change and specific features will most likely shift around as we get further along, it should give you a broad overview of the current outlook.</p>

<p>One large new feature that is most likely going to be ready for 0.4.0 is the mission system, and AlexBond has already spent the better part of August working on it. It is a very complex system that involves dozens of missions conditions, such as <code class="language-plaintext highlighter-rouge">MissionConditionEntityDeath</code> and<code class="language-plaintext highlighter-rouge">MissionConditionItemCollect</code>, that trigger various actions, like <code class="language-plaintext highlighter-rouge">MissionActionEntityPerformPower</code>, and <code class="language-plaintext highlighter-rouge">MissionActionShowMotionComic</code>. The mission system makes use of numerous other gameplay systems, and it is tightly coupled with the spawning system that needed a major overhaul. We will go into more detail on this in one of the future reports.</p>

<p>We are also planning to continue working on itemization pretty soon. The current implementation allows us to pick mostly accurate base types and qualities, but equipment currently has no affixes, which is something we have been holding back on implementing due to not having persistence working. We would not want anyone to feel the pain of getting an amazing drop, knowing that it is going to be lost forever as soon as you go back to hub.</p>

<p>In general, with most of the backend now being in a reasonably decent state, the focus will continue shifting towards in-game systems that are more clearly visible when playing the game.</p>

<hr />

<p>Time for us to get back to work. Until the next report!</p>]]></content><author><name></name></author><category term="blog" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">MHServerEmu Progress Report: July 2024</title><link href="https://crypto137.github.io/MHServerEmu/blog/2024/07/31/progress-report-july-2024.html" rel="alternate" type="text/html" title="MHServerEmu Progress Report: July 2024" /><published>2024-07-31T22:30:00+03:00</published><updated>2024-07-31T22:30:00+03:00</updated><id>https://crypto137.github.io/MHServerEmu/blog/2024/07/31/progress-report-july-2024</id><content type="html" xml:base="https://crypto137.github.io/MHServerEmu/blog/2024/07/31/progress-report-july-2024.html"><![CDATA[<!--more-->

<p><img src="/MHServerEmu/assets/blog/progress-report/2024-07/header.jpg" alt="MHServerEmu Progress Report - July 2024" /></p>

<p>We have a lot of exciting updates to share. It has been one year since this project started, and this month <em>combat</em> has returned to Marvel Heroes, which I would dare to call our biggest leap forward since we first got in-game in July 2023.</p>

<h2 id="you-got-the-power">You Got the Power</h2>

<p>We have laid the foundation for one of the most important and complex systems of Marvel Heroes - <em>powers</em>. From a certain perspective, it would not be an exaggeration to call it <em>the</em> most complex system in the entire game because of its deep interconnection with other systems and just the sheer amount of stuff it involves. Covering all of it is outside the scope of a single report, but I will give a brief overview of the work that has been done so far and what is left to do.</p>

<p>One important thing to note is that prior to this month we barely had any power-related functionality implemented server-side. The fact that you could “use” a lot of powers before was just the magic of client-side prediction, and the server was almost completely unaware of what was actually happening.</p>

<p>So where do we even begin? First of all, there are many different kinds of powers. Powers are classified by categories: <code class="language-plaintext highlighter-rouge">NormalPower</code>, <code class="language-plaintext highlighter-rouge">ComboEffect</code>, <code class="language-plaintext highlighter-rouge">EmotePower</code>, <code class="language-plaintext highlighter-rouge">GameFunctionPower</code>, <code class="language-plaintext highlighter-rouge">HiddenPassivePower</code>, <code class="language-plaintext highlighter-rouge">HotspotEffect</code>, <code class="language-plaintext highlighter-rouge">ItemPower</code>, <code class="language-plaintext highlighter-rouge">MissileEffect</code>, <code class="language-plaintext highlighter-rouge">ProcEffect</code>, <code class="language-plaintext highlighter-rouge">ThrowablePower</code>, and <code class="language-plaintext highlighter-rouge">ThrowableCancelPower</code>. Powers can have various targeting shapes: <code class="language-plaintext highlighter-rouge">ArcArea</code>, <code class="language-plaintext highlighter-rouge">BeamSweep</code>, <code class="language-plaintext highlighter-rouge">CapsuleArea</code>, <code class="language-plaintext highlighter-rouge">CircleArea</code>, <code class="language-plaintext highlighter-rouge">RingArea</code>, <code class="language-plaintext highlighter-rouge">Self</code>, <code class="language-plaintext highlighter-rouge">TeamUp</code>, <code class="language-plaintext highlighter-rouge">SingleTarget</code>, <code class="language-plaintext highlighter-rouge">SingleTargetOwner</code>, <code class="language-plaintext highlighter-rouge">SingleTargetRandom</code>, <code class="language-plaintext highlighter-rouge">SkillShot</code>, <code class="language-plaintext highlighter-rouge">SkillShotAlongGround</code>, or <code class="language-plaintext highlighter-rouge">Wedge</code>. A power’s targeting style can have various flags applied to it, such as <code class="language-plaintext highlighter-rouge">AOESelfCentered</code>, <code class="language-plaintext highlighter-rouge">NeedsTarget</code>, <code class="language-plaintext highlighter-rouge">TurnsToFaceTarget</code>, <code class="language-plaintext highlighter-rouge">AlwaysTargetMousePos</code>, and more. This list can continue on and on, but the point is that there is <em>a lot</em> of factors to consider here, which is why our reimplementation of the <code class="language-plaintext highlighter-rouge">Power</code> class is already at over 6000 lines of code, and it continues to grow.</p>

<p>But all of that is just static data defined by game designers, and powers are dynamic beasts that live in runtime. Before a power can be used it needs to be <em>assigned</em> to a world entity’s <code class="language-plaintext highlighter-rouge">PowerCollection</code>. The assignment process includes the creation of an instance of the <code class="language-plaintext highlighter-rouge">Power</code> class that is in many ways not unlike an entity: it has its own <code class="language-plaintext highlighter-rouge">PropertyCollection</code>, as well as various other pieces of state. When a power is assigned it gets passed a set of information used for scaling referred to as <em>power index properties</em>: power rank, character level, combat level, item level, and item variation. This is one of the places where we can see that BUE was not as thorough as it may appear: although the update “removed” power ranks, they still exist internally, with most powers instead being set to rank 0 or 1 and rebalanced accordingly.</p>

<p>With the power assigned and initialized it can now be used. Every time you use a power it goes through a pipeline consisting of four main stages:</p>

<ul>
  <li>
    <p><strong>Activation</strong>: this is when the game checks if you can use the power (you have enough resources, your target is valid if the power needs one, etc.), starts the animation, and schedules a <em>power application</em> for when the contact frame is supposed to happen. Although the server does not actually play animations, it still needs to know how long they are, taking into account variables such as attack speed modifiers. In many cases it is possible to cancel activation before the animation reaches its contact frame.</p>
  </li>
  <li>
    <p><strong>Power Application</strong>: at the contact frame of the animation we reach the point of no return, which is when the power can actually begin doing something. At this moment the properties of the power and its owner are snapshotted and recorded into an instance of the <code class="language-plaintext highlighter-rouge">PowerPayload</code> class. Depending on the power, this payload may either get processed as soon as it is created, or it can be scheduled to be processed later. At the time of writing we do not have delayed processing implemented yet, which is why, for example, throwable objects deal damage instantly rather than when they actually reach their target destination. The correct way of doing this involves calculating the time the throwable object is going to spend in the air and delaying the processing of the payload by that time.</p>
  </li>
  <li>
    <p><strong>Payload Processing</strong>: this is where the fun begins. The snapshot of the power and its owner recorded in the payload is processed, and the <em>results</em> are calculated, which include damage, healing, and conditions (buffs and/or debuffs) that need to be applied to the target. Depending on the calculations, various result flags may be set, such as critical strike and dodge.</p>
  </li>
  <li>
    <p><strong>Application of Results</strong>: the results of the payload calculations are applied to the target. This involves adjusting the health of the target, potentially killing it, and applying conditions to it. Clients also get sent a copy of the results to display damage numbers and additional hit visual effects.</p>
  </li>
</ul>

<p>At various points in this process additional <em>power events</em> may get triggered. In total there are 30 event types that can trigger 36 types of actions. Some of these actions are very specific, like <code class="language-plaintext highlighter-rouge">BodySlide</code>, <code class="language-plaintext highlighter-rouge">SwitchAvatar</code>, and <code class="language-plaintext highlighter-rouge">PetItemDonate</code>, but others are more general purpose, such as <code class="language-plaintext highlighter-rouge">UsePower</code>, <code class="language-plaintext highlighter-rouge">EndPower</code>, and <code class="language-plaintext highlighter-rouge">CooldownStart</code>. One of the most common use cases for power events is the activation of <em>combo powers</em>: when a power needs to do more than one thing, like moving your character and dealing AoE damage around your destination, this is usually achieved by having two different powers, with one triggering the other as a combo.</p>

<p>While all kinds of entities can use powers, avatars are a very special case, because they are controlled by players connected remotely. One example of special treatment in this regard is the concept of <em>continuous powers</em>. You may recall how in our earlier iteration of “combat” that you can still see in stable builds most powers would deal damage only on the initial activation, with no effect if you held the button down or pressed it frequently enough. The reason for this is that the game classifies a lot of powers as continuous based on various criteria, such as animation length, category, override flags, and more. If a power is continuous, activations after the initial one are not communicated between the client and server: the server just assumes the client is still holding the button down and continuously reactivates it until it receives a cancellation message. This requires the server to be able to run the entire power activation process on its own in parallel to the client, which was not possible previously with hacks, but can now be done.</p>

<p>Another example of avatar-specific behavior is the priority queue system. The basic idea of it is that if a player input cannot be acted on immediately because another power is already being used, this input is put into a very small queue with a size of one or two commands. If there is a new command that is different from the rest of commands that have been issued recently, such as when you try to activate a defensive power inbetween spamming regular attacks, this different command takes priority so it doesn’t get lost. This system works almost exactly the same as, for example, Diablo III, and if you are interested in this topic I strongly recommend watching the talk <a href="https://gdcvault.com/play/1017794/Through-the-Grinder-Refining-Diablo">Through the Grinder: Refining Diablo III’s Game Systems by Wyatt Cheng</a>. Not only will you learn interesting stuff, you will also discover Wyatt’s origin story before he became infamously known as the “do you guys not have phones” guy. Currently we do not have command queueing implemented server side, which is why some of your inputs may occasionally get lost in the heat of battle, especially with higher latency.</p>

<p>So far we have implemented a lot of the foundation, which allows most powers that deal direct damage to enemies to function, but there is still a lot of work left to do, including:</p>

<ul>
  <li>
    <p>Various additional aspects of payload processing, including taking the target’s defensive properties into account, paying resource costs, and more. The current implementation is a very simplified one based on formulas the client uses to calculate tooltip damage.</p>
  </li>
  <li>
    <p>Hidden damage scaling mechanics: dynamic combat level (DCL) and scaling player damage output based on the total number of players in proximity.</p>
  </li>
  <li>
    <p>Implementations for the rest of power event triggers and actions.</p>
  </li>
  <li>
    <p>Avatar power activation priority queue.</p>
  </li>
  <li>
    <p>Condition (buff and debuff) application and removal, including those that deal damage over time (DoTs).</p>
  </li>
  <li>
    <p>Hotspot powers. Hotspots are zones that apply certain effects when entities stand in them, such as fire that deals damage when you stand in it.</p>
  </li>
  <li>
    <p>Procs.</p>
  </li>
  <li>
    <p>Summon powers.</p>
  </li>
</ul>

<p>For now though we have enough of this system working to have the game feel like a real game again, especially when combined with the AI implementation by AlexBond.</p>

<h2 id="loot-tables-for-dummies">Loot Tables for Dummies</h2>

<p>While it is nice to be able to smash things and beat bad guys, the core thing that makes you do it again and again in games like these is the loot. Although we did have a placeholder system put in place last month, I felt this aspect started falling behind, especially with how authentic the rest of the game is now looking.</p>

<p>We are extremely lucky to have all the original loot tables in the client. The underlying loot system is very complex, but this month I have made significant progress in untangling it. Although items still lack affixes and stats, their rarities and base types should now be accurate, making the lootsplosions from defeating bosses way more satisfying. So how does it all work?</p>

<p>Although they are called loot “tables”, they are actually tree structures consisting of <code class="language-plaintext highlighter-rouge">LootNodePrototype</code> instances. Each node can be either a <code class="language-plaintext highlighter-rouge">LootTablePrototype</code> or a <code class="language-plaintext highlighter-rouge">LootDropPrototype</code>. Here is what a typical “loot table” looks like:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-07/loot-table.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-07/loot-table.png" alt="Loot Tables" /></a></p>

<p>When you want to use a loot table, you recursively iterate through the nodes of this tree, with each “table” representing a branch and “drops” representing end points that get recorded (more on that later). Visiting a node is referred to as <em>selecting</em> it, and activating the node is called <em>rolling</em>.</p>

<p>When you select a loot table node, it gets rolled one or more times, with each roll determining branches to go down to. When rolling loot tables the game uses the concept of <em>nodrop</em> similar to <em>Diablo II</em>: rather than specifying the drop chance of something, instead each table node has a <em>nodrop chance</em> defined that determines whether or not the table will be skipped entirely. So a 1% drop chance is represented as a 99% nodrop chance. If the roll passes this nodrop chance check, branches of the table are picked using one of three methods:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">PickWeight</code>: picks one of the branch nodes randomly based on their defined weight.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">PickWeightTryAll</code>: excludes branch nodes randomly based on their weight until only one remains, which gets picked.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">PickAll</code>: picks all branch nodes.</p>
  </li>
</ul>

<p>Picked nodes are selected and rolled, and this process continues recursively until it reaches a loot drop node.</p>

<p>In total there are 17 different types of loot drop nodes representing various things that can “drop”. The most obvious and widely-used one is <code class="language-plaintext highlighter-rouge">LootDropItemPrototype</code> that represents an item dropping. There is also <code class="language-plaintext highlighter-rouge">LootDropAgentPrototype</code> used for spawning entities, like health and experience orbs, that are actually implemented as AI-controlled agent entities rather than items. But just like it was with inventories, the definition of a “drop” is quite broad here: there are drop nodes such as <code class="language-plaintext highlighter-rouge">LootDropPlayVisualEffectPrototype</code>, <code class="language-plaintext highlighter-rouge">LootDropChatMessagePrototype</code>, and <code class="language-plaintext highlighter-rouge">LootDropBannerMessagePrototype</code> that are more like actions triggered by rolling rather than representations of physical things that you can pick up.</p>

<p>As you navigate a loot tree and reach various drop nodes, you need to record your journey to make use of it later. For this the game uses an abstract <code class="language-plaintext highlighter-rouge">IItemResolver</code> interface class the gets implemented by various systems that need to interact with loot tables. Successfully rolled drop nodes are “pushed” onto the resolver, and the accumulated data from the resolver is then used to spawn rolled items in the world, add them to an inventory, or just output the results as text for testing.</p>

<p>One last essential piece of the loot table puzzle are <em>loot roll modifiers</em>. When you interact with a loot table tree you also pass to it an instance of <code class="language-plaintext highlighter-rouge">LootRollSettings</code> that contains the context, from obvious things, such as level and difficulty tier, to more esoteric factors, such as the current day of the week. Each node in the tree can then have modifiers that process and/or override these settings. One of the simplest examples would be filtering drops based on level range. But you can also, for instance, override the current avatar and always drop items for somebody else. Or you could have the rare item find stat apply to an arbitrary selection of items. When modifiers are applied to a drop node they affect only that drop node, but when they are applied to a table node, the affect all branches of that table. This is how, for example, eternity splinters drops are controlled: splinters have their own branches in common loot tables with applied modifiers.</p>

<p>And with all of that we have basic loot table rolling working. We still have work to do, including implementing all the special drop types, additional modifiers, and some more drop processing, such as taking item quality bonuses into account and applying affixes to items, but the foundation is now in place. If only we could have our loot persist when we transfer between regions and log out…</p>

<h2 id="the-barrel-made-me-do-it">The Barrel Made Me Do It</h2>

<p><em>AlexBond is back yet again this month to talk about AI profile overriding.</em></p>

<hr />

<p>Hey everyone, this is AlexBond. Let the combat begin! In this report I would like to share how I enabled AI and brought all the enemies in the game to life.</p>

<p>This month there were a lot of major updates: enemies and bosses now attack and deal damage, and the game is really starting to come to live. But let’s talk about how it all works.</p>

<p>Enemy movement uses the <code class="language-plaintext highlighter-rouge">AIController</code> class that I already covered in previous reports. This time I would I would like to talk about <code class="language-plaintext highlighter-rouge">AIOverride</code> and how it is used.</p>

<h3 id="ai-override">AI Override</h3>

<p>An agent’s prototype generally specifies its AI profile that defines its behavior. All attack-based AI profiles (<code class="language-plaintext highlighter-rouge">ProceduralProfileWithAttackPrototype</code>) function in two modes:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">DefaultSensory</code> - scanning mode (based on <code class="language-plaintext highlighter-rouge">BehaviorSensorySystem</code>)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">HandleContext</code> - action mode</p>
  </li>
</ul>

<p>Scanning involves searching for a target. If no target is found using <code class="language-plaintext highlighter-rouge">SelectTargetEntity()</code>, the AI profile is overriden with a <code class="language-plaintext highlighter-rouge">NoTargetOverrideProfile</code>. Usually it is <code class="language-plaintext highlighter-rouge">ProceduralProfileDefaultActiveOverridePrototype</code> that makes the agent wander around (<code class="language-plaintext highlighter-rouge">WanderInPlace</code>) or return to its spawn location (<code class="language-plaintext highlighter-rouge">Wander</code>). While doing so it continues scanning its surroundings, and if it finds an enemy, it switches to the attack profile.</p>

<p>But it gets more complicated. Enemies created via a <code class="language-plaintext highlighter-rouge">PopulationObject</code> contain an <code class="language-plaintext highlighter-rouge">EntitySelector</code>, which has another AI override called <code class="language-plaintext highlighter-rouge">DefaultBrainOnSimulated</code> that uses <code class="language-plaintext highlighter-rouge">ProceduralProfileSenseOnly</code></p>

<p>The basic idea of this profile is that instead of wandering or attacking, it simply plays an idle animation (such as NPCs talking to each other), and when a player enters its scanning radius, it switches to one of the talking profiles. Generally it picks a random profile from the <code class="language-plaintext highlighter-rouge">AIOverrides</code> list:</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2024-07/ai-1.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-07/ai-1.png" alt="AI 1" style="max-height: 400px;" /></a>
</center>

<p>All of these switches are controlled by the <code class="language-plaintext highlighter-rouge">ProcessEntityAction()</code> function.</p>

<p>So when you see an NPC talking or calling you, this happens via complex AI profile switching.</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2024-07/ai-2.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-07/ai-2.jpg" alt="AI 2" style="max-height: 400px;" /></a>
</center>

<p>This is how previously silent NPCs learned how to speak.</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-07/ai-3.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-07/ai-3.jpg" alt="AI 3" /></a></p>

<p>As for combat, Crypto did a lot of work here by implementing the power system. I assisted with implementing <code class="language-plaintext highlighter-rouge">MissilePower</code>, since it involves AI, and I am quite familiar with this topic.</p>

<p>This game has so many AI profiles, and it is hard to see them at first glance. For example, drops lying on the ground, such as orbs, are not pulled by some kind of magnetic force. Instead, they all have follow target AI profiles, with your avatar being that target. Every moving entity in the game is “alive”. This includes projectiles, such as Captain America’s shield, Thor’s hammer, or Iron Man’s micro-missiles - all of them are moved using AI profiles. But it gets more interesting!</p>

<p>You may remember bosses or other powerful enemies picking objects up and throwing them at you. You think this is because the boss’s AI is so smart? Wrong answer! Actually, throwable objects themselves have brains!</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-07/ai-4.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-07/ai-4.jpg" alt="AI 4" /></a></p>

<p>Yes, I am not joking, every single one of Mr. Hyde’s barrels has its own brain!</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2024-07/ai-5.png"><img src="/MHServerEmu/assets/blog/progress-report/2024-07/ai-5.png" alt="AI 5" style="max-height: 400px;" /></a>
</center>

<p>Every 10 seconds the barrel, just like Emma Frost, attempts to take control of its owner, Mr. Hyde, and override his AI behavior profile. And the boss takes orders from this barrel, picks it up, and throws it at the avatar. Entities that act like this have their own class - <code class="language-plaintext highlighter-rouge">ThrowableSmartProp</code>.</p>

<p>There are not too many of them in the game, and they still do not function completely right, but now you know that when the Hulk boss in Holo-Sim picks up a car, he was forced to do so by the car itself!</p>

<p>Overriding AI profiles is a complicated process, and I am still working on it. For instance, timing the activation of the appropriate AI profile when an entity enters the world and/or starts being simulated still has a lot issues, which is why some of the idle animations got replaced with wandering. In the future we will come back and fix these issues. For now I am working on missions, which also involves some AI overriding and idle animation playaback via <code class="language-plaintext highlighter-rouge">MissionActionEntityPerformPower()</code>, but this is a story for another report. That’s it for now, have fun playing, and until the next report!</p>

<hr />

<p>Back to work now. See you in August!</p>]]></content><author><name></name></author><category term="blog" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">MHServerEmu Progress Report: June 2024</title><link href="https://crypto137.github.io/MHServerEmu/blog/2024/06/30/progress-report-june-2024.html" rel="alternate" type="text/html" title="MHServerEmu Progress Report: June 2024" /><published>2024-06-30T04:20:00+03:00</published><updated>2024-06-30T04:20:00+03:00</updated><id>https://crypto137.github.io/MHServerEmu/blog/2024/06/30/progress-report-june-2024</id><content type="html" xml:base="https://crypto137.github.io/MHServerEmu/blog/2024/06/30/progress-report-june-2024.html"><![CDATA[<!--more-->

<p><img src="/MHServerEmu/assets/blog/progress-report/2024-06/header.jpg" alt="MHServerEmu Progress Report - June 2024" /></p>

<p>June has been jam-packed full of developments, and we have a lot to cover.</p>

<h2 id="mhserveremu-2-electric-boogaloo">MHServerEmu 2: Electric Boogaloo</h2>

<p>This month we released the second stable release of MHServerEmu - <a href="https://github.com/Crypto137/MHServerEmu/releases/tag/0.2.0">version 0.2.0</a>. This release contains all the backend work we had been working on since <a href="/MHServerEmu/blog/2024/03/31/progress-report-march-2024.html">March</a>, including, but not limited to:</p>

<ul>
  <li>
    <p>General server architecture improvements.</p>
  </li>
  <li>
    <p>An overhaul of the serialization system.</p>
  </li>
  <li>
    <p>An implementation of navi, locomotion, and physics systems.</p>
  </li>
  <li>
    <p>An overhaul of the entity management system.</p>
  </li>
  <li>
    <p>An implementation of the inventory system.</p>
  </li>
  <li>
    <p>An implementation of the game event system.</p>
  </li>
  <li>
    <p>A significantly upgraded version of the area of interest system.</p>
  </li>
  <li>
    <p>Most of the backend for the AI system.</p>
  </li>
</ul>

<p>We have barely scratched the surface of what is now possible. One significant improvement that happened almost as a side effect of all of this is that now you can see and interact with other players in the game world.</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-06/multiplayer.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-06/multiplayer.jpg" alt="Multiplayer" /></a></p>

<p>And in just a few days we were able to build a very rough early iteration of the loot system (<em>disclaimer: quantity exaggerated for dramatic purposes, may not match what you see in the final product</em>):</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-06/loot.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-06/loot.jpg" alt="Loot" /></a></p>

<p>As soon as 0.2.0 was out, we started work on version 0.3.0. Our current tentative target for its release is September 2024, but you can check out all the latest features we are working on early via <a href="https://nightly.link/Crypto137/MHServerEmu/workflows/nightly-release-windows-x64/master?preview">nightly builds</a> or by building the source code yourself. Now that a significant bulk of the backend work is out of the way, we can focus more on aspects you can actually see in the game. One good example of this you can check out yourself right now in nightly 0.3.0 builds is an early iteration of pets and team-ups that rely on navi, locomotion and AI systems for pathfinding, physically moving around, and being aware that they need to follow their owner respectively.</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-06/pets.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-06/pets.jpg" alt="Pets" /></a></p>

<h2 id="i-am-running-out-of-interesting-puns">I Am Running Out of Interesting Puns</h2>

<p>This month our implementation of the area of interest (AOI) system received a major upgrade, which literally made visible the results of our work on other systems. Now that it is mostly working, we can dive deeper into the specifics.</p>

<p>First, a quick recap. Marvel Heroes is a server-authoritative game, meaning the entire game simulation (where everything is, what powers everyone is using, how much health everyone has, and so on) runs on the server. The server is the ultimate dungeon master, aware of everything happening to everyone. The client program you are using to play the game also has a simulation of its own that runs in parallel based on the data it receives from the server. However, the data clients receive is just a small slice of the overall server pie, and each client’s slice if referred to as its area of interest.</p>

<p>Putting it into more concrete terms, the <code class="language-plaintext highlighter-rouge">AreaOfInterest</code> class in the server code determines what data needs to go to the client it is bound to and keeps track of things the client is already aware of. The data managed by AOI can be separated into two categories: environment (a region with its areas and cells) and entities (game objects that populate the region).</p>

<p>Everything starts with entities. When a client logs into a game server, a <code class="language-plaintext highlighter-rouge">Player</code> entity is created for it that gets bound to an <code class="language-plaintext highlighter-rouge">AreaOfInterest</code> instance. This entity does not physically exist in the game world and is used to represent the player’s account: what heroes are unlocked, how much of each currency there is, when was the last time this player logged in, and so on. Hero and team-up unlocks are internally represented as “items” held in various hidden inventories, such as <code class="language-plaintext highlighter-rouge">PlayerAvatarLibrary</code> and <code class="language-plaintext highlighter-rouge">PlayerTeamUpLibrary</code> (see <a href="/MHServerEmu/blog/2024/05/31/progress-report-may-2024.html">the previous report</a> for more on that).</p>

<p>This player entity is automatically <em>considered</em> by the area of interest it is bound to. Consideration is a process of determining what (if any) <em>interest policies</em> (also referred to as <em>replication channels</em>) a specific entity has in relation to an area of interest. If an area of interest determines that an entity matches one or more interest policies, it starts tracking the entity and notifies the client by sending network messages containing information about this entity. The client uses this information to create a copy of this entity in its local simulation. When an entity loses all of its replication policies, it is removed from the AOI and the client simulation. In addition to player entity creation, consideration can be triggered by other events, such moving around the game world, but more on that later.</p>

<p>In total there are five possible replication policies: <code class="language-plaintext highlighter-rouge">Owner</code>, <code class="language-plaintext highlighter-rouge">Proximity</code>, <code class="language-plaintext highlighter-rouge">Discovery</code>, <code class="language-plaintext highlighter-rouge">Party</code>, and <code class="language-plaintext highlighter-rouge">Trader</code>. When the player entity is considered by its AOI, it always enters it with the <code class="language-plaintext highlighter-rouge">Owner</code> policy. Then, the AOI recursively considers all entities stored in the player’s various inventories, which is how avatars and team-ups owned by the player with all of their equipment enter the AOI. Entities that enter the AOI by being present in the player entity’s inventories also have the <code class="language-plaintext highlighter-rouge">Owner</code> interest policy.</p>

<p>With this initialization step done, the server proceeds to put one of the player’s avatars at a specific <code class="language-plaintext highlighter-rouge">RegionLocation</code>, which includes a region instance id, coordinates within this region instance, and the initial orientation of the avatar. The AOI scans the environment within a certain radius around this location to determine what cells the client needs to load. The server then sends a message packet that instructs the client to put up a loading screen and load all determined cells. For every loaded cell the client sends a notification message to the server. The server tracks these notifications, and when all requested cells are loaded, it instructs the client to remove the loading screen, and player’s selected avatar enters the world at the required region location.</p>

<p>When the avatar enters world, it and everything within a certain radius is considered for a <code class="language-plaintext highlighter-rouge">Proximity</code> policy. Some entities do not get the <code class="language-plaintext highlighter-rouge">Proximity</code> policy despite being physically near the player’s avatar in the game world. One good example of this is loot, which is restricted to the player it dropped for until it is picked up. As the player’s avatar moves around the game world, the AOI periodically scans the proximity to determine cells and entities that need to be added or removed.</p>

<p>Here is what it looks like if we artificially reduce the proximity radius:</p>

<div><video controls="" width="100%" /><source src="/MHServerEmu/assets/blog/progress-report/2024-06/proximity.webm" type="video/webm" /></div>

<p>When entities in proximity are considered, the contents of their inventories are considered in a similar fashion to the player, and there is a set of conditions that determines when an entity stored in an inventory can enter an area of interest. This is what ultimately allows you to see items equipped on nearby players, such as their costumes and artifacts with fancy visual effects, while avoiding the necessity of loading items stored in their stashes like a certain other game.</p>

<p>In some cases when an entity enters proximity and/or satisfies some other condition, it also gains a <code class="language-plaintext highlighter-rouge">Discovery</code> policy, which allows it to remain in the client’s simulation even after it leaves proximity. For example, this is how the client can draw map icons for NPCs and waypoints even when they are no longer in proximity.</p>

<p>There are two special cases that have their own replication policies: <code class="language-plaintext highlighter-rouge">Party</code> and <code class="language-plaintext highlighter-rouge">Trade</code>. What makes them different from the other three is that they are the only cases when player entities belonging to other clients can enter your area of interest. We are still investigating the specifics of them, and we will talk more about this in a future report when we get to work on various social features.</p>

<p>Interest policies play an important role in the serialization process. For example, world entity power collections are omitted unless they have the <code class="language-plaintext highlighter-rouge">Proximity</code> policy, and some properties are added or removed based on changing policies. The latter one was the cause of one of the issues we had to solve when implementing team-up spawning. For some reason, the client failed to recognize team-ups as belonging to the current avatar and did not display a green circle indicator under them that should look like this:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-06/teamup.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-06/teamup.jpg" alt="Team-Up" /></a></p>

<p>As it turned out, the issue was that the property that the client uses to determine this ownership relation, <code class="language-plaintext highlighter-rouge">PowerUserOverrideID</code>, is compatible only with <code class="language-plaintext highlighter-rouge">Proximity</code> and <code class="language-plaintext highlighter-rouge">Trader</code> policies, and it is filtered out in other cases. Because team-ups are initially added to the AOI and serialized to the client with just the <code class="language-plaintext highlighter-rouge">Owner</code> policy during initial loading, this property was not included. The solution was to implement handling for the interest policy change event on the server to automatically send newly revealed properties to the client when existing entities in its AOI gain new interest policies.</p>

<p>While there is still some work to do on this system, at this stage it is already capable of performing its most essential operations that allows it to act as a window to what is happening on the server for the client.</p>

<h2 id="time-is-of-the-essence">Time is of the Essence</h2>

<p>Another important area where we have recently had significant advancements is game simulation timing and event scheduling. We first started seriously considering this <a href="/MHServerEmu/blog/2024/04/30/progress-report-april-2024.html">back in April</a>, and are now at a point where we are approaching client-accuracy.</p>

<p>As we were researching this, we discovered an intricate system of numerous clocks that would fit right in at Dr. Emmett Brown’s lab.</p>

<style>.embed-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; } .embed-container iframe, .embed-container object, .embed-container embed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }</style>
<div class="embed-container">    <iframe title="YouTube video player" width="640" height="390" src="//www.youtube.com/embed/3isQI0nXQRE" frameborder="0" allowfullscreen=""></iframe></div>

<p>In total there are five clocks that are actively used, and we had to add a sixth one to the mix for compatibility with .NET.</p>

<ul>
  <li>
    <p><strong>.NET DateTime</strong> - a point in time from <code class="language-plaintext highlighter-rouge">January 1, 1</code> to <code class="language-plaintext highlighter-rouge">December 31, 9999</code>. This is the default date time format used by C# that you get from <code class="language-plaintext highlighter-rouge">DateTime.Now</code> and <code class="language-plaintext highlighter-rouge">DateTime.UtcNow</code>.</p>
  </li>
  <li>
    <p><strong>DateTime</strong> - the number of microseconds since <code class="language-plaintext highlighter-rouge">January 1, 1970</code>. Also known as Unix time.</p>
  </li>
  <li>
    <p><strong>CoreGameTime</strong> - the number of microseconds since <code class="language-plaintext highlighter-rouge">September 22, 2012 09:31:18 GMT+0000</code>. This epoch is not arbitrary: the game’s closed beta began on <code class="language-plaintext highlighter-rouge">October 1, 2012</code>, and this point in time must have been when the development team was making final preparations. In a way, this is the game’s true birthday.</p>
  </li>
  <li>
    <p><strong>RealGameTime</strong> - the number of microseconds in full fixed time frames since <code class="language-plaintext highlighter-rouge">September 22, 2012</code>. More on that later.</p>
  </li>
  <li>
    <p><strong>Game.CurrentTime</strong> - the current time step of the game simulation.</p>
  </li>
  <li>
    <p><strong>GameEventScheduler.CurrentTime</strong> - the current game simulation time adjusted for the currently executing scheduled event. This is the clock used by most of the gameplay logic. If <code class="language-plaintext highlighter-rouge">GameEventScheduler</code> is not available, it falls back to <code class="language-plaintext highlighter-rouge">Game.CurrentTime</code>.</p>
  </li>
</ul>

<p>Let’s unwrap what is happening here step by step.</p>

<p>During server initialization we query system time with <code class="language-plaintext highlighter-rouge">DateTime.UtcNow</code> to get a timestamp of the initialization time. For performance and accuracy reasons, rather than querying system time each time the game wants to know what time it is, we create and start a <code class="language-plaintext highlighter-rouge">Stopwatch</code> class instance when we query the initialization timestamp. When time is requested, we add elapsed time from the stopwatch to our timestamp and convert it to <code class="language-plaintext highlighter-rouge">DateTime</code> or <code class="language-plaintext highlighter-rouge">CoreGameTime</code>. With that we have half of our required clocks taken care of.</p>

<p><code class="language-plaintext highlighter-rouge">RealGameTime</code> is represented using a class called <code class="language-plaintext highlighter-rouge">FixedQuantumGameTime</code>. Behind this sci-fi sounding name we have basically a less accurate version of <code class="language-plaintext highlighter-rouge">CoreGameTime</code> that advances in fixed intervals, which in our case are 50 ms.</p>

<p>When the game does the <code class="language-plaintext highlighter-rouge">UpdateFixedTime()</code> stage of the update loop, which handles time-sensitive processing such as physics and timers, it synchronizes the value of <code class="language-plaintext highlighter-rouge">RealGameTime</code> by calling the <code class="language-plaintext highlighter-rouge">FixedQuantumGameTime.UpdateToNow()</code> method that does something along these lines:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Get current CoreGameTime and time step length.</span>
<span class="n">TimeSpan</span> <span class="n">gameTime</span> <span class="p">=</span> <span class="n">Clock</span><span class="p">.</span><span class="n">GameTime</span><span class="p">;</span>
<span class="n">TimeSpan</span> <span class="n">quantumSize</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromMilliseconds</span><span class="p">(</span><span class="m">50</span><span class="p">);</span>

<span class="c1">// Calculate the total number of steps.</span>
<span class="c1">// Because Ticks are integers, we lose the remainder</span>
<span class="c1">// of the division and get a nice round number.</span>
<span class="kt">long</span> <span class="n">numTimeQuantums</span> <span class="p">=</span> <span class="n">gameTime</span><span class="p">.</span><span class="n">Ticks</span> <span class="p">/</span> <span class="n">quantumSize</span><span class="p">.</span><span class="n">Ticks</span><span class="p">;</span>

<span class="c1">// Get a new TimeSpan representing the number of full steps.</span>
<span class="n">TimeSpan</span> <span class="n">realGameTime</span> <span class="p">=</span> <span class="n">quantumSize</span> <span class="p">*</span> <span class="n">numTimeQuantums</span>
</code></pre></div></div>

<p>The game then advances its <code class="language-plaintext highlighter-rouge">CurrentTime</code> in 50 ms intervals until it catches up to <code class="language-plaintext highlighter-rouge">RealGameTime</code>. For every time its clock advances, the game calls <code class="language-plaintext highlighter-rouge">DoFixedTimeUpdate()</code> once. When everything is going smoothly and there are no time-consuming tasks running, like region generation, an <code class="language-plaintext highlighter-rouge">UpdateFixedTime()</code> call should do only a single <code class="language-plaintext highlighter-rouge">DoFixedTimeUpdate()</code>. To keep the simulation from being stuck in an endless loop in situations where it for some reason cannot keep up, there is an additional check that breaks the loop when it exceeds the expected frame time of 50 ms.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// _gameTimer is a Stopwatch instance that starts with the game.</span>
<span class="n">TimeSpan</span> <span class="n">updateStartTime</span> <span class="p">=</span> <span class="n">_gameTimer</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="n">_currentGameTime</span> <span class="p">+</span> <span class="n">FixedTimeBetweenUpdates</span> <span class="p">&lt;=</span> <span class="n">RealGameTime</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_currentGameTime</span> <span class="p">+=</span> <span class="n">FixedTimeBetweenUpdates</span><span class="p">;</span>

    <span class="nf">DoFixedTimeUpdate</span><span class="p">();</span>

    <span class="c1">// Bail out if we have exceeded the frame budget</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_gameTimer</span><span class="p">.</span><span class="n">Elapsed</span> <span class="p">-</span> <span class="n">updateStartTime</span> <span class="p">&gt;</span> <span class="n">FixedTimeBetweenUpdates</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Everything up until this point has been relatively straightforward, but now the real time shenanigans begin. During <code class="language-plaintext highlighter-rouge">DoFixedTimeUpdate()</code> the reins are partially handed over to the <code class="language-plaintext highlighter-rouge">GameEventScheduler</code>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">DoFixedTimeUpdate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Current simulation time is passed as an argument</span>
    <span class="n">GameEventScheduler</span><span class="p">.</span><span class="nf">TriggerEvents</span><span class="p">(</span><span class="n">_currentGameTime</span><span class="p">);</span>
    <span class="c1">// Everything else</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In fact, <code class="language-plaintext highlighter-rouge">GameEventScheduler</code>’s clock has priority over the game’s when current time is requested by various systems:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">TimeSpan</span> <span class="n">CurrentTime</span> <span class="p">{</span> <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">GameEventScheduler</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">?</span> <span class="n">GameEventScheduler</span><span class="p">.</span><span class="n">CurrentTime</span> <span class="p">:</span> <span class="n">_currentGameTime</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<p>So what does <code class="language-plaintext highlighter-rouge">EventScheduler</code> do? Essentially, it allows the game to set up timers and trigger actions when they expire. You provide it with with a <code class="language-plaintext highlighter-rouge">TimeSpan</code> representing a delay before something should happen and an object representing the callback that needs to be executed, and it does everything else.</p>

<p>Believe it or not, this system appears to be an evolution of a similar system from <em>Diablo II</em>. Take a look at this code snippet from the <a href="https://github.com/ThePhrozenKeep/D2MOO">D2MOO</a> decompilation project:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AI think delay setup</span>
<span class="kt">int32_t</span> <span class="n">nAiDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">pGame</span><span class="o">-&gt;</span><span class="n">nGameType</span> <span class="o">||</span> <span class="n">pGame</span><span class="o">-&gt;</span><span class="n">dwGameType</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Get delay for the current difficulty from MonStats.txt</span>
    <span class="n">nAiDelay</span> <span class="o">=</span> <span class="n">pMonStatsTxtRecord</span><span class="o">-&gt;</span><span class="n">nAIdel</span><span class="p">[</span><span class="n">pGame</span><span class="o">-&gt;</span><span class="n">nDifficulty</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="c1">// Fall back to normal difficulty</span>
    <span class="n">nAiDelay</span> <span class="o">=</span> <span class="n">pMonStatsTxtRecord</span><span class="o">-&gt;</span><span class="n">nAIdel</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// Fall back to the default delay value</span>
<span class="k">if</span> <span class="p">(</span><span class="n">nAiDelay</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">nAiDelay</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Schedule the next think event</span>
<span class="n">EVENT_SetEvent</span><span class="p">(</span><span class="n">pGame</span><span class="p">,</span> <span class="n">pModeChange</span><span class="o">-&gt;</span><span class="n">pUnit</span><span class="p">,</span> <span class="n">UNITEVENTCALLBACK_AITHINK</span><span class="p">,</span> <span class="n">nAiDelay</span> <span class="o">+</span> <span class="n">pGame</span><span class="o">-&gt;</span><span class="n">dwGameFrame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>

<p>Diablo II’s timing is completely frame-based with the game running at a constant framerate of 25 Hz. The code in this example retrieves the monster AI think delay value from a data file (<code class="language-plaintext highlighter-rouge">MonStats.txt</code>) and schedules a think event. At 25 FPS each frame is going to take <code class="language-plaintext highlighter-rouge">1000 / 25 = 40 ms</code>, meaning this delay will take <code class="language-plaintext highlighter-rouge">15 * 40 = 600 ms</code>. At Nightmare and Hell difficulty modes this delay is <code class="language-plaintext highlighter-rouge">14 * 40 = 560 ms</code> and <code class="language-plaintext highlighter-rouge">13 * 40 = 520 ms</code> respectively.</p>

<p>And here is reverse engineered code that does the equivalent in Marvel Heroes:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">Think</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kt">float</span> <span class="n">thinkTime</span> <span class="p">=</span> <span class="m">500</span><span class="p">;</span> <span class="c1">// slow think </span>
    <span class="k">if</span> <span class="p">(</span><span class="n">TargetEntity</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">||</span> <span class="n">AssistedEntity</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="n">thinkTime</span> <span class="p">=</span> <span class="m">100</span><span class="p">;</span> <span class="c1">// fast think</span>
    <span class="nf">ScheduleAIThinkEvent</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromMilliseconds</span><span class="p">(</span><span class="n">thinkTime</span><span class="p">)</span> <span class="p">*</span> <span class="n">Game</span><span class="p">.</span><span class="n">Random</span><span class="p">.</span><span class="nf">NextFloat</span><span class="p">(</span><span class="m">0.9f</span><span class="p">,</span> <span class="m">1.1f</span><span class="p">));</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">ScheduleAIThinkEvent</span><span class="p">(</span><span class="n">TimeSpan</span> <span class="n">timeOffset</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Various checks and additional variation</span>
    <span class="c1">// for the offset happening here are omitted.</span>

    <span class="n">eventScheduler</span><span class="p">.</span><span class="nf">ScheduleEvent</span><span class="p">(</span><span class="n">_thinkEvent</span><span class="p">,</span> <span class="n">nextThinkTimeOffset</span><span class="p">,</span> <span class="n">_pendingEvents</span><span class="p">);</span>
    <span class="n">_thinkEvent</span><span class="p">.</span><span class="nf">Get</span><span class="p">().</span><span class="n">OwnerController</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Diablo II’s units are now called entities, Excel .txt files became prototypes, and instead of the number of frames we provide a <code class="language-plaintext highlighter-rouge">TimeSpan</code> as an argument for scheduling an event. The “slow thinking mode” is pretty much equivalent to the thinking rate from Diablo II. And this is not where similarities end: internally, <code class="language-plaintext highlighter-rouge">EventScheduler</code> still operates based on frames, just like Diablo II.</p>

<p>All scheduled events are grouped by “buckets”, with each bucket representing a frame. When an event is scheduled, it is put into a bucket based on the current time and requested delay, and its precise fire time is recorded.</p>

<p>When the <code class="language-plaintext highlighter-rouge">TriggerEvents()</code> method is called from <code class="language-plaintext highlighter-rouge">DoFixedTimeUpdate()</code>, the event scheduler advances its clock in fixed time steps until it catches up to the <code class="language-plaintext highlighter-rouge">_currentGameTime</code> that was passed as an argument, and each time it advances it executes all events in the bucket corresponding to the frame. Here is what a simplified version of this code looks like:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Determine time window</span>
<span class="kt">long</span> <span class="n">startFrame</span> <span class="p">=</span> <span class="n">CurrentTime</span><span class="p">.</span><span class="nf">CalcNumTimeQuantums</span><span class="p">(</span><span class="n">_quantumSize</span><span class="p">);</span>
<span class="kt">long</span> <span class="n">endFrame</span> <span class="p">=</span> <span class="n">updateEndTime</span><span class="p">.</span><span class="nf">CalcNumTimeQuantums</span><span class="p">(</span><span class="n">_quantumSize</span><span class="p">);</span>

<span class="c1">// Process all frames that are within our time window</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">long</span> <span class="n">i</span> <span class="p">=</span> <span class="n">startFrame</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;=</span> <span class="n">endFrame</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
<span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="n">ScheduledEvent</span> <span class="n">@event</span> <span class="k">in</span> <span class="n">_buckets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="c1">// Set event scheduler's time to the precise event fire time</span>
        <span class="n">CurrentTime</span> <span class="p">=</span> <span class="n">@event</span><span class="p">.</span><span class="n">FireTime</span><span class="p">;</span>

        <span class="c1">// Invalidate event</span>
        <span class="n">_scheduledEvents</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">@event</span><span class="p">);</span>
        <span class="n">@event</span><span class="p">.</span><span class="n">EventGroupNode</span><span class="p">?.</span><span class="nf">Remove</span><span class="p">();</span>
        <span class="n">@event</span><span class="p">.</span><span class="nf">InvalidatePointers</span><span class="p">();</span>

        <span class="c1">// Run event callback</span>
        <span class="n">@event</span><span class="p">.</span><span class="nf">OnTriggered</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Synchronize time with the game</span>
<span class="n">CurrentTime</span> <span class="p">=</span> <span class="n">currentGameTime</span><span class="p">;</span>
</code></pre></div></div>

<p>Before the event scheduler triggers an event, it sets its clock to the precise time when the event is supposed to be fired. And because <code class="language-plaintext highlighter-rouge">Game.CurrentTime</code> returns the value of <code class="language-plaintext highlighter-rouge">GameEventScheduler.CurrentTime</code>, any game logic that runs as a result of the event callback is going to have precise time despite the simulation advancing in 50 ms steps.</p>

<p>But here is the crazy thing: as far as I can tell, events within their frame buckets are not sorted by fire time. Therefore, it is possible for the time to go <em>backwards</em>, although only within the confines of a single frame. Which in a way makes sense: events happening within the same frame are batched together and happen “simultaneously”, so the execution order here is not critical. The main potential problem would be inconsistent timing due to an event callback potentially scheduling another event, but because time is always set to the precise fire time, it’s going to remain consistent.</p>

<p>RIght now we have most of this system working, with the exception of the bucket management system. As a temporary solution we are storing all events in a single collection that we iterate to determine the events that would go in the bucket we would be processing, which is not ideal for performance, but it does the job well enough for now. The API for the system is pretty much done, and we can worry about optimizing internal implementation later.</p>

<p>And this is how time in Marvel Heroes works.</p>

<h2 id="finding-a-path-forward">Finding a Path Forward</h2>

<p><em>AlexBond is back again this month to talk about his work on pathfinding and AI.</em></p>

<hr />

<p>Hello, it’s AlexBond again. In this report I would like to talk about how AI works and the <code class="language-plaintext highlighter-rouge">NaviPath</code> generation process.</p>

<h3 id="aicontroller">AIController</h3>

<p>For an agent’s AI to work, the agent needs to enter the simulation using <code class="language-plaintext highlighter-rouge">SetSimulated()</code>, and its AI controller needs to be activated. (<em>Editor’s note: “agent” is the term the game uses to refer to world entities that can interact with the game world, such as avatars, enemies, team-ups, and so on</em>).</p>

<p>AI controller activation happens when an agent enters the game world, in the <code class="language-plaintext highlighter-rouge">OnEnteredWorld()</code> function: if the agent has a defined <code class="language-plaintext highlighter-rouge">BehaviorProfile</code>, an <code class="language-plaintext highlighter-rouge">AIController</code> instance is created. <code class="language-plaintext highlighter-rouge">AIController</code> consists of three main parts:</p>

<ul>
  <li>
    <p><strong>Brain</strong> - a behavior profile for the <code class="language-plaintext highlighter-rouge">ProceduralAI</code> system.</p>
  </li>
  <li>
    <p><strong>Senses</strong> - a class for determining potential allies and enemies that scans everyone every second in the defined <code class="language-plaintext highlighter-rouge">AggroRange</code>.</p>
  </li>
  <li>
    <p><strong>Blackboard</strong> - AI’s memory where temporary state is stored in the form of a <code class="language-plaintext highlighter-rouge">PropertyCollection</code>, as well as various vectors.</p>
  </li>
</ul>

<p>The main function of a controller is <code class="language-plaintext highlighter-rouge">Think()</code>. To keep server load in check, this function runs via a scheduled event every 90-110 ms in the “fast” thinking mode and every 450-500 ms in the “slow” thinking mode. When it runs, it activates the <code class="language-plaintext highlighter-rouge">Brain</code> and runs commands defined in the AI profile. AI profiles include some state logic and defines behavior templates for each state.</p>

<p>Let’s take a look at a concrete example - the think function for <code class="language-plaintext highlighter-rouge">ProceduralProfileVanityPetPrototype</code>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Think</span><span class="p">(</span><span class="n">AIController</span> <span class="n">ownerController</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Guard checks omitted</span>
    <span class="n">ProceduralAI</span> <span class="n">proceduralAI</span> <span class="p">=</span> <span class="n">ownerController</span><span class="p">.</span><span class="n">Brain</span><span class="p">;</span>
    <span class="n">Agent</span> <span class="n">agent</span> <span class="p">=</span> <span class="n">ownerController</span><span class="p">.</span><span class="n">Agent</span><span class="p">;</span>
    <span class="n">WorldEntity</span> <span class="n">master</span> <span class="p">=</span> <span class="n">ownerController</span><span class="p">.</span><span class="n">AssistedEntity</span><span class="p">;</span>
    <span class="n">Game</span> <span class="n">game</span> <span class="p">=</span> <span class="n">agent</span><span class="p">.</span><span class="n">Game</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">master</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">master</span><span class="p">.</span><span class="n">IsInWorld</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">float</span> <span class="n">distanceToMasterSq</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="nf">DistanceSquared2D</span><span class="p">(</span><span class="n">agent</span><span class="p">.</span><span class="n">RegionLocation</span><span class="p">.</span><span class="n">Position</span><span class="p">,</span> <span class="n">master</span><span class="p">.</span><span class="n">RegionLocation</span><span class="p">.</span><span class="n">Position</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">distanceToMasterSq</span> <span class="p">&gt;</span> <span class="n">MaxDistToMasterBeforeTeleportSq</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Teleport to master</span>
            <span class="nf">HandleContext</span><span class="p">(</span><span class="n">proceduralAI</span><span class="p">,</span> <span class="n">ownerController</span><span class="p">,</span> <span class="n">TeleportToMasterIfTooFarAway</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Move normally</span>
    <span class="nf">HandleMovementContext</span><span class="p">(</span><span class="n">proceduralAI</span><span class="p">,</span> <span class="n">ownerController</span><span class="p">,</span> <span class="n">agent</span><span class="p">.</span><span class="n">Locomotor</span><span class="p">,</span> <span class="n">PetFollow</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>First, the pet determines its <em>master</em> (<code class="language-plaintext highlighter-rouge">AssistedEntity</code>) and the distance between them. If this distance exceeds the defined value, the pet teleports using <code class="language-plaintext highlighter-rouge">HandleContext()</code>. Then movement is initiated using <code class="language-plaintext highlighter-rouge">HandleMovementContext()</code>.</p>

<p><code class="language-plaintext highlighter-rouge">HandleMovementContext()</code> sets the state to <code class="language-plaintext highlighter-rouge">MoveTo</code>, which consists of four stages:</p>

<ul>
  <li>
    <p>Validate</p>
  </li>
  <li>
    <p>Start</p>
  </li>
  <li>
    <p>Update</p>
  </li>
  <li>
    <p>End</p>
  </li>
</ul>

<p>The agent then receives a command based on the settings defined in the <code class="language-plaintext highlighter-rouge">ContextPrototype</code>. In our vanity pet example this command is simply generating a path to <code class="language-plaintext highlighter-rouge">AssistedEntity</code>.</p>

<h3 id="generatepath">GeneratePath</h3>

<p>Path generation begins inside the <code class="language-plaintext highlighter-rouge">Locomotor</code> class. First, it disables <em>influence points</em> for <em>owner</em> (the pet) and <em>other</em> (the avatar) by calling the <code class="language-plaintext highlighter-rouge">DisableNavigationInfluence()</code> method. It then proceeds to the generation process itself - <code class="language-plaintext highlighter-rouge">GeneratePathInternal()</code>.</p>

<p>This process consists of three main steps:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">GeneratePathStep()</code> - we scan all <code class="language-plaintext highlighter-rouge">NaviTriangle</code> instances near the <em>startTriangle</em> until we find our destination - <em>goalTriangle</em>. All steps are recorded in <em>genPathState</em>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">FunnelStep()</code> - a hard to understand algorithm, the goal of which is to remove unnecessary <code class="language-plaintext highlighter-rouge">NaviPoint</code> instances and determine <code class="language-plaintext highlighter-rouge">NaviSide</code> - the side to steer to avoid collision with an object (either left or right). The radius of the node to steer around is determined by summing the radiuses of the owner (the pet) and the <em>influenceRadius</em> - the radius of the object bound to the <code class="language-plaintext highlighter-rouge">NaviPoint</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">CalcAccurateDistance()</code> - now that we have a path, we calculate its actual length taking into account all necessary steering and picking the shortest sides.</p>
  </li>
</ul>

<p>To illustrate this process, I have prepared two examples of path generation:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-06/pathfinding-example-1.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-06/pathfinding-example-1.jpg" alt="Pathfinding Example 1" /></a></p>

<p>As you an see, there are two entities between the pet and the avatar: S.T.A.S.H. and Maria Hill.</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2024-06/pathfinding-animation-1.gif"><img src="/MHServerEmu/assets/blog/progress-report/2024-06/pathfinding-animation-1.gif" alt="Pathfinding Animation 1" style="max-height: 400px;" /></a>
</center>

<p>Now let’s take a look at a more involved example:</p>

<p><a href="/MHServerEmu/assets/blog/progress-report/2024-06/pathfinding-example-2.jpg"><img src="/MHServerEmu/assets/blog/progress-report/2024-06/pathfinding-example-2.jpg" alt="Pathfinding Example 2" /></a></p>

<p>In this case we have obstacles in the form of walls. The radiuses of nodes to steer around will be equal to the pet’s. Three paths are generated, and the shortest one is picked.</p>

<center>
<a href="/MHServerEmu/assets/blog/progress-report/2024-06/pathfinding-animation-2.gif"><img src="/MHServerEmu/assets/blog/progress-report/2024-06/pathfinding-animation-2.gif" alt="Pathfinding Animation 2" style="max-height: 400px;" /></a>
</center>

<p>Finding and fixing bugs in implementations of these algorithms took me a week. I even had to implement SVG export for the navi system to visualize what was happening. In the end, all issues were solved, and now we have pets and team-ups working in the server emulator.</p>

<p>As you run around with them, keep in mind that every 200 ms they perform complex calculations to find their path to you. In addition to that, <code class="language-plaintext highlighter-rouge">Locomotor</code> has a <em>repath</em> feature that checks and potentially rebuilds the path every 250 ms in case new objects appear in the way.</p>

<p>Now you should have a better understanding of how AI works. Although team-ups currently do not attack, they scan for targets every second, and when we enable these targets, combat will begin!</p>

<hr />

<p>It is time for us to get back to coding. We hope you all are going to join us again in July for a special one year anniversary report!</p>]]></content><author><name></name></author><category term="blog" /><summary type="html"><![CDATA[]]></summary></entry></feed>